<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocNest - Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
    :root {
      /* Dark Theme (Enhanced) */
      --bg-primary: #111827;
      --bg-card: #1f2937;
      --bg-card-hover: #374151;
      --bg-input: #374151;
      --bg-input-readonly: #4b5563;
      --bg-button-primary: #3b82f6;
      --bg-button-primary-hover: #2563eb;
      --bg-button-destructive: #ef4444;
      --bg-button-destructive-hover: #dc2626;
      --bg-button-secondary: #4b5563;
      --bg-button-secondary-hover: #6b7280;
      --bg-action-icon-hover: #4b5563;
      --bg-inline-form: #1f2937;
      --bg-modal-overlay: rgba(0, 0, 0, 0.75);
      --bg-modal-content: #1f2937;
      --bg-toast-success: #10b981;
      --bg-toast-error: #f43f5e;
      --bg-dropdown-menu: var(--bg-card);
      --bg-breadcrumb: #1f2937;
      --bg-breadcrumb-hover: #374151;

      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --text-tertiary: #6b7280;
      --text-placeholder: #9ca3af;
      --text-button-primary: #ffffff;
      --text-button-destructive: #ffffff;
      --text-button-secondary: #f3f4f6;
      --text-card-header: #e5e7eb;
      --text-link: #60a5fa;
      --text-link-hover: #93c5fd;
      --text-action-icon: #9ca3af;
      --text-action-icon-hover: #e5e7eb;
      --text-green-accent: #34d399;
      --text-red-accent: #f87171;
      --text-yellow-accent: #f59e0b;
      --text-blue-accent: #60a5fa;
      --text-toast: #ffffff;
      --text-dropdown-item-hover: var(--text-link-hover);

      --border-primary: #374151;
      --border-card: #4b5563;
      --border-input: #4b5563;
      --border-input-focus: var(--text-link);
      --border-button-primary: transparent;
      --border-button-primary-hover: transparent;
      --border-button-destructive: transparent;
      --border-button-secondary: var(--border-primary);
      --border-preview: #4b5563;
      --border-toast-success: #059669;
      --border-toast-error: #e11d48;
      --border-dropdown-menu: var(--border-primary);
      --border-breadcrumb: var(--border-primary);

      --shadow-card-item: 0 4px 6px -1px rgba(0, 0, 0, 0.3),
        0 2px 4px -2px rgba(0, 0, 0, 0.3);
      --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.3),
        0 4px 6px -4px rgba(0, 0, 0, 0.3);
      --shadow-input-focus: 0 0 0 2px var(--text-link);
      --shadow-modal: 0 20px 25px -5px rgba(0, 0, 0, 0.4),
        0 8px 10px -6px rgba(0, 0, 0, 0.4);
      --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.5);
      --shadow-dropdown: 0 10px 15px -3px rgba(0, 0, 0, 0.2),
        0 4px 6px -2px rgba(0, 0, 0, 0.1);

      --scrollbar-thumb: #4b5563;
      --scrollbar-track: #1f2937;
    }

    .light-theme {
      --bg-primary: #f9fafb;
      --bg-card: #ffffff;
      --bg-card-hover: #f3f4f6;
      --bg-input: #ffffff;
      --bg-input-readonly: #e5e7eb;
      --bg-button-primary: #2563eb;
      --bg-button-primary-hover: #1d4ed8;
      --bg-button-destructive: #ef4444;
      --bg-button-destructive-hover: #dc2626;
      --bg-button-secondary: #e5e7eb;
      --bg-button-secondary-hover: #d1d5db;
      --bg-action-icon-hover: #e5e7eb;
      --bg-inline-form: #f9fafb;
      --bg-modal-overlay: rgba(17, 24, 39, 0.6);
      --bg-modal-content: #ffffff;
      --bg-toast-success: #ecfdf5;
      --bg-toast-error: #fff1f2;
      --bg-dropdown-menu: var(--bg-card);
      --bg-breadcrumb: #ffffff;
      --bg-breadcrumb-hover: #f3f4f6;

      --text-primary: #1f2937;
      --text-secondary: #4b5563;
      --text-tertiary: #6b7280;
      --text-placeholder: #9ca3af;
      --text-button-primary: #ffffff;
      --text-button-destructive: #ffffff;
      --text-button-secondary: #374151;
      --text-card-header: #111827;
      --text-link: #2563eb;
      --text-link-hover: #1d4ed8;
      --text-action-icon: #6b7280;
      --text-action-icon-hover: #1f2937;
      --text-green-accent: #059669;
      --text-red-accent: #e11d48;
      --text-yellow-accent: #f59e0b;
      --text-blue-accent: #3b82f6;
      --text-toast: #065f46;
      --text-toast-error: #c2410c;
      --text-dropdown-item-hover: var(--text-link);

      --border-primary: #e5e7eb;
      --border-card: #e5e7eb;
      --border-input: #d1d5db;
      --border-input-focus: var(--text-link);
      --border-button-secondary: #d1d5db;
      --border-preview: #e5e7eb;
      --border-toast-success: #6ee7b7;
      --border-toast-error: #fda4af;
      --border-dropdown-menu: var(--border-primary);
      --border-breadcrumb: var(--border-primary);

      --shadow-card-item: 0 4px 6px -1px rgba(0, 0, 0, 0.07),
        0 2px 4px -2px rgba(0, 0, 0, 0.07);
      --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.07),
        0 4px 6px -4px rgba(0, 0, 0, 0.07);
      --shadow-input-focus: 0 0 0 2px var(--text-link);
      --shadow-modal: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
        0 8px 10px -6px rgba(0, 0, 0, 0.1);
      --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-dropdown: 0 10px 15px -3px rgba(0, 0, 0, 0.05),
        0 4px 6px -2px rgba(0, 0, 0, 0.05);

      --scrollbar-thumb: #d1d5db;
      --scrollbar-track: #f3f4f6;
    }

    body {
      font-family: "Inter", sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #folder-content-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.25rem;
    }

    .item-card,
    .search-result-card {
      background-color: var(--bg-card);
      border: 1px solid var(--border-card);
      border-radius: 0.75rem;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: all 0.2s ease-in-out;
      box-shadow: var(--shadow-card-item);
      cursor: pointer;
      position: relative; /* Ensures popover positioning context */
      min-height: 120px;
    }
    .item-card:hover,
    .search-result-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
      border-color: var(--text-link);
    }
    .light-theme .item-card:hover,
    .light-theme .search-result-card:hover {
      box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
    }

    .item-card-icon-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 3rem;
      height: 3rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      background-color: rgba(127, 127, 127, 0.1);
    }
    .item-card-icon svg,
    .search-result-icon svg {
      width: 1.75rem;
      height: 1.75rem;
    }

    .item-card-name,
    .search-result-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      word-break: break-word;
      line-height: 1.4;
    }
    .item-card-name .highlight,
    .search-result-name .highlight {
      background-color: var(--text-yellow-accent);
      color: var(--bg-card) !important;
      padding: 1px 3px;
      border-radius: 3px;
      font-weight: 700;
    }
    .light-theme .item-card-name .highlight,
    .light-theme .search-result-name .highlight {
      background-color: #fef9c3;
      color: #713f12 !important;
    }

    .item-card-type, /* This class might be less used now, metadata integrated differently */
    .search-result-type {
      font-size: 0.8rem;
      color: var(--text-tertiary);
    }
    .search-result-path {
      font-size: 0.75rem;
      color: var(--text-link);
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
      word-break: break-word;
      line-height: 1.3;
    }
    .item-card-actions {
      margin-top: auto;
      padding-top: 1rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }
    .item-card:hover .item-card-actions {
      opacity: 1;
    }

    .artifact-list-item {
      background-color: var(--bg-card);
      border: 1px solid var(--border-card);
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      transition: background-color 0.2s ease;
      position: relative; /* For popover context */
    }

    .artifact-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }

    .artifact-icon svg {
      width: 1.25rem;
      height: 1.25rem;
      flex-shrink: 0;
      color: var(--text-blue-accent);
    }

    .artifact-title {
      font-weight: 500;
      color: var(--text-primary);
      flex-grow: 1;
      word-break: break-word;
    }

    .artifact-actions {
      display: flex;
      gap: 0.25rem;
      margin-left: auto;
    }
    .artifact-actions .action-icon-btn {
      padding: 0.3rem;
    }

    .artifact-dropdown-arrow {
      font-size: 0.8rem;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
      padding: 0.25rem;
      margin-left: 0.5rem;
    }

    .artifact-dropdown-arrow.expanded {
      transform: rotate(180deg);
    }

    .artifact-description {
      padding: 0.75rem 0 0.25rem 0;
      margin-left: calc(1.25rem + 0.75rem); /* Align with title, after icon */
      font-size: 0.875rem;
      color: var(--text-secondary);
      border-top: 1px solid var(--border-input);
      margin-top: 0.75rem;
      line-height: 1.6;
    }
    .artifact-description p {
      margin-bottom: 0.5rem;
    }
    .artifact-description p.truncate-description {
      overflow: hidden;
      line-height: 1.5;
      margin-bottom: 0.5rem;
    }
    .artifact-description .artifact-link {
      font-size: 0.8rem !important;
      padding: 0.25rem 0.6rem !important;
      margin-top: 0.25rem;
      display: inline-flex;
      align-items: center;
    }
    .artifact-description .artifact-link svg {
      width: 0.75rem;
      height: 0.75rem;
    }

    #folder-content-container.list-view-only {
      display: block;
    }

    /* Styles for Current Folder Overview */
    #current-folder-overview-container {
      padding: 1.5rem;
      border: 1px solid var(--border-primary);
      margin-bottom: 1.5rem;
      margin-top: 1rem;
      border-radius: 0.75rem;
      background-color: var(--bg-inline-form);
      box-shadow: var(--shadow-card-item);
    }
    #current-folder-overview-container p.readme-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    /* End Styles for Current Folder Overview */

    .item-card-description,
    .search-result-description { /* Also used by search results */
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      max-height: 63px; /* approx 3 lines */
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
      word-break: break-word;
      line-height: 1.5;
    }

    .item-card-description::-webkit-scrollbar,
    .search-result-description::-webkit-scrollbar {
      width: 6px;
    }

    .item-card-description::-webkit-scrollbar-track,
    .search-result-description::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
      border-radius: 3px;
    }

    .item-card-description::-webkit-scrollbar-thumb,
    .search-result-description::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 3px;
    }

    .item-card > div:first-child { /* This targets the main content wrapper inside item-card */
      display: flex;
      flex-direction: column;
      flex-grow: 1; /* Allows actions to be pushed to bottom */
    }

    #breadcrumb-container {
      background-color: transparent;
      padding: 0.5rem 0;
      margin-bottom: 1.5rem;
      border: none;
      border-bottom: 1px solid var(--border-primary);
      border-radius: 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .breadcrumb-item {
      color: var(--text-link);
      text-decoration: none;
      cursor: pointer;
      font-size: 0.9rem;
      transition: color 0.2s ease;
    }
    .breadcrumb-item:hover {
      text-decoration: underline;
      color: var(--text-link-hover);
    }
    .breadcrumb-separator {
      margin: 0 0.6rem;
      color: var(--text-tertiary);
      font-size: 0.8rem;
    }
    .breadcrumb-current {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.9rem;
    }
    #add-item-form-container {
      background-color: var(--bg-card);
      padding: 1.5rem;
      border-radius: 0.75rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-card);
      box-shadow: var(--shadow-card-item);
    }
    #current-folder-header h2 {
      font-weight: 700;
    }

    .form-inline input,
    .form-inline select,
    .form-inline textarea {
      margin-bottom: 0.75rem;
    }
    #artifact-details-modal-description {
      max-height: 200px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
    }
    #artifact-details-modal-description::-webkit-scrollbar {
      width: 6px;
    }
    #artifact-details-modal-description::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
    }
    #artifact-details-modal-description::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 3px;
    }
    .submit-button {
      font-weight: 500;
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
        0 1px 2px -1px rgba(0, 0, 0, 0.1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid transparent;
    }
    .submit-button.primary {
      background-color: var(--bg-button-primary);
      color: var(--text-button-primary);
    }
    .submit-button.primary:hover {
      background-color: var(--bg-button-primary-hover);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .submit-button.secondary {
      background-color: var(--bg-button-secondary);
      color: var(--text-button-secondary);
      border-color: var(--border-button-secondary);
    }
    .submit-button.secondary:hover {
      background-color: var(--bg-button-secondary-hover);
    }

    .submit-button.destructive {
      background-color: var(--bg-button-destructive);
      color: var(--text-button-destructive);
    }
    .submit-button.destructive:hover {
      background-color: var(--bg-button-destructive-hover);
    }

    .submit-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .spinner {
      animation: spin 1s linear infinite;
      border: 2px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      width: 1em;
      height: 1em;
      margin-right: 0.5em;
    }

    .input-field,
    textarea.input-field {
      background-color: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border-input);
      border-radius: 0.5rem;
      padding: 0.6rem 0.9rem;
    }
    textarea.input-field {
      min-height: 70px;
    }
    .input-field::placeholder,
    textarea.input-field::placeholder {
      color: var(--text-placeholder);
      opacity: 0.8;
    }
    .input-field:focus,
    textarea.input-field:focus {
      border-color: var(--border-input-focus);
      outline: none;
      box-shadow: var(--shadow-input-focus);
      background-color: var(--bg-card);
    }

    .label-text {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.375rem;
    }
    .card { /* General card containing the main content area */
      background-color: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 0.75rem;
      box-shadow: var(--shadow-card);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .card-header {
      color: var(--text-card-header);
      font-weight: 700;
    }

    .action-icon-btn {
      color: var(--text-action-icon);
      padding: 0.4rem;
      border-radius: 0.375rem;
      transition: all 0.2s ease-in-out;
      flex-shrink: 0;
    }
    .action-icon-btn:hover {
      color: var(--text-action-icon-hover);
      background-color: var(--bg-action-icon-hover);
      transform: scale(1.1);
    }
    .action-icon-btn.add {
      color: var(--text-green-accent);
    }
    .action-icon-btn.delete {
      color: var(--text-red-accent);
      position: relative;
      bottom: 0px;
    }
    /* START: Added styles for Info Button and Popover */
    .action-icon-btn.info {
      color: var(--text-blue-accent);
    }
    .action-icon-btn.info:hover {
      color: var(--text-link-hover);
    }
    .info-popover {
      min-width: 280px;
      max-width: 320px; /* Constrain max width */
      box-shadow: var(--shadow-dropdown);
    }
    .info-popover p {
      margin-bottom: 0.3rem;
    }
    .info-popover strong {
      color: var(--text-primary); /* Ensure strong text is readable */
      font-weight: 600; /* Tailwind's font-semibold */
    }
    .info-popover .max-h-24 { /* For scrollable description in popover */
      max-height: 6rem; /* approx 96px */
    }
    .info-popover .readme-text { /* Match style of folder overview text, but for popover */
      font-size: 0.875rem; /* Tailwind text-sm */
      color: var(--text-secondary);
      line-height: 1.6;
    }
    .info-popover .scrollbar-thin::-webkit-scrollbar {
      width: 5px;
      height: 5px;
    }
    .info-popover .scrollbar-thin::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
      border-radius: 3px;
    }
    .info-popover .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 3px;
    }
    .info-popover .scrollbar-thin {
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
    }
    /* END: Added styles for Info Button and Popover */

    #theme-toggle-button {
      background-color: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border-primary);
      padding: 0.5rem;
      border-radius: 0.5rem;
    }
    #theme-toggle-button:hover {
      background-color: var(--bg-card-hover);
      color: var(--text-primary);
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-modal-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 1000;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background-color: var(--bg-modal-content);
      padding: 2rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow-modal);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0);
      opacity: 1;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-primary);
      padding-bottom: 1rem;
    }
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-card-header);
    }
    .modal-close-btn {
      background: none;
      border: none;
      font-size: 1.75rem;
      cursor: pointer;
      color: var(--text-tertiary);
      transition: color 0.2s ease;
      line-height: 1;
    }
    .modal-close-btn:hover {
      color: var(--text-primary);
    }

    #search-input-wrapper {
      position: relative;
    }
    #search-input {
      width: 100%;
      max-width: 400px;
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      padding-left: 2.8rem;
    }
    #search-input-icon {
      position: absolute;
      left: 0.75rem; /* Standard left padding for icon */
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-placeholder);
      pointer-events: none;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .user-menu-container {
      position: relative;
    }
    #user-menu-button {
      background-color: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border-primary);
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #user-menu-button:hover {
      background-color: var(--bg-card-hover);
      color: var(--text-primary);
    }
    #user-dropdown-menu {
      background-color: var(--bg-dropdown-menu);
      border: 1px solid var(--border-dropdown-menu);
      box-shadow: var(--shadow-dropdown);
      z-index: 1010;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    #user-dropdown-menu button:hover {
      background-color: var(--bg-card-hover);
      color: var(--text-dropdown-item-hover);
    }
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .toast {
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      color: var(--text-toast);
      box-shadow: var(--shadow-toast);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-width: 1px;
      border-style: solid;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.success {
      background-color: var(--bg-toast-success);
      border-color: var(--border-toast-success);
      color: var(--text-toast, #ffffff);
    }
    .light-theme .toast.success {
      color: var(--text-toast, #065f46);
    }
    .toast.error {
      background-color: var(--bg-toast-error);
      border-color: var(--border-toast-error);
      color: var(--text-toast, #ffffff);
    }
    .light-theme .toast.error {
      color: var(--text-toast-error, #c2410c);
    }
    .toast-icon {
      flex-shrink: 0;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    #back-button {
      transition: 0.2s;
    }

    /* Styles for D3 Tree Graph */
    #node-graph-visualization {
      min-height: 450px;
      height: 60vh;
      max-height: 700px;
    }
    #node-graph-visualization svg {
      display: block;
      margin: auto;
      background-color: var(--bg-primary);
      cursor: grab;
    }
    .graph-node circle {
      stroke: var(--border-card);
      stroke-width: 1.5px;
      transition: transform 0.2s ease-out, r 0.2s ease-out;
    }
    .graph-node:hover circle {
      transform: scale(1.2);
      stroke-width: 2.5px;
      stroke: var(--text-link-hover);
    }
    .graph-node text {
      font-family: "Inter", sans-serif;
      font-size: 11px;
      fill: var(--text-secondary);
      paint-order: stroke;
      stroke: var(--bg-primary);
      stroke-width: 3px;
      stroke-linecap: butt;
      stroke-linejoin: miter;
    }
    .graph-node.is-center text {
      font-weight: 700;
      fill: var(--text-primary);
    }
    .graph-link {
      fill: none;
      stroke: var(--border-input);
      stroke-opacity: 0.7;
      stroke-width: 1.5px;
    }

    /* Search result card specific action button positioning */
    .search-result-card .item-card-actions {
      opacity: 1; /* Make actions always visible */
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      padding-top: 0; /* Override from .item-card-actions */
      gap: 0.25rem;
    }
    .search-result-card .item-card-actions .action-icon-btn {
      padding: 0.25rem; /* Smaller icons for search results */
    }
  </style>
  </head>
  <body>
    <div id="toast-container"></div>
    <div class="container mx-auto p-4 md:p-8">
      <header
        class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4 pb-6 border-b border-[var(--border-primary)]"
      >
        <div class="flex items-center">
          <img
            id="user-page-logo"
            src="https://niveussolutions.com/wp-content/uploads/2025/02/Niveus-ntt-data.png"
            alt="DocNest Logo"
            class="h-12 w-auto mr-3 pt-3"
          />
          <h1
            class="text-3xl sm:text-4xl font-extrabold tracking-tight text-[var(--text-card-header)]"
          >
            DocNest KB
          </h1>
        </div>
        <div class="header-controls flex items-center gap-3">
          <div id="search-input-wrapper" class="relative">
            <div
              id="search-input-icon"
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <input
              type="search"
              id="search-input"
              class="input-field"
              placeholder="Search knowledge base..."
            />
          </div>
          <button
            id="theme-toggle-button"
            class="p-2.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--border-input-focus)] flex-shrink-0"
            title="Toggle Theme"
          ></button>
          <div class="user-menu-container">
            <button
              id="user-menu-button"
              type="button"
              aria-expanded="false"
              aria-haspopup="true"
              class="p-2.5"
            >
              <span id="user-display-name" class="text-sm font-medium"
                >User</span
              >
              <svg
                class="h-5 w-5 text-[var(--text-tertiary)] ml-1"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
            <div
              id="user-dropdown-menu"
              class="absolute right-0 mt-2 w-64 origin-top-right rounded-md bg-[var(--bg-dropdown-menu)] shadow-lg ring-1 ring-[var(--border-dropdown-menu)] ring-opacity-5 focus:outline-none hidden"
              role="menu"
              aria-orientation="vertical"
              aria-labelledby="user-menu-button"
            >
              <div class="py-1" role="none">
                <div class="px-4 py-3 border-b border-[var(--border-primary)]">
                  <p
                    class="text-sm font-semibold text-[var(--text-primary)]"
                    id="dropdown-user-name"
                  >
                    User Name
                  </p>
                  <p
                    class="text-xs text-[var(--text-secondary)] truncate"
                    id="dropdown-user-email"
                  >
                    user@example.com
                  </p>
                </div>
                <button
                  id="logout-button-dropdown"
                  class="block w-full px-4 py-2 text-left text-sm text-[var(--text-red-accent)] hover:bg-[var(--bg-card-hover)] hover:text-[var(--text-red-accent)]"
                  role="menuitem"
                >
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="card p-6 sm:p-8 rounded-xl shadow-2xl">
        <div id="breadcrumb-container" class="mb-6"></div>

        <div
          id="current-folder-header"
          class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
        >
          <div class="flex items-center gap-2 md:gap-3">
            <button
              id="back-button"
              title="Go Back"
              class="p-2 rounded-md text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-action-icon-hover)] flex-shrink-0"
              style="display: none"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 md:h-6 md:w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
              </svg>
            </button>
            <h2
              id="current-folder-name"
              class="text-xl md:text-2xl font-bold text-[var(--text-card-header)]"
            >
              Knowledge Base
            </h2>
          </div>
          <button
            id="add-item-to-current-folder-button"
            class="submit-button primary text-sm py-2 px-4 self-start sm:self-center"
            style="display: none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 4v16m8-8H4"
              />
            </svg>
            <span class="button-text">Add Item Here</span>
          </button>
        </div>

        <div
          id="add-item-form-container"
          class="form-inline mb-8 p-6"
          style="display: none"
        ></div>

        <div id="folder-content-container" class="min-h-[300px] relative">
          <div
            id="loading-placeholder"
            class="absolute inset-0 flex items-center justify-center text-center"
          >
            <p class="p-4 text-lg text-[var(--text-secondary)]">
              Loading content...
            </p>
          </div>
        </div>

        <div
          id="node-graph-section"
          class="mt-8 pt-6 border-t border-[var(--border-primary)]"
          style="display: none"
        >
          <h3
            class="text-xl md:text-2xl font-bold text-[var(--text-card-header)] mb-4"
          >
            Folder Hierarchy
          </h3>
          <div
            id="node-graph-loading"
            class="flex items-center justify-center text-center p-4 min-h-[200px]"
            style="display: none"
          >
            <p class="text-lg text-[var(--text-secondary)]">Loading graph...</p>
          </div>
          <div
            id="node-graph-error"
            class="text-center p-4 text-[var(--text-red-accent)] min-h-[100px]"
            style="display: none"
          ></div>
          <div
            id="node-graph-visualization"
            class="border border-[var(--border-input)] rounded-lg bg-[var(--bg-primary)] overflow-hidden relative"
          ></div>
        </div>
      </div>
    </div>
    <div id="artifact-details-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="artifact-modal-title" class="modal-title">
            Artifact Details
          </h3>
          <button class="modal-close-btn" onclick="closeArtifactDetailsModal()">
            &times;
          </button>
        </div>
        <div class="mb-4">
          <label class="label-text">Description:</label>
          <div
            id="artifact-details-modal-description"
            class="p-3 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-sm min-h-[60px]"
          >
            No description provided.
          </div>
        </div>
        <div class="mt-6 text-right space-x-3">
          <a
            id="artifact-modal-link"
            href="#"
            target="_blank"
            class="submit-button primary inline-block"
          >
            Go to Resource
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 inline-block ml-1.5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              />
            </svg>
          </a>
          <button
            class="submit-button secondary"
            onclick="closeArtifactDetailsModal()"
          >
            <span class="button-text">Close</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ", // Replace with your actual API key
        authDomain: "docnest-f85e2.firebaseapp.com",
        projectId: "docnest-f85e2",
        storageBucket: "docnest-f85e2.appspot.com",
        messagingSenderId: "102395439437",
        appId: "1:102395439437:web:84e6676388b5d54395af04",
        measurementId: "G-YRMBR8BVSE",
      };

      // --- Global Helper Functions (Toast, Button Loading, Escape, Debounce) ---
      window.showNotification = function (
        message,
        type = "success",
        duration = 3000
      ) {
        const toastContainer = document.getElementById("toast-container");
        if (!toastContainer) return;
        const toast = document.createElement("div");
        toast.classList.add("toast", type);
        let iconHtml = "";
        if (type === "success") {
          iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
        } else if (type === "error") {
          iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.293-10.293a1 1 0 00-1.414 0L9 8.586l-.293-.293a1 1 0 10-1.414 1.414L7.586 10l-.293.293a1 1 0 101.414 1.414L9 11.414l.293.293a1 1 0 001.414-1.414L10.414 10l.293-.293a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`;
        }
        toast.innerHTML = `${iconHtml}<span>${message}</span>`;
        toastContainer.appendChild(toast);
        toast.offsetHeight;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, duration);
      };

      window.setButtonLoading = function (
        button,
        isLoading,
        originalText = null
      ) {
        if (!(button instanceof HTMLElement)) {
          console.error("setButtonLoading: invalid button", button);
          return;
        }
        const buttonTextSpan = button.querySelector(".button-text");
        const defaultOriginal = buttonTextSpan
          ? buttonTextSpan.dataset.originalText || buttonTextSpan.textContent
          : button.dataset.originalText || button.textContent;

        if (isLoading) {
          button.disabled = true;
          if (buttonTextSpan) {
            if (
              originalText !== null &&
              typeof buttonTextSpan.dataset.originalText === "undefined"
            )
              buttonTextSpan.dataset.originalText = defaultOriginal;
            buttonTextSpan.innerHTML = `<span class="spinner"></span>Processing...`;
          } else {
            if (
              originalText !== null &&
              typeof button.dataset.originalText === "undefined"
            )
              button.dataset.originalText = defaultOriginal;
            button.innerHTML = `<span class="spinner"></span>Processing...`;
          }
        } else {
          button.disabled = false;
          if (buttonTextSpan) {
            buttonTextSpan.innerHTML =
              originalText || buttonTextSpan.dataset.originalText || "Submit";
            delete buttonTextSpan.dataset.originalText;
          } else {
            button.innerHTML =
              originalText || button.dataset.originalText || "Submit";
            delete button.dataset.originalText;
          }
        }
      };
      function escapeJSString(str) {
        if (typeof str !== "string") return "";
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;")
          .replace(/`/g, "&#96;");
      }
      function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            func.apply(this, args);
          }, delay);
        };
      }
      // --- End Global Helper Functions ---

      // --- Firebase Initialization ---
      let firebaseApp;
      let firebaseAuth;

      if (firebaseConfig.apiKey === "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ") {
        // Check against the common placeholder
        console.warn(
          "User Page: Firebase API Key is a placeholder. Real functionality will be limited."
        );
        // Proceed with initialization for local testing, but it won't connect to Firebase.
        try {
          firebaseApp = firebase.initializeApp(firebaseConfig);
          firebaseAuth = firebase.auth();
          console.log(
            "User Page: Firebase initialized with placeholder config."
          );
        } catch (e) {
          console.error(
            "User Page: Error initializing Firebase with placeholder:",
            e
          );
          window.showNotification(
            "Critical Error: Auth service init failed (placeholder).",
            "error",
            10000
          );
        }
      } else {
        try {
          firebaseApp = firebase.initializeApp(firebaseConfig);
          firebaseAuth = firebase.auth();
          console.log("User Page: Firebase initialized with actual config.");
        } catch (e) {
          console.error("User Page: Error initializing Firebase:", e);
          window.showNotification(
            "Critical Error: Firebase Auth service initialization failed.",
            "error",
            10000
          );
          if (
            document.body &&
            !window.location.pathname.endsWith("user_login.html")
          ) {
            document.body.innerHTML =
              '<div style="padding: 20px; text-align: center; font-size: 1.2em; color: red;">Application cannot start: Firebase configuration is missing or invalid.</div>';
          }
        }
      }
      // --- End Firebase Initialization ---

      // --- DOM Elements ---
      const userMenuButton = document.getElementById("user-menu-button");
      const userDisplayNameSpan = document.getElementById("user-display-name");
      const userDropdownMenu = document.getElementById("user-dropdown-menu");
      const dropdownUserName = document.getElementById("dropdown-user-name");
      const dropdownUserEmail = document.getElementById("dropdown-user-email");
      const logoutButtonDropdown = document.getElementById(
        "logout-button-dropdown"
      );
      const searchInputElement = document.getElementById("search-input");
      const breadcrumbContainer = document.getElementById(
        "breadcrumb-container"
      );
      const folderContentContainer = document.getElementById(
        "folder-content-container"
      );
      const addItemToFolderBtn = document.getElementById(
        "add-item-to-current-folder-button"
      );
      const addItemFormContainer = document.getElementById(
        "add-item-form-container"
      );
      const currentFolderNameEl = document.getElementById(
        "current-folder-name"
      );
      const loadingPlaceholder = document.getElementById("loading-placeholder");
      const backButton = document.getElementById("back-button");
      // --- End DOM Elements ---

      // --- Global State ---
      let currentUserRoles = [];
      let fullTreeData = [];
      let currentPath = [];
      let currentViewNodeId = null;
      let isSearchViewActive = false;
      let currentInfoDropdown = null;
      // --- End Global State ---

      // ================================================================
      // DYNAMIC BACKEND URL CONFIGURATION
      // ================================================================
      let BASE_API_URL;
      const localBaseUrl = "https://docnest-780614596615.asia-south1.run.app"; // Replace with your actual local backend URL if different
      const cloudRunBaseUrl =
        "https://docnest-780614596615.asia-south1.run.app"; // Replace with your actual Cloud Run URL

      if (
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
      ) {
        BASE_API_URL = localBaseUrl;
        console.log("USER PAGE: Using LOCAL backend API base:", BASE_API_URL);
      } else {
        BASE_API_URL = cloudRunBaseUrl;
        console.log("USER PAGE: Using CLOUD backend API base:", BASE_API_URL);

        if (
          cloudRunBaseUrl.includes("your-userpage-backend-url") || // Common placeholder
          cloudRunBaseUrl.includes("your-actual-cloud-run-url") // Another placeholder
        ) {
          const warningMessage =
            "CRITICAL: User Page Cloud Run URL (BASE_API_URL) is a placeholder! API calls will likely fail. Please update 'cloudRunBaseUrl' in the script.";
          console.error(warningMessage);
          if (window.showNotification) {
            window.showNotification(warningMessage, "error", 60000);
          } else {
            alert(warningMessage);
          }
          if (loadingPlaceholder) {
            loadingPlaceholder.innerHTML = `<p class="p-4 text-lg text-[var(--text-red-accent)]">${warningMessage}</p>`;
            loadingPlaceholder.style.display = "flex";
          }
        }
      }
      // ================================================================

      // --- Authentication & Authorization ---
      if (firebaseAuth) {
        firebaseAuth.onAuthStateChanged(async (user) => {
          if (user) {
            console.log("User Page: User is signed in.", user.email);
            if (userDisplayNameSpan)
              userDisplayNameSpan.textContent =
                user.displayName || user.email.split("@")[0];
            if (dropdownUserName)
              dropdownUserName.textContent = user.displayName || "N/A";
            if (dropdownUserEmail) dropdownUserEmail.textContent = user.email;

            if (
              BASE_API_URL &&
              !BASE_API_URL.includes("your-userpage-backend-url") && // Check against placeholders
              !BASE_API_URL.includes("your-actual-cloud-run-url")
            ) {
              await loadInitialDataConcurrently();
            } else {
              console.error(
                "User Page: Backend API URL is not properly configured. Halting data load."
              );
              if (loadingPlaceholder) {
                loadingPlaceholder.innerHTML = `<p class="p-4 text-lg text-[var(--text-red-accent)]">Application error: Backend service URL is not configured. Please contact support.</p>`;
                loadingPlaceholder.style.display = "flex";
              }
              if (firebaseAuth)
                // Sign out if config is bad
                await firebaseAuth
                  .signOut()
                  .catch((e) =>
                    console.error("Error signing out due to config issue:", e)
                  );
            }
          } else {
            console.log(
              "User Page: No user signed in. Redirecting to user_login.html."
            );
            sessionStorage.removeItem("userToken");
            currentUserRoles = [];
            fullTreeData = [];
            if (!window.location.pathname.endsWith("user_login.html")) {
              window.location.href = "user_login.html";
            }
          }
        });
      } else {
        console.error(
          "User Page: Firebase Auth service is not available. Cannot proceed."
        );
        if (!window.location.pathname.endsWith("user_login.html")) {
          if (loadingPlaceholder) {
            loadingPlaceholder.innerHTML =
              '<p class="p-4 text-lg text-[var(--text-red-accent)]">Authentication service failed to initialize. Please check configuration or contact support. You may need to <a href="user_login.html" class="text-[var(--text-link)]">login again</a>.</p>';
            loadingPlaceholder.style.display = "flex";
          }
          setTimeout(() => {
            // Give user time to see message before redirect
            if (!window.location.pathname.endsWith("user_login.html")) {
              window.location.href = "user_login.html";
            }
          }, 3000);
        }
      }

      async function getAuthToken() {
        if (!firebaseAuth || !firebaseAuth.currentUser) {
          console.warn(
            "User Page: No Firebase current user for token request. Redirecting to login."
          );
          if (!window.location.pathname.endsWith("user_login.html")) {
            window.location.href = "user_login.html";
          }
          return null;
        }
        try {
          const token = await firebaseAuth.currentUser.getIdToken(true); // Force refresh
          sessionStorage.setItem("userToken", token);
          return token;
        } catch (error) {
          console.error("User Page: Error getting ID token:", error);
          window.showNotification(
            "Your session may have expired. Please try logging in again.",
            "error",
            5000
          );
          if (firebaseAuth) {
            // Attempt to sign out if token fails
            await firebaseAuth
              .signOut()
              .catch((e) =>
                console.error("User Page: Signout failed after token error", e)
              );
          } else if (!window.location.pathname.endsWith("user_login.html")) {
            // Fallback redirect if signOut also problematic
            window.location.href = "user_login.html";
          }
          return null;
        }
      }

      async function secureFetch(url, options = {}) {
        const token = await getAuthToken();
        if (!token) {
          throw new Error(
            "Authentication token unavailable. User might be logged out or session expired."
          );
        }

        const headers = { ...options.headers };
        headers["Authorization"] = `Bearer ${token}`;

        if (
          options.body &&
          !(options.body instanceof FormData) && // Don't set for FormData, browser does it
          (options.method === "POST" ||
            options.method === "PUT" ||
            options.method === "PATCH")
        ) {
          headers["Content-Type"] = "application/json";
        }

        try {
          const response = await fetch(url, { ...options, headers });
          if (response.status === 401 || response.status === 403) {
            console.error(
              `User Page: Authorization error (${response.status}) for ${url}.`
            );
            window.showNotification("Access Denied", "error", 5000);
            setTimeout(() => {
              window.location.href = "/userpage.html";
            }, 500);

            throw new Error(`Authorization failed (${response.status})`);
          }
          return response;
        } catch (networkError) {
          console.error(
            "User Page: Network or Auth error during secureFetch:",
            networkError
          );
          if (!networkError.message.includes("Authorization failed")) {
            // Avoid double notification
            window.showNotification(
              `Network Error: ${networkError.message}. Check connection or server status.`,
              "error",
              7000
            );
          }
          throw networkError; // Re-throw to be caught by calling function
        }
      }
      // --- End Authentication & Authorization ---

      // --- Initial Data Loading (Parallel) ---
      async function fetchRoles() {
        try {
          const response = await secureFetch(`${BASE_API_URL}/api/auth`, {
            method: "POST", // Assuming this endpoint verifies the token and returns roles
          });
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({
              detail: `Roles/Auth verification failed (Status: ${response.status})`,
            }));
            throw new Error(errorData.detail);
          }
          const userData = await response.json();
          if (
            !userData ||
            (userData.isUser !== true && userData.isAdmin !== true) // Check for basic user/admin flag
          ) {
            console.warn(
              "User Page: User does not have sufficient privileges according to backend verification. Signing out."
            );
            window.showNotification(
              "Access Denied. You do not have sufficient privileges for this portal.",
              "error",
              7000
            );
            if (firebaseAuth)
              await firebaseAuth
                .signOut()
                .catch((e) =>
                  console.error("Sign out after privilege check failed", e)
                );
            throw new Error("Insufficient privileges determined by backend.");
          }
          currentUserRoles = userData.roles || []; // Store roles if provided
          console.log(
            "User Page: User roles fetched/verified:",
            currentUserRoles
          );
          return userData; // Return full user data if needed elsewhere
        } catch (error) {
          console.error("User Page: Error in fetchRoles:", error.message);
          if (firebaseAuth)
            // Attempt signout if role fetch fails critically
            await firebaseAuth
              .signOut()
              .catch((e) =>
                console.error("Sign out after fetchRoles error failed", e)
              );
          throw error; // Re-throw for loadInitialDataConcurrently to handle
        }
      }

      async function fetchTreeDataOnly() {
        if (loadingPlaceholder && !isSearchViewActive) {
          // Show loading only if not already in search
          loadingPlaceholder.innerHTML =
            '<p class="p-4 text-lg text-[var(--text-secondary)]">Loading knowledge base structure...</p>';
          loadingPlaceholder.style.display = "flex";
        }

        try {
          const res = await secureFetch(`${BASE_API_URL}/api/tree`);
          if (!res.ok) {
            const errorText = await res.text(); // Get raw error text for better debugging
            throw new Error(
              `Failed to load knowledge base (HTTP ${res.status}): ${
                errorText || "Server error"
              }`
            );
          }
          const data = await res.json();
          if (!Array.isArray(data)) {
            console.error(
              "User Page: Fetched tree data is not an array:",
              data
            );
            throw new Error("Received invalid tree structure from server.");
          }
          fullTreeData = data;
          console.log("User Page: Full tree data fetched:", fullTreeData);
        } catch (error) {
          console.error("User Page: Failed to fetch full tree:", error);
          fullTreeData = []; // Reset tree data on error
          throw error; // Re-throw for loadInitialDataConcurrently
        }
      }

      async function loadInitialDataConcurrently() {
        if (loadingPlaceholder) {
          loadingPlaceholder.innerHTML =
            '<p class="p-4 text-lg text-[var(--text-secondary)]">Initializing knowledge base...</p>';
          loadingPlaceholder.style.display = "flex";
        }
        isSearchViewActive = false; // Reset search view on full load

        try {
          await fetchRoles(); // Ensure roles are fetched first or in parallel if independent
          await fetchTreeDataOnly(); // Then fetch tree data
          navigateToFolder(null); // Navigate to root after data is loaded
        } catch (error) {
          console.error(
            "User Page: Error during initial data load sequence:",
            error
          );
          if (window.showNotification)
            window.showNotification(
              `Could not load page data: ${
                error.message || "Unknown error"
              }. Please try logging in again.`,
              "error",
              10000
            );
          if (folderContentContainer) {
            // Display error in main content area
            folderContentContainer.innerHTML = `<p class="text-[var(--text-red-accent)] p-4 text-center">Critical error loading page data. <br>Details: ${error.message}. <br>Please try refreshing. If the issue persists, you might need to log in again or contact support.</p>`;
          }
        } finally {
          if (loadingPlaceholder) loadingPlaceholder.style.display = "none";
        }
      }
      // --- End Initial Data Loading ---

      // --- Permissions ---
      function canPerformAction(nodeId, allowedRoles) {
        if (nodeId === null || typeof nodeId === "undefined") {
          // Cannot perform action on root via this check directly
          return false;
        }
        const roleEntry = currentUserRoles.find(
          (r) => String(r.nodeId) === String(nodeId)
        );
        return !!(roleEntry && allowedRoles.includes(roleEntry.role));
      }
      function canAddContentToNode(nodeId) {
        return canPerformAction(String(nodeId), ["ADMIN", "EDITOR"]);
      }
      function canDeleteNode(nodeId) {
        // Add additional checks here if needed, e.g., cannot delete root, etc.
        return canPerformAction(String(nodeId), ["ADMIN"]);
      }
      function canEditArtifactsInNode(parentNodeId) {
        // This checks permission on the parent node for actions on its artifacts
        return canPerformAction(String(parentNodeId), ["ADMIN", "EDITOR"]);
      }
      // --- End Permissions ---

      // --- Navigation and Rendering ---
      function findNodeInTree(nodeId, nodesToSearch = fullTreeData) {
        if (
          nodeId === null ||
          typeof nodeId === "undefined" ||
          nodeId === "null"
        ) {
          return {
            id: null,
            name: "Knowledge Base",
            children: nodesToSearch,
            artifacts: [], // Root usually doesn't have direct artifacts in this model
            type: "ROOT",
            description:
              "Welcome to the Knowledge Base. Browse categories below or use the search.", // Optional root description
          };
        }
        for (const node of nodesToSearch) {
          if (String(node.id) === String(nodeId)) return node;
          if (node.children && Array.isArray(node.children)) {
            const found = findNodeInTree(nodeId, node.children);
            if (found) return found;
          }
        }
        return null; // Node not found
      }

      function buildPathSegmentsRecursive(
        targetNodeId,
        nodesToSearch,
        currentStack
      ) {
        for (const node of nodesToSearch) {
          const nodePathSegment = { id: node.id, name: node.name };
          if (String(node.id) === String(targetNodeId)) {
            return [...currentStack, nodePathSegment];
          }
          if (node.children && Array.isArray(node.children)) {
            const foundPath = buildPathSegmentsRecursive(
              targetNodeId,
              node.children,
              [...currentStack, nodePathSegment]
            );
            if (foundPath) return foundPath;
          }
        }
        return null;
      }

      function renderBreadcrumbs() {
        if (!breadcrumbContainer) return;
        breadcrumbContainer.innerHTML = "";
        if (!currentPath || currentPath.length === 0) {
          // Default to root if path is somehow empty
          currentPath = [{ id: null, name: "Knowledge Base" }];
        }
        currentPath.forEach((segment, index) => {
          const segEl = document.createElement("span");
          if (index < currentPath.length - 1) {
            const link = document.createElement("a");
            link.textContent = segment.name;
            link.href = "#"; // Prevent page reload
            link.classList.add("breadcrumb-item");
            link.onclick = (e) => {
              e.preventDefault();
              if (!isSearchViewActive) navigateToFolder(segment.id);
              else {
                // If in search view, clicking breadcrumb should exit search
                isSearchViewActive = false;
                if (searchInputElement) searchInputElement.value = "";
                navigateToFolder(segment.id);
              }
            };
            segEl.appendChild(link);
            breadcrumbContainer.appendChild(segEl);

            const separator = document.createElement("span");
            separator.classList.add("breadcrumb-separator");
            separator.innerHTML = "&gt;"; // HTML entity for ">"
            breadcrumbContainer.appendChild(separator);
          } else {
            // Current page in breadcrumb
            segEl.textContent = segment.name;
            segEl.classList.add("breadcrumb-current");
            breadcrumbContainer.appendChild(segEl);
          }
        });
      }

      async function navigateToFolder(nodeId) {
        // Clear any existing folder overview first
        const existingOverview = document.getElementById(
          "current-folder-overview-container"
        );
        if (existingOverview) {
          existingOverview.remove();
        }

        currentViewNodeId =
          nodeId === undefined || nodeId === null || nodeId === "null"
            ? null
            : String(nodeId);

        if (!isSearchViewActive && searchInputElement)
          // Clear search if navigating normally
          searchInputElement.value = "";

        let newPath;
        if (currentViewNodeId === null) {
          // Root
          newPath = [{ id: null, name: "Knowledge Base" }];
        } else {
          const pathSegments = buildPathSegmentsRecursive(
            currentViewNodeId,
            fullTreeData,
            [] // Initial stack for recursion
          );
          if (pathSegments && pathSegments.length > 0) {
            newPath = [{ id: null, name: "Knowledge Base" }, ...pathSegments]; // Prepend root
          } else {
            // Fallback if node ID not found in tree (e.g., after a deletion)
            console.warn(
              `User Page: Node ID ${currentViewNodeId} not found for path. Navigating to root.`
            );
            newPath = [{ id: null, name: "Knowledge Base" }];
            currentViewNodeId = null; // Reset to root
          }
        }
        currentPath = newPath;
        const currentFolderObject = findNodeInTree(
          currentViewNodeId,
          fullTreeData
        );

        displayCurrentFolderOverview(currentFolderObject); // Display overview for the current folder

        renderBreadcrumbs();
        if (!isSearchViewActive) {
          renderFolderContents(); // Render sub-folders and artifacts
          if (currentViewNodeId !== null) {
            // Display graph only if not at root
            await displayNodeGraph(currentViewNodeId);
          } else {
            hideNodeGraph(); // Hide graph if at root
          }
        } else {
          hideNodeGraph(); // Hide graph if in search view
        }

        if (currentFolderNameEl)
          currentFolderNameEl.textContent = currentFolderObject
            ? currentFolderObject.name
            : "Knowledge Base"; // Fallback name

        if (backButton) {
          if (currentPath.length > 1 && !isSearchViewActive) {
            // Show back if not at root and not in search
            backButton.style.display = "inline-flex";
            backButton.onclick = () => {
              if (currentPath.length > 1) {
                // Should always be true if button is visible
                const parentSegment = currentPath[currentPath.length - 2];
                navigateToFolder(parentSegment.id);
              }
            };
          } else {
            backButton.style.display = "none";
          }
        }

        if (addItemToFolderBtn) {
          const nodeIdForPermissionCheck =
            currentViewNodeId === null ? null : String(currentViewNodeId); // Use string for permission check
          if (
            nodeIdForPermissionCheck !== null && // Can't add to root via this button
            canAddContentToNode(nodeIdForPermissionCheck) &&
            !isSearchViewActive // Don't show add button in search view
          ) {
            addItemToFolderBtn.style.display = "inline-flex";
            addItemToFolderBtn.onclick = () => toggleAddItemForm(true);
          } else {
            addItemToFolderBtn.style.display = "none";
            toggleAddItemForm(false); // Ensure form is hidden if button is hidden
          }
        }
      }

     // --- Navigation and Rendering ---
// ... (findNodeInTree, buildPathSegmentsRecursive, renderBreadcrumbs, navigateToFolder remain the same) ...

function renderFolderContents() {
    if (!folderContentContainer) return;
    folderContentContainer.innerHTML = "";

    const nodeToDisplay = findNodeInTree(currentViewNodeId, fullTreeData);

    if (loadingPlaceholder) loadingPlaceholder.style.display = "flex";

    if (!nodeToDisplay) {
        folderContentContainer.innerHTML =
            '<p class="p-4 text-[var(--text-tertiary)] text-center">Folder not found or you may not have access to it.</p>';
        if (loadingPlaceholder) loadingPlaceholder.style.display = "none";
        return;
    }

    const itemsToShow = [];
    if (nodeToDisplay.children && Array.isArray(nodeToDisplay.children)) {
        itemsToShow.push(
            ...nodeToDisplay.children.map((c) => ({
                ...c,
                itemType: "folder",
                parentIdActual: String(nodeToDisplay.id === null ? "null" : nodeToDisplay.id),
            }))
        );
    }
    if (nodeToDisplay.artifacts && Array.isArray(nodeToDisplay.artifacts)) {
        itemsToShow.push(
            ...nodeToDisplay.artifacts.map((a) => ({
                ...a,
                itemType: "artifact",
                parentIdActual: String(nodeToDisplay.id === null ? "null" : nodeToDisplay.id),
            }))
        );
    }

    itemsToShow.sort(customSortItems);

    const allArtifacts = itemsToShow.length > 0 && itemsToShow.every((item) => item.itemType === "artifact");
    if (allArtifacts && itemsToShow.length > 3) { // Apply list view if all artifacts and more than 3 (or your preferred threshold)
        folderContentContainer.classList.add("list-view-only");
        folderContentContainer.style.display = "block";
    } else {
        folderContentContainer.classList.remove("list-view-only");
        folderContentContainer.style.display = "grid";
    }

    if (itemsToShow.length === 0) {
        folderContentContainer.innerHTML =
            '<p class="p-4 text-lg text-[var(--text-tertiary)] text-center">This folder is empty.</p>';
    } else {
        itemsToShow.forEach((item) => {
            const itemName = escapeJSString(item.name || item.title);
            const parentIdForPerms = String(item.parentIdActual === null || item.parentIdActual === "null" ? null : item.parentIdActual);

            if (item.itemType === "folder") {
                const card = document.createElement("div");
                card.classList.add("item-card");
                card.dataset.itemId = item.id;
                card.dataset.itemType = item.itemType;
                // Set card's main click handler
                card.onclick = () => navigateToFolder(item.id);


                const iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>`;
                
                const creatorNameFolder = escapeJSString(item.creator || "System");
                
                // Get effective updated At for folder
                const effectiveFolderUpdateTs = getFolderEffectiveUpdatedAt(item);
                const updatedAtFolderDisplay = effectiveFolderUpdateTs ? new Date(effectiveFolderUpdateTs).toLocaleDateString() : (item.createdAt ? new Date(item.createdAt).toLocaleDateString() : "N/A");


                let actionsDivContent = "";
                // Info button: Pass item.id and 'folder' type. event.stopPropagation() is called inside showItemInfoPopover.
                const infoButtonFolderHTML = `<button title="Show folder info" class="action-icon-btn info" onclick="showItemInfoPopover(event, '${String(item.id)}', 'folder')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></button>`;

                if (canDeleteNode(String(item.id)) && String(item.id) !== "null" && parentIdForPerms !== "null") {
                    actionsDivContent += `<button title="Delete folder" class="action-icon-btn delete" onclick="event.stopPropagation(); deleteNode('${String(item.id)}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                }
                actionsDivContent += infoButtonFolderHTML;

                let folderDescriptionHTML = "";
                if (item.description && typeof item.description === "string" && item.description.trim() !== "") {
                    folderDescriptionHTML = `<div class="item-card-description mt-1">${escapeJSString(item.description).replace(/\n/g, "<br>")}</div>`;
                } else {
                    folderDescriptionHTML = `<div class="item-card-description mt-1"><em>No description provided.</em></div>`;
                }

                card.innerHTML = `
                    <div>
                        <div class="item-card-icon-wrapper">
                            <span class="item-card-icon text-[var(--text-yellow-accent)]">${iconSVG}</span>
                        </div>
                        <h3 class="item-card-name">${itemName}</h3>
                        <div class="text-xs text-[var(--text-tertiary)] mt-1">
                            <span>Folder</span>
                            <span class="mx-1">&bull;</span>
                            <span>By: ${creatorNameFolder}</span>
                            <br/>
                            <span>Updated: ${updatedAtFolderDisplay}</span>
                        </div>
                        ${folderDescriptionHTML}
                    </div>
                    ${actionsDivContent ? `<div class="item-card-actions">${actionsDivContent}</div>` : ""}
                `;
                folderContentContainer.appendChild(card);

            } else { // Artifact rendering
                const listItem = document.createElement("div");
                // If in grid view (not list-view-only), artifact should also be a card
                if (!folderContentContainer.classList.contains("list-view-only")) {
                    listItem.classList.add("item-card"); // Make it look like a card
                } else {
                    listItem.classList.add("artifact-list-item");
                }
                listItem.dataset.itemId = String(item.id);

                const fileIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>`;
                
                const creatorNameArtifact = escapeJSString(item.creator || "System");
                const updatedAtArtifactDisplay = item.updatedAt ? new Date(item.updatedAt).toLocaleDateString() : "N/A";

                // Truncate description for the main visible part of the artifact card/item
                let truncatedDescription = "";
                if (item.description && typeof item.description === 'string' && item.description.trim() !== "") {
                    const fullDesc = escapeJSString(item.description);
                    const maxLength = 80; // Adjust as needed for card layout
                    truncatedDescription = fullDesc.length > maxLength ? fullDesc.substring(0, maxLength) + "..." : fullDesc;
                    truncatedDescription = truncatedDescription.replace(/\n/g, " "); // Keep it one-liner
                } else {
                    truncatedDescription = "<em>No description.</em>";
                }

                let artifactActionsHtml = "";
                 const infoButtonArtifactHTML = `<button title="Show file info" class="action-icon-btn info" onclick="showItemInfoPopover(event, '${String(item.id)}', 'artifact')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></button>`;


                if (canEditArtifactsInNode(parentIdForPerms)) {
                    artifactActionsHtml += `<button title="Delete file" class="action-icon-btn delete" onclick="event.stopPropagation(); deleteArtifact('${String(item.id)}', '${parentIdForPerms}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                }
                // Original modal button is fine to keep for quick full view of description/link
                artifactActionsHtml += `<button title="View details in modal" class="action-icon-btn" onclick="event.stopPropagation(); showArtifactDetailsModal('${escapeJSString(item.title)}', '${escapeJSString(item.description)}', '${escapeJSString(item.link)}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg></button>`;
                artifactActionsHtml += infoButtonArtifactHTML;


                let processedLink = item.link || "#";
                if (processedLink && !processedLink.startsWith("http://") && !processedLink.startsWith("https://") && processedLink !== "#") {
                    processedLink = `https://${processedLink}`;
                }
                const linkTarget = processedLink === "#" || !item.link ? "" : "target='_blank'";
                const linkRel = processedLink === "#" || !item.link ? "" : "rel='noopener noreferrer'";

                if (folderContentContainer.classList.contains("list-view-only")) {
                    // Horizontal List Item Layout
                    listItem.innerHTML = `
                        <div class="artifact-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.artifact-dropdown-arrow').classList.toggle('expanded');">
                            <span class="artifact-icon">${fileIconSVG}</span>
                            <div class="flex-grow">
                                <span class="artifact-title">${itemName}</span>
                                <p class="text-xs text-[var(--text-tertiary)] truncate-description">${truncatedDescription}</p>
                                <div class="text-xs text-[var(--text-tertiary)] mt-1">
                                    <span>By: ${creatorNameArtifact}</span>
                                    <span class="mx-1">&bull;</span>
                                    <span>Updated: ${updatedAtArtifactDisplay}</span>
                                </div>
                            </div>
                            <div class="artifact-actions">${artifactActionsHtml}</div>
                            <span class="artifact-dropdown-arrow"></span>
                        </div>
                        <div class="artifact-description" style="display:none;">
                             <p>${escapeJSString(item.description || "No full description.").replace(/\n/g,"<br>")}</p> {/* Full description here */}
                            ${item.link && item.link !== "#" ? `<a href="${processedLink}" ${linkTarget} ${linkRel} class="artifact-link submit-button primary !text-xs !py-1 !px-2 mt-2" onclick="event.stopPropagation();">Go to Resource <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>` : ""}
                        </div>
                    `;
                } else {
                    // Card Layout for Artifacts (when in a mixed grid)
                     // Add main click handler for the card to open the details modal
                    listItem.onclick = (e) => {
                        // Prevent modal if an action button was clicked
                        if (e.target.closest('.action-icon-btn')) return;
                        showArtifactDetailsModal(item.title, item.description, item.link);
                    };
                    listItem.innerHTML = `
                        <div>
                            <div class="item-card-icon-wrapper">
                                <span class="item-card-icon text-[var(--text-blue-accent)]">${fileIconSVG}</span>
                            </div>
                            <h3 class="item-card-name">${itemName}</h3>
                             <p class="item-card-description truncate-description">${truncatedDescription}</p>
                            <div class="text-xs text-[var(--text-tertiary)] mt-1">
                                <span>By: ${creatorNameArtifact}</span>
                                <span class="mx-1">&bull;</span>
                                <span>Updated: ${updatedAtArtifactDisplay}</span>
                            </div>
                        </div>
                        <div class="item-card-actions">
                           ${artifactActionsHtml}
                        </div>
                    `;
                }
                folderContentContainer.appendChild(listItem);
            }
        });
    }
    if (loadingPlaceholder) loadingPlaceholder.style.display = "none";
}

// --- Helper Function to get effective updatedAt for a folder ---
function getFolderEffectiveUpdatedAt(folderNode, processedFolderIds = new Set()) {
    // Prevent infinite loops in case of unexpected data structures (though a tree shouldn't have them)
    if (!folderNode || (folderNode.id !== null && processedFolderIds.has(folderNode.id))) {
        // For a re-encountered folder or null node, return null or its own createdAt if no children info.
        return folderNode && folderNode.createdAt ? new Date(folderNode.createdAt).getTime() : null;
    }
    if (folderNode.id !== null) {
      processedFolderIds.add(folderNode.id);
    }

    let maxUpdateTime = null;

    // 1. Check artifacts directly under this folder
    if (folderNode.artifacts && Array.isArray(folderNode.artifacts)) {
        folderNode.artifacts.forEach(artifact => {
            if (artifact.updatedAt) {
                const ts = new Date(artifact.updatedAt).getTime();
                if (!isNaN(ts) && (maxUpdateTime === null || ts > maxUpdateTime)) {
                    maxUpdateTime = ts;
                }
            }
        });
    }

    // 2. Recursively check children folders
    if (folderNode.children && Array.isArray(folderNode.children)) {
        folderNode.children.forEach(childFolder => {
            // We need to ensure childFolder is a complete node object if we expect .id, .artifacts etc.
            // Assuming childFolder objects in fullTreeData are structured correctly.
            const childNode = findNodeInTree(childFolder.id, fullTreeData); // Get full child node
            if (childNode) {
                const childMaxTime = getFolderEffectiveUpdatedAt(childNode, new Set(processedFolderIds)); // Pass a new Set copy to avoid interference between siblings
                if (childMaxTime !== null && (maxUpdateTime === null || childMaxTime > maxUpdateTime)) {
                    maxUpdateTime = childMaxTime;
                }
            }
        });
    }

    // 3. If no artifact updates found in the entire subtree, fallback to folder's own createdAt
    if (maxUpdateTime === null && folderNode.createdAt) {
        const folderCreatedTime = new Date(folderNode.createdAt).getTime();
        if(!isNaN(folderCreatedTime)) {
            maxUpdateTime = folderCreatedTime;
        }
    }
    
    return maxUpdateTime; // Returns a timestamp (number) or null
}
      // Add this function if escapeJSString is not already defined globally in your script,
// or ensure it's available in the scope where showItemInfoPopover is called.
// function escapeJSString(str) {
//     if (typeof str !== "string") return "";
//     return str
//         .replace(/&/g, "&amp;")
//         .replace(/</g, "&lt;")
//         .replace(/>/g, "&gt;")
//         .replace(/"/g, "&quot;")
//         .replace(/'/g, "&#39;")
//         .replace(/`/g, "&#96;");
// }

// --- Helper function to find item data from fullTreeData ---
function findItemDataForDisplay(itemIdToFind, itemType) {
    const idStr = String(itemIdToFind);

    function search(nodes) {
        for (const node of nodes) {
            if (itemType === 'folder' && String(node.id) === idStr) {
                return { ...node }; // Return a copy
            }
            if (node.artifacts && Array.isArray(node.artifacts)) {
                const artifact = node.artifacts.find(art => String(art.id) === idStr);
                if (artifact && itemType === 'artifact') {
                    // For artifacts, also include parent folder info for context if needed in popover
                    return { ...artifact, parentNodeId: node.id, parentNodeName: node.name };
                }
            }
            if (node.children && Array.isArray(node.children)) {
                const found = search(node.children);
                if (found) return found;
            }
        }
        return null;
    }
    return search(fullTreeData);
}


// --- MODIFIED showItemInfoPopover ---
function showItemInfoPopover(event, itemId, itemType) {
    if (event) { // Check if event is passed (it should be)
      event.stopPropagation(); // CRITICAL: Prevent card navigation
    } else {
      console.warn("showItemInfoPopover called without event object");
    }
    

    // Close any existing info popover
    if (currentInfoDropdown) {
        currentInfoDropdown.remove();
        currentInfoDropdown = null;
    }

    const item = findItemDataForDisplay(itemId, itemType);

    if (!item) {
        console.error(`Item with ID ${itemId} and type ${itemType} not found for popover.`);
        window.showNotification("Error: Could not load item details.", "error");
        return;
    }
    
    const popover = document.createElement('div');
    popover.className = 'info-popover absolute bg-[var(--bg-card)] border border-[var(--border-primary)] p-4 rounded-lg shadow-xl z-50 w-72';

    const safeName = escapeJSString(item.name || item.title || "N/A");
    const fullDescription = (item.description && typeof item.description === 'string' && item.description.trim() !== '')
        ? escapeJSString(item.description).replace(/\n/g, "<br>")
        : '<em class="text-[var(--text-tertiary)]">Not provided</em>';

    const creatorName = escapeJSString(item.creator || "System");
    const createdAtDate = item.createdAt ? new Date(item.createdAt).toLocaleString() : "N/A";
    
    let effectiveUpdatedAt = item.updatedAt; // For artifacts
    if (itemType === 'folder') {
        // For folders, calculate effective updatedAt if not directly present or to override
        const folderNodeForCalc = findNodeInTree(item.id, fullTreeData); // Get the full node for recursive calculation
        const derivedTs = folderNodeForCalc ? getFolderEffectiveUpdatedAt(folderNodeForCalc) : null;
        effectiveUpdatedAt = derivedTs ? new Date(derivedTs).toLocaleString() : (item.createdAt ? new Date(item.createdAt).toLocaleString() : "N/A");
    }
    const updatedAtDate = effectiveUpdatedAt ? new Date(effectiveUpdatedAt).toLocaleString() : "N/A";


    const displayId = escapeJSString(item.id || "N/A");
    const displayType = escapeJSString(itemType.charAt(0).toUpperCase() + itemType.slice(1));

    popover.innerHTML = `
        <div class="flex justify-between items-center mb-3 pb-2 border-b border-[var(--border-input)]">
            <h4 class="text-md font-semibold text-[var(--text-card-header)]">Item Information</h4>
            <button
                class="modal-close-btn !text-xl !p-0 hover:text-[var(--text-red-accent)]"
                onclick="this.closest('.info-popover').remove(); currentInfoDropdown = null;"
                title="Close info">
                &times;
            </button>
        </div>
        <div class="space-y-1.5 text-sm">
            <p><strong>ID:</strong> <span class="font-mono text-xs">${displayId}</span></p>
            <p><strong>Type:</strong> ${displayType}</p>
            <p class="break-words"><strong>Name:</strong> ${safeName}</p>
            <p class="break-words max-h-24 overflow-y-auto scrollbar-thin readme-text" style="font-size: 0.8rem; line-height: 1.5;"><strong>Description:</strong><br>${fullDescription}</p>
            <p><strong>Creator:</strong> ${creatorName}</p>
            <p><strong>Created:</strong> ${createdAtDate}</p>
            <p><strong>Updated:</strong> ${updatedAtDate}</p>
        </div>
    `;

    const triggerButton = event ? event.currentTarget : null;
    const cardElement = triggerButton ? triggerButton.closest('.item-card, .artifact-list-item, .search-result-card') : null;

    if (cardElement && triggerButton) {
        if (getComputedStyle(cardElement).position === 'static') {
             cardElement.style.position = 'relative';
        }
        cardElement.appendChild(popover);

        const buttonRect = triggerButton.getBoundingClientRect();
        const cardRect = cardElement.getBoundingClientRect();
        // Get popover dimensions AFTER appending and making it visible (even if briefly)
        // For robust dimension calculation, ensure it's not display:none when measuring
        popover.style.visibility = 'hidden'; // Keep in layout flow but invisible for measurement
        document.body.appendChild(popover); // Temporarily append to body for accurate measurement if card is complex
        const popoverRect = popover.getBoundingClientRect();
        cardElement.appendChild(popover); // Move it back
        popover.style.visibility = 'visible';


        let top = (buttonRect.top - cardRect.top) + buttonRect.height + 5;
        let left = (buttonRect.left - cardRect.top);

        if (left + popoverRect.width > cardRect.width - 10) {
            left = cardRect.width - popoverRect.width - 10;
        }
        if (left < 10) {
            left = 10;
        }
        if (top + popoverRect.height > cardRect.height - 10 && (buttonRect.top - cardRect.top) > popoverRect.height + 5) {
            top = (buttonRect.top - cardRect.top) - popoverRect.height - 5;
        }
        if (top < 0) top = 5;

        popover.style.top = `${top}px`;
        popover.style.left = `${left}px`;
    } else {
        document.body.appendChild(popover);
        popover.style.position = 'fixed';
        popover.style.top = event ? `${event.clientY + 10}px` : '50%';
        popover.style.left = event ? `${event.clientX + 10}px` : '50%';
        if (!event) popover.style.transform = 'translate(-50%, -50%)';
         console.warn("Popover fallback positioning used.");
    }
    currentInfoDropdown = popover;
}
      // --- End Navigation and Rendering ---

      // --- Node Graph Visualization ---
      async function displayNodeGraph(nodeId) {
        const graphSection = document.getElementById("node-graph-section");
        const graphContainer = document.getElementById(
          "node-graph-visualization"
        );
        const graphLoadingPlaceholder =
          document.getElementById("node-graph-loading");
        const graphErrorPlaceholder =
          document.getElementById("node-graph-error");

        if (
          !graphSection ||
          !graphContainer ||
          !graphLoadingPlaceholder ||
          !graphErrorPlaceholder
        ) {
          console.error("Graph display elements not found.");
          return;
        }

        graphErrorPlaceholder.style.display = "none"; // Clear previous errors
        graphContainer.innerHTML = ""; // Clear previous graph
        graphLoadingPlaceholder.style.display = "flex"; // Show loading
        graphSection.style.display = "block"; // Show graph section

        try {
          const response = await secureFetch(
            `${BASE_API_URL}/api/nodes/${nodeId}/graph`
          );
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({
              detail: `Failed to load graph (Status: ${response.status})`,
            }));
            throw new Error(errorData.detail);
          }
          const rawApiGraphData = await response.json();

          // Check if the central node data is actually returned
          if (!rawApiGraphData || typeof rawApiGraphData.id === "undefined") {
            graphErrorPlaceholder.textContent =
              "No graph data available for this node or the folder is empty.";
            graphErrorPlaceholder.style.display = "block";
            graphLoadingPlaceholder.style.display = "none";
            graphContainer.innerHTML = ""; // Ensure container is empty
            return;
          }
          renderD3TreeGraph(rawApiGraphData, graphContainer, String(nodeId));
          graphLoadingPlaceholder.style.display = "none"; // Hide loading
        } catch (error) {
          console.error("Error fetching or rendering node graph:", error);
          graphErrorPlaceholder.textContent = `Error loading graph: ${error.message}`;
          graphErrorPlaceholder.style.display = "block";
          graphLoadingPlaceholder.style.display = "none";
          graphContainer.innerHTML = ""; // Ensure container is empty on error
        }
      }

      function hideNodeGraph() {
        const graphSection = document.getElementById("node-graph-section");
        if (graphSection) graphSection.style.display = "none";
        const graphContainer = document.getElementById(
          "node-graph-visualization"
        );
        if (graphContainer) graphContainer.innerHTML = ""; // Clear SVG content
      }

      function renderD3TreeGraph(
        apiNodeData,
        containerElement,
        centerNodeOriginalIdStr
      ) {
        containerElement.innerHTML = ""; // Clear previous graph
        const centerNodeOriginalId = parseInt(centerNodeOriginalIdStr);

        const containerRect = containerElement.getBoundingClientRect();
        const width = containerRect.width || 800; // Fallback width
        const height = containerRect.height || 500; // Fallback height

        const svg = d3
          .select(containerElement)
          .append("svg")
          .attr("width", "100%")
          .attr("height", "100%")
          .attr("viewBox", `0 0 ${width} ${height}`) // Use viewBox for responsiveness
          .attr("preserveAspectRatio", "xMidYMid meet");

        const mainGroup = svg.append("g"); // Group for zoom/pan

        // Helper to get children, combining sub-folders and artifacts
        const getChildren = (d) => {
          let combinedChildren = [];
          if (d.children && Array.isArray(d.children)) {
            // Map to ensure new objects for hierarchy, preventing modification of original data
            combinedChildren = combinedChildren.concat(
              d.children.map((child) => ({ ...child }))
            );
          }
          if (d.artifacts && Array.isArray(d.artifacts)) {
            const mappedArtifacts = d.artifacts.map((artifact) => ({
              ...artifact,
              name: artifact.title, // Use title as name for artifacts in graph
              type: artifact.type || "FILE", // Ensure type for artifacts
              children: [], // Artifacts are leaf nodes
            }));
            combinedChildren = combinedChildren.concat(mappedArtifacts);
          }
          return combinedChildren.length ? combinedChildren : null; // d3.hierarchy expects null for no children
        };

        const root = d3.hierarchy(apiNodeData, getChildren);

        // Assign displayType for styling if not already present
        root.each((d) => {
          const type = d.data.type || "UNKNOWN"; // Fallback type
          d.data.displayType =
            type === "FILE" || type === "ARTIFACT" ? "ARTIFACT" : "FOLDER";
        });

        const nodeHeight = 35;
        const nodeWidth = 200;
        const treeLayout = d3.tree().nodeSize([nodeHeight, nodeWidth]); // Vertical and horizontal spacing
        treeLayout(root);

        // Calculate initial translation to center the root node, considering tree's natural layout
        let x0 = Infinity;
        let x1 = -Infinity;
        root.each((d) => {
          // Find extent of x coordinates (which become y in horizontal tree)
          if (d.x < x0) x0 = d.x;
          if (d.x > x1) x1 = d.x;
        });

        const initialX = 50; // Margin from the left
        const initialY = height / 2 - root.x; // Center vertically; root.x is its y-position in horizontal

        // Set initial transform for zoom
        const initialTransform = d3.zoomIdentity
          .translate(initialX, initialY)
          .scale(0.9);

        // Draw links
        mainGroup
          .append("g")
          .attr("class", "graph-links")
          .selectAll("path")
          .data(root.links())
          .join("path")
          .attr("class", "graph-link")
          .attr(
            "d",
            d3
              .linkHorizontal() // Use horizontal link generator
              .x((d) => d.y) // Source and target y become x
              .y((d) => d.x)
          ); // Source and target x become y

        // Draw nodes
        const node = mainGroup
          .append("g")
          .attr("class", "graph-nodes")
          .selectAll("g")
          .data(root.descendants())
          .join("g")
          .attr(
            "class",
            (d) =>
              `graph-node ${
                d.data.id === centerNodeOriginalId &&
                d.data.displayType === "FOLDER"
                  ? "is-center"
                  : ""
              }`
          )
          .attr("transform", (d) => `translate(${d.y},${d.x})`); // y becomes x, x becomes y

        node
          .append("circle")
          .attr("r", (d) =>
            d.data.id === centerNodeOriginalId &&
            d.data.displayType === "FOLDER"
              ? 10
              : d.data.displayType === "FOLDER"
              ? 8
              : 6
          )
          .attr("fill", (d) => {
            if (
              d.data.id === centerNodeOriginalId &&
              d.data.displayType === "FOLDER"
            )
              return "var(--text-link-hover)";
            if (d.data.displayType === "FOLDER")
              return "var(--text-yellow-accent)";
            if (d.data.displayType === "ARTIFACT")
              return "var(--text-green-accent)";
            return "var(--text-secondary)"; // Fallback
          })
          .attr("stroke", (d) =>
            d.data.id === centerNodeOriginalId &&
            d.data.displayType === "FOLDER"
              ? "var(--text-link)"
              : "var(--border-card)"
          );

        node
          .append("text")
          .attr("dy", "0.31em") // Vertical alignment
          .attr("x", (d) => {
            // Position text left or right of node based on children
            const effectiveChildren = getChildren(d.data);
            return effectiveChildren && effectiveChildren.length > 0 ? -12 : 12; // -12 for parent, +12 for leaf
          })
          .attr("text-anchor", (d) => {
            const effectiveChildren = getChildren(d.data);
            return effectiveChildren && effectiveChildren.length > 0
              ? "end"
              : "start";
          })
          .text((d) => d.data.name)
          .clone(true)
          .lower() // Create a "halo" for text readability
          .attr("stroke-linejoin", "round")
          .attr("stroke-width", 3)
          .attr("stroke", "var(--bg-primary)"); // Halo color matching background

        node
          .append("title") // Tooltip on hover
          .text(
            (d) =>
              `${d.data.displayType}: ${d.data.name}\nID: ${
                d.data.id
              }\nDescription: ${d.data.description || "N/A"}`
          );

        // Setup zoom and pan
        const zoom = d3
          .zoom()
          .scaleExtent([0.1, 5]) // Min/max zoom scale
          .on("zoom", (event) => {
            mainGroup.attr("transform", event.transform);
          });

        svg.call(zoom).call(zoom.transform, initialTransform); // Apply initial transform
      }

      // --- End Node Graph Visualization ---

      // --- Current Folder Overview Display ---
      function displayCurrentFolderOverview(folderObject) {
        const OVERVIEW_CONTAINER_ID = "current-folder-overview-container";
        const existingOverview = document.getElementById(OVERVIEW_CONTAINER_ID);
        if (existingOverview) {
          existingOverview.remove(); // Clear previous overview
        }

        // Only display if the folderObject exists and has a non-empty description
        if (
          folderObject &&
          folderObject.description &&
          typeof folderObject.description === "string" &&
          folderObject.description.trim() !== ""
        ) {
          const overviewContainer = document.createElement("div");
          overviewContainer.id = OVERVIEW_CONTAINER_ID;
          // Styles are applied via CSS using the ID

          overviewContainer.innerHTML = `
                <p class="readme-text">${escapeJSString(
                  folderObject.description
                ).replace(/\n/g, "<br>")}</p>
            `;

          const currentFolderHeader = document.getElementById(
            "current-folder-header"
          );
          if (currentFolderHeader && currentFolderHeader.parentNode) {
            // Insert the overview container AFTER the current-folder-header div
            currentFolderHeader.parentNode.insertBefore(
              overviewContainer,
              currentFolderHeader.nextSibling
            );
          } else {
            console.warn(
              "Could not find current-folder-header to insert overview."
            );
          }
        }
      }
      // --- End Current Folder Overview Display ---

      function customSortItems(a, b) {
        const aIsFolder = a.itemType === "folder";
        const bIsFolder = b.itemType === "folder";

        // Folders first
        if (aIsFolder && !bIsFolder) return -1;
        if (!aIsFolder && bIsFolder) return 1;

        // Then sort by name (or title for artifacts)
        const nameA = (a.name || a.title || "").toString();
        const nameB = (b.name || b.title || "").toString();

        // Simple numeric prefix sort (e.g., "1. Topic", "10. Another Topic")
        const numRegex = /^(\d+)/;
        const matchA = nameA.match(numRegex);
        const matchB = nameB.match(numRegex);

        const numA = matchA ? parseInt(matchA[1], 10) : null;
        const numB = matchB ? parseInt(matchB[1], 10) : null;

        if (numA !== null && numB !== null) {
          // Both have numeric prefixes
          if (numA !== numB) return numA - numB;
          // If numbers are the same, sort by the rest of the string
          const restA = nameA.substring(matchA[1].length).trim().toLowerCase();
          const restB = nameB.substring(matchB[1].length).trim().toLowerCase();
          return restA.localeCompare(restB);
        }
        if (numA !== null && numB === null) return -1; // Items with num prefix first
        if (numA === null && numB !== null) return 1;

        // Default: alphabetical sort
        return nameA.toLowerCase().localeCompare(nameB.toLowerCase());
      }

      // --- Inline Add Item Form Logic ---
      function toggleAddItemForm(show) {
        if (
          show &&
          currentViewNodeId !== null &&
          String(currentViewNodeId) !== "null" // Ensure it's not the conceptual root
        ) {
          populateAddItemForm();
          if (addItemFormContainer)
            addItemFormContainer.style.display = "block";
          if (document.getElementById("addItemName"))
            // Focus on the first input
            document.getElementById("addItemName").focus();
        } else {
          if (addItemFormContainer) addItemFormContainer.style.display = "none";
        }
      }
      function populateAddItemForm() {
        const parentId = currentViewNodeId;
        // Prevent adding to the absolute root if 'null' represents it and it's disallowed
        if (parentId === null || String(parentId) === "null") {
          if (addItemFormContainer)
            addItemFormContainer.innerHTML =
              '<p class="text-[var(--text-tertiary)]">Adding items to the main Knowledge Base root is not supported here. Please select or create a folder.</p>';
          return;
        }
        const currentFolder = findNodeInTree(String(parentId), fullTreeData);
        const currentFolderName = currentFolder
          ? currentFolder.name
          : "Selected Folder";

        if (addItemFormContainer)
          addItemFormContainer.innerHTML = `
            <h3 class="text-xl font-semibold mb-4 text-[var(--text-primary)]">Add to '${escapeJSString(
              currentFolderName
            )}'</h3>
            <form onsubmit="event.preventDefault(); submitAddItemForm(this.querySelector('button[type=submit]'))">
                <input type="hidden" id="addItemParentId" value="${parentId}">
                <div class="mb-4"><label for="addItemName" class="label-text">Name (Folder/File)</label><input type="text" id="addItemName" class="input-field text-sm" required></div>
                <div class="mb-4"><label for="addItemType" class="label-text">Type</label><select id="addItemType" class="input-field text-sm" onchange="toggleAddItemFileOptions()"><option value="SUBFOLDER">Subfolder</option><option value="FILE">File</option></select></div>
                <div class="mb-4"><label for="addItemDescription" class="label-text">Description (Optional)</label><textarea id="addItemDescription" class="input-field text-sm" rows="2"></textarea></div>
                <div id="addItemFileMethodOptions" style="display:none;" class="mt-2 mb-4">
                    <div><label for="addItemFileSource" class="label-text text-xs">File Source:</label><select id="addItemFileSource" class="input-field text-xs py-1" onchange="toggleAddItemLinkOrUpload()"><option value="link">Enter Link</option><option value="upload">Upload File</option></select></div>
                    <div id="addItemLinkInputContainer" class="mt-2"><input type="url" placeholder="Link (e.g., https://...)" id="addItemLink" class="input-field text-sm"></div>
                    <div id="addItemUploadInputContainer" style="display:none;" class="mt-2"><input type="file" id="addItemFileUpload" class="input-field text-sm p-2"></div>
                </div>
                <div class="mt-6 flex items-center gap-3">
                    <button type="submit" class="submit-button primary">
                        <span class="button-text">Add Item</span>
                    </button>
                    <button type="button" class="submit-button secondary" onclick="toggleAddItemForm(false)">
                        <span class="button-text">Cancel</span>
                    </button>
                </div>
            </form>`;
        toggleAddItemFileOptions(); // Initialize based on default selection
      }
      function toggleAddItemFileOptions() {
        const typeSelect = document.getElementById("addItemType");
        const fileMethodOptionsDiv = document.getElementById(
          "addItemFileMethodOptions"
        );
        if (!typeSelect || !fileMethodOptionsDiv) return;

        if (typeSelect.value === "FILE") {
          fileMethodOptionsDiv.style.display = "block";
          const fileSourceSelect = document.getElementById("addItemFileSource");
          if (fileSourceSelect) fileSourceSelect.value = "link"; // Default to link
          toggleAddItemLinkOrUpload();
        } else {
          fileMethodOptionsDiv.style.display = "none";
        }
      }
      function toggleAddItemLinkOrUpload() {
        const fileSourceSelect = document.getElementById("addItemFileSource");
        const linkContainer = document.getElementById(
          "addItemLinkInputContainer"
        );
        const uploadContainer = document.getElementById(
          "addItemUploadInputContainer"
        );
        if (!fileSourceSelect || !linkContainer || !uploadContainer) return;

        const fileSource = fileSourceSelect.value;
        linkContainer.style.display = fileSource === "link" ? "block" : "none";
        uploadContainer.style.display =
          fileSource === "upload" ? "block" : "none";
        // Clear the other input when switching
        if (
          fileSource === "link" &&
          document.getElementById("addItemFileUpload")
        )
          document.getElementById("addItemFileUpload").value = "";
        if (fileSource === "upload" && document.getElementById("addItemLink"))
          document.getElementById("addItemLink").value = "";
      }

      async function submitAddItemForm(buttonElement) {
        const parentIdValue = document.getElementById("addItemParentId").value;
        const parentId =
          parentIdValue === "null" ||
          parentIdValue === null ||
          parentIdValue === ""
            ? null
            : parseInt(parentIdValue);

        const name = document.getElementById("addItemName").value.trim();
        const type = document.getElementById("addItemType").value;
        const description = document
          .getElementById("addItemDescription")
          .value.trim();

        const originalButtonText =
          buttonElement.querySelector(".button-text")?.textContent ||
          buttonElement.textContent;
        window.setButtonLoading(buttonElement, true, originalButtonText);

        if (!name) {
          window.showNotification("Name is required.", "error");
          window.setButtonLoading(buttonElement, false, originalButtonText);
          document.getElementById("addItemName")?.focus();
          return;
        }
        if (parentId === null) {
          // Should be caught by populateAddItemForm, but good safeguard
          window.showNotification(
            "Cannot add item: A valid parent folder must be selected.",
            "error"
          );
          window.setButtonLoading(buttonElement, false, originalButtonText);
          return;
        }

        try {
          let response;
          let endpoint;
          let options = { method: "POST" };
          let bodyPayload;

          if (type === "FILE") {
            const fileSource =
              document.getElementById("addItemFileSource").value;
            let commonPayload = { title: name, description, nodeId: parentId };

            if (fileSource === "link") {
              const link = document.getElementById("addItemLink").value.trim();
              if (!link || !link.startsWith("http"))
                throw new Error(
                  "A valid Link (starting with http/https) is required for file type 'link'."
                );
              commonPayload.link = link;
              endpoint = `${BASE_API_URL}/api/artifacts`;
              bodyPayload = JSON.stringify(commonPayload);
              options.body = bodyPayload;
            } else {
              // upload
              const fileInput = document.getElementById("addItemFileUpload");
              const file = fileInput.files[0];
              if (!file) throw new Error("Please select a file to upload.");
              const formData = new FormData();
              formData.append("file", file);
              formData.append("title", name);
              formData.append("description", description);
              formData.append("nodeId", String(parentId)); // Ensure nodeId is string for FormData
              endpoint = `${BASE_API_URL}/api/upload`;
              options.body = formData; // Content-Type will be set by browser for FormData
            }
          } else {
            // SUBFOLDER
            bodyPayload = JSON.stringify({
              name,
              type: "FOLDER", // Explicitly set type for backend
              parentId: parentId,
              description,
            });
            endpoint = `${BASE_API_URL}/api/nodes`;
            options.body = bodyPayload;
          }

          response = await secureFetch(endpoint, options);

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({
              // Fallback if JSON parsing fails
              detail: `Request failed with status ${response.status}. ${response.statusText}`,
            }));
            throw new Error(
              errorData.detail ||
                `Failed to add item (Status: ${response.status})`
            );
          }
          window.showNotification("Item added successfully! ", "success");
          toggleAddItemForm(false); // Hide form
          const formElement = document.getElementById("addItemName")?.form;
          if (formElement) formElement.reset(); // Reset form fields
          toggleAddItemFileOptions(); // Reset file options display
          await fetchTreeDataOnly(); // Refresh tree data
          navigateToFolder(currentViewNodeId); // Re-render current folder
        } catch (error) {
          console.error("User Page: Error submitting add item form:", error);
          window.showNotification(`Error: ${error.message}`, "error", 5000);
        } finally {
          window.setButtonLoading(buttonElement, false, originalButtonText);
        }
      }
      // --- End Inline Add Item Form Logic ---

      // --- CRUD Operations (Delete) ---
      async function deleteNode(nodeId) {
        if (
          !confirm(
            "Are you sure you want to delete this folder and all its contents? This action cannot be undone."
          )
        )
          return;
        try {
          const response = await secureFetch(
            `${BASE_API_URL}/api/nodes/${nodeId}`,
            { method: "DELETE" }
          );
          if (!response.ok) {
            const errorData = await response
              .json()
              .catch(() => ({ detail: response.statusText })); // Fallback error
            throw new Error(errorData.detail || "Failed to delete folder.");
          }
          window.showNotification("Folder deleted successfully. ", "success");

          // Determine where to navigate after deletion
          let parentToNavigateTo = null;
          const pathIndex = currentPath.findIndex(
            (p) => String(p.id) === String(nodeId)
          );
          if (pathIndex > 0) {
            // If deleted node was in current path and not root
            parentToNavigateTo = currentPath[pathIndex - 1].id;
          } else if (String(currentViewNodeId) === String(nodeId)) {
            // If deleted node was the one being viewed
            // Navigate to its parent, or root if it was a top-level folder
            parentToNavigateTo =
              currentPath.length > 1
                ? currentPath[currentPath.length - 2].id
                : null;
          } else {
            // Fallback, stay in current view if deleted node was not directly related to current path
            parentToNavigateTo = currentViewNodeId;
          }

          await fetchTreeDataOnly(); // Refresh tree data
          navigateToFolder(parentToNavigateTo); // Navigate to appropriate folder
        } catch (error) {
          console.error("User Page: Error deleting node:", error);
          window.showNotification(`Error: ${error.message}`, "error");
        }
      }
      async function deleteArtifact(artifactId, parentNodeIdString) {
        if (
          !confirm(
            "Are you sure you want to delete this file? This action cannot be undone."
          )
        )
          return;
        try {
          const response = await secureFetch(
            `${BASE_API_URL}/api/artifacts/${artifactId}`,
            { method: "DELETE" }
          );
          if (!response.ok) {
            const errorData = await response
              .json()
              .catch(() => ({ detail: response.statusText }));
            throw new Error(errorData.detail || "Failed to delete file.");
          }
          window.showNotification("File deleted successfully. ", "success");
          await fetchTreeDataOnly(); // Refresh data
          navigateToFolder(currentViewNodeId); // Re-render current folder
        } catch (error) {
          console.error("User Page: Error deleting artifact:", error);
          window.showNotification(`Error: ${error.message}`, "error");
        }
      }
      // --- End CRUD Operations ---

      // --- Modals & UI Toggles ---
      function showArtifactDetailsModal(title, description, link) {
        const modal = document.getElementById("artifact-details-modal");
        if (!modal) return;
        const titleEl = document.getElementById("artifact-modal-title");
        const descEl = document.getElementById(
          "artifact-details-modal-description"
        );
        const linkEl = document.getElementById("artifact-modal-link");

        if (titleEl) titleEl.textContent = title || "Artifact Details";
        if (descEl)
          descEl.innerHTML =
            description &&
            typeof description === "string" &&
            description.trim() !== ""
              ? escapeJSString(description).replace(/\n/g, "<br>")
              : "<em>No description provided.</em>";

        let processedLink = link || "#";
        if (
          // Ensure link is absolute or #
          processedLink &&
          !processedLink.startsWith("http://") &&
          !processedLink.startsWith("https://") &&
          processedLink !== "#"
        ) {
          processedLink = `https://${processedLink}`; // Default to https if protocol missing
        }
        if (linkEl) linkEl.href = processedLink;

        if (linkEl) {
          // Enable/disable link button
          if (!link || link === "#") {
            linkEl.classList.add("opacity-50", "cursor-not-allowed");
            linkEl.removeAttribute("target"); // Remove target if no link
            linkEl.onclick = (e) => e.preventDefault(); // Prevent action
            linkEl.title = "No link provided";
          } else {
            linkEl.classList.remove("opacity-50", "cursor-not-allowed");
            linkEl.setAttribute("target", "_blank"); // Open in new tab
            linkEl.onclick = null; // Restore default behavior
            linkEl.title = `Go to: ${processedLink}`;
          }
        }
        modal.classList.add("active");
      }
      function closeArtifactDetailsModal() {
        const modal = document.getElementById("artifact-details-modal");
        if (modal) modal.classList.remove("active");
      }

      const themeToggleButton = document.getElementById("theme-toggle-button");
      const sunIconHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
      const moonIconHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;

      // Ensure these point to your actual logo URLs if they are different for themes
      const USER_PAGE_LIGHT_MODE_LOGO =
        "https://niveussolutions.com/wp-content/uploads/2025/02/Niveus-ntt-data.png";
      const USER_PAGE_DARK_MODE_LOGO =
        "https://gitlab.niveussolutions.com/uploads/-/system/appearance/header_logo/1/Nivues_log.png"; // Example dark mode logo

      const userPageLogoElement = document.getElementById("user-page-logo");

      function applyTheme(theme) {
        if (!userPageLogoElement) return; // Guard if logo element not found

        if (theme === "light") {
          document.body.classList.add("light-theme");
          if (themeToggleButton) themeToggleButton.innerHTML = moonIconHTML;
          userPageLogoElement.src = USER_PAGE_LIGHT_MODE_LOGO;
          localStorage.setItem("userPageTheme", "light");
        } else {
          // Default to dark
          document.body.classList.remove("light-theme");
          if (themeToggleButton) themeToggleButton.innerHTML = sunIconHTML;
          userPageLogoElement.src = USER_PAGE_DARK_MODE_LOGO;
          localStorage.setItem("userPageTheme", "dark");
        }
      }
      if (themeToggleButton) {
        themeToggleButton.addEventListener("click", () => {
          applyTheme(
            document.body.classList.contains("light-theme") ? "dark" : "light"
          );
        });
        // Apply initial theme based on localStorage or system preference (defaulting to dark)
        applyTheme(
          localStorage.getItem("userPageTheme") ||
            (window.matchMedia("(prefers-color-scheme: dark)").matches
              ? "dark"
              : "dark") // Default to dark if no preference or local storage
        );
      }

      if (userMenuButton && userDropdownMenu) {
        userMenuButton.addEventListener("click", (event) => {
          event.stopPropagation(); // Prevent click from bubbling to document
          const isExpanded =
            userMenuButton.getAttribute("aria-expanded") === "true";
          userMenuButton.setAttribute("aria-expanded", String(!isExpanded));
          userDropdownMenu.classList.toggle("hidden");
        });
        // Close dropdown if clicked outside
        document.addEventListener("click", (event) => {
          if (
            userDropdownMenu &&
            !userDropdownMenu.classList.contains("hidden") &&
            userMenuButton &&
            !userMenuButton.contains(event.target) && // Click was not on the button
            !userDropdownMenu.contains(event.target) // Click was not inside the dropdown
          ) {
            userDropdownMenu.classList.add("hidden");
            userMenuButton.setAttribute("aria-expanded", "false");
          }
        });
      }
      if (logoutButtonDropdown && firebaseAuth) {
        logoutButtonDropdown.addEventListener("click", async () => {
          try {
            await firebaseAuth.signOut();
            sessionStorage.removeItem("userToken"); // Clear token
            window.showNotification("Logged out successfully.", "success");
            // Redirect is handled by onAuthStateChanged
          } catch (error) {
            console.error("User Page: Error signing out:", error);
            window.showNotification(
              "Logout failed. Please try again.",
              "error"
            );
          }
        });
      }
      // --- End Modals & UI Toggles ---

      // --- Search Functionality ---
      let searchResults = []; // Holds current search results

      function highlightText(text, query) {
        if (!query || typeof text !== "string")
          return escapeJSString(text || ""); // Return escaped original if no query or not string
        const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // Escape regex special chars
        const regex = new RegExp(`(${safeQuery})`, "gi"); // Case-insensitive, global
        return escapeJSString(text).replace(
          regex,
          '<span class="highlight">$1</span>' // Wrap match in highlight span
        );
      }

      const debouncedPerformGlobalSearch = debounce(performGlobalSearch, 350); // Debounce search input

      if (searchInputElement) {
        searchInputElement.addEventListener("input", (e) => {
          debouncedPerformGlobalSearch(e.target.value);
        });
      }

      function performGlobalSearch(term) {
        searchResults = []; // Clear previous results
        const searchTerm = term.trim().toLowerCase();
        if (!searchTerm) {
          // If search is cleared, revert to folder view
          isSearchViewActive = false;
          navigateToFolder(currentViewNodeId); // Re-render current folder (which will show its overview)
          return;
        }
        isSearchViewActive = true;
        hideNodeGraph(); // Hide graph in search view
        const overviewContainer = document.getElementById(
          "current-folder-overview-container"
        ); // Hide main folder overview in search
        if (overviewContainer) overviewContainer.remove();

        function recurseSearch(nodes, pathStack) {
          for (const node of nodes) {
            if (!node) continue; // Skip if node is null/undefined
            const currentItemPath = [
              ...pathStack,
              { id: node.id, name: node.name },
            ];

            let folderMatchedByName = false;
            // Match folder name
            if (node.name && node.name.toLowerCase().includes(searchTerm)) {
              searchResults.push({
                item: node,
                path: currentItemPath,
                itemType: "folder",
                matchSource: "name",
              });
              folderMatchedByName = true;
            }

            // Match folder description
            if (
              node.description &&
              typeof node.description === "string" &&
              node.description.toLowerCase().includes(searchTerm)
            ) {
              const existingEntryIndex = searchResults.findIndex(
                (sr) => sr.item.id === node.id && sr.itemType === "folder"
              );

              if (existingEntryIndex === -1) {
                // If not already added (e.g., by name match)
                searchResults.push({
                  item: node,
                  path: currentItemPath,
                  itemType: "folder",
                  matchSource: "description",
                });
              } else if (folderMatchedByName) {
                // If already added for name, update matchSource if description also matches
                if (searchResults[existingEntryIndex].matchSource === "name") {
                  searchResults[existingEntryIndex].matchSource =
                    "name, description";
                } else if (
                  !searchResults[existingEntryIndex].matchSource.includes(
                    "description"
                  )
                ) {
                  // If it was matched by something else (less likely for folder) and now description too
                  searchResults[existingEntryIndex].matchSource +=
                    ", description";
                }
              }
            }

            // Match artifacts within the folder
            if (node.artifacts && Array.isArray(node.artifacts)) {
              for (const artifact of node.artifacts) {
                if (!artifact) continue;
                let artifactAlreadyAdded = searchResults.some(
                  (
                    sr // Check if this artifact ID is already in results
                  ) => sr.item.id === artifact.id && sr.itemType === "artifact"
                );

                // Match artifact title
                if (
                  artifact.title &&
                  artifact.title.toLowerCase().includes(searchTerm) &&
                  !artifactAlreadyAdded // Add only if not already present
                ) {
                  searchResults.push({
                    item: artifact,
                    path: currentItemPath, // Path to parent folder
                    itemType: "artifact",
                    matchSource: "title",
                  });
                  artifactAlreadyAdded = true; // Mark as added to prevent duplicate from description match
                }
                // Match artifact description (only if not already added by title)
                if (
                  artifact.description &&
                  typeof artifact.description === "string" &&
                  artifact.description.toLowerCase().includes(searchTerm) &&
                  !artifactAlreadyAdded
                ) {
                  searchResults.push({
                    item: artifact,
                    path: currentItemPath,
                    itemType: "artifact",
                    matchSource: "description",
                  });
                }
              }
            }
            // Recurse into subfolders
            if (node.children && Array.isArray(node.children)) {
              recurseSearch(node.children, currentItemPath);
            }
          }
        }
        recurseSearch(fullTreeData, [{ id: null, name: "Knowledge Base" }]); // Start search from root
        renderSearchResults(searchResults, searchTerm);
      }

      function renderSearchResults(results, searchTerm = "") {
    if (!folderContentContainer) return;

    const overviewElem = document.getElementById("current-folder-overview-container");
    if (overviewElem) overviewElem.remove();

    folderContentContainer.innerHTML = "";
    toggleAddItemForm(false);
    if (backButton) backButton.style.display = "none";
    if (addItemToFolderBtn) addItemToFolderBtn.style.display = "none";

    const resultsTitle = results.length > 0 ? `Search Results for "${escapeJSString(searchTerm)}"` : `No Results for "${escapeJSString(searchTerm)}"`;
    if (currentFolderNameEl) currentFolderNameEl.textContent = resultsTitle;
    if (breadcrumbContainer) breadcrumbContainer.innerHTML = `<span class="breadcrumb-current">Search Results</span>`;

    if (results.length === 0) {
        folderContentContainer.innerHTML = `<p class="p-4 text-lg text-[var(--text-tertiary)] text-center">No items found matching your search.</p>`;
        return;
    }

    folderContentContainer.classList.remove("list-view-only");
    folderContentContainer.style.display = "grid";


    results.forEach((result) => {
        const card = document.createElement("div");
        card.classList.add("search-result-card", "item-card");

        const itemName = result.item.name || result.item.title;
        const itemTypeDisplay = result.itemType.charAt(0).toUpperCase() + result.itemType.slice(1);
        let displayPathString = result.path.map((p) => p.name).join(" > ");

        const iconClass = result.itemType === "folder" ? "text-[var(--text-yellow-accent)]" : "text-[var(--text-blue-accent)]";
        const iconSVG = result.itemType === "folder"
            ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>`
            : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>`;

        let descriptionHTML = "";
        if (result.item.description && typeof result.item.description === "string" && result.item.description.trim() !== "") {
            descriptionHTML = `<p class="item-card-description search-result-description">${highlightText(result.item.description, searchTerm)}</p>`;
        } else {
            descriptionHTML = `<p class="item-card-description search-result-description"><em>No description provided.</em></p>`;
        }

        const creatorNameSearch = escapeJSString(result.item.creator || "System");
        let updatedAtSearchDisplay = "N/A";
        if (result.itemType === 'folder') {
            const folderNodeForCalc = findNodeInTree(result.item.id, fullTreeData);
            const derivedTs = folderNodeForCalc ? getFolderEffectiveUpdatedAt(folderNodeForCalc) : null;
            updatedAtSearchDisplay = derivedTs ? new Date(derivedTs).toLocaleDateString() : (result.item.createdAt ? new Date(result.item.createdAt).toLocaleDateString() : "N/A");
        } else { // artifact
            updatedAtSearchDisplay = result.item.updatedAt ? new Date(result.item.updatedAt).toLocaleDateString() : "N/A";
        }


        const infoButtonSearchHTML = `<button title="Show info" class="action-icon-btn info" onclick="showItemInfoPopover(event, '${String(result.item.id)}', '${result.itemType}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></button>`;

        card.innerHTML = `
            <div>
                <div class="item-card-icon-wrapper"><span class="search-result-icon ${iconClass}">${iconSVG}</span></div>
                <h3 class="item-card-name search-result-name">${highlightText(itemName,searchTerm)}</h3>
                <div class="text-xs text-[var(--text-tertiary)] mt-1">
                    <span>${itemTypeDisplay}</span>
                    <span class="mx-1">&bull;</span>
                    <span>By: ${creatorNameSearch}</span>
                    <br/>
                    <span>Updated: ${updatedAtSearchDisplay}</span>
                </div>
                ${descriptionHTML}
                <p class="search-result-path text-xs mt-1">In: ${escapeJSString(displayPathString)}</p>
            </div>
            <div class="item-card-actions">
                ${infoButtonSearchHTML}
            </div>
        `;
        
        // Main click for search result card
        card.onclick = (e) => {
             // Prevent main navigation if an action button inside was clicked
            if (e.target.closest('.action-icon-btn')) {
                return;
            }
            isSearchViewActive = false;
            if (searchInputElement) searchInputElement.value = "";
            if (result.itemType === "folder") {
                navigateToFolder(result.item.id);
            } else {
                const parentFolderId = result.path.length > 1 ? result.path[result.path.length - 1].id : null;
                navigateToFolder(parentFolderId);
                setTimeout(() => {
                    showArtifactDetailsModal(
                        result.item.title,
                        result.item.description,
                        result.item.link
                    );
                }, 100);
            }
        };
        folderContentContainer.appendChild(card);
    });
}
      // --- End Search Functionality ---

      // --- Global Event Listeners (Escape key) ---
        document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
         // Close artifact details modal
         const artifactModal = document.getElementById(
        "artifact-details-modal"
         );
          if (artifactModal?.classList.contains("active")) {
            closeArtifactDetailsModal();
          }
         // Close add item form
          if (addItemFormContainer?.style.display === "block") {
          toggleAddItemForm(false);
           }
        // Close user dropdown menu
        if (
         userDropdownMenu &&
        !userDropdownMenu.classList.contains("hidden")
         ) {
        userDropdownMenu.classList.add("hidden");
         if (userMenuButton)
         userMenuButton.setAttribute("aria-expanded", "false");
          }
          // START: Added to close info popover on Escape
          if (currentInfoDropdown) {
            currentInfoDropdown.remove();
            currentInfoDropdown = null;
          }
          // END: Added to close info popover on Escape
      }
    });

      // Modify existing document click listener for userDropdownMenu
      // or add this if no such global click listener exists yet.
      document.addEventListener("click", (event) => {
        if (
            userDropdownMenu &&
            !userDropdownMenu.classList.contains("hidden") &&
            userMenuButton &&
            !userMenuButton.contains(event.target) &&
            !userDropdownMenu.contains(event.target)
        ) {
            userDropdownMenu.classList.add("hidden");
            userMenuButton.setAttribute("aria-expanded", "false");
        }

        // START: Added to close info popover on click outside
        if (currentInfoDropdown && !currentInfoDropdown.contains(event.target)) {
            // Check if the click was on an info button; if so, showItemInfoPopover will handle it
            // and this click outside logic shouldn't immediately close it.
            if (!event.target.closest('.action-icon-btn.info')) {
                 currentInfoDropdown.remove();
                 currentInfoDropdown = null;
            }
        }
        // END: Added to close info popover on click outside
      });
      // --- End Global Event Listeners ---
    </script>
  </body>
</html>