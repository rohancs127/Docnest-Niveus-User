<script>
  // const BASE = "http://localhost:3000"; // Old BASE URL for local Next.js backend
  const BASE = ""; // New BASE URL for relative API paths on Vercel or when served by vercel dev from root

  let fullTreeData = [];
  let currentPath = [{ id: null, name: "Home" }]; 
  let currentViewNodeId = null; 
  let isCurrentlySearching = false;

  const contentContainer = document.getElementById("content-container");
  const breadcrumbContainer = document.getElementById("breadcrumb-container");
  const searchInput = document.getElementById("user-search-input");
  const backButton = document.getElementById("back-button");
  const logoutButton = document.getElementById("logout-button"); 
  const themeToggleButton = document.getElementById("theme-toggle-button");

  // --- MODIFIED: Safely set current year ---
  const currentYearSpan = document.getElementById("current-year");
  if (currentYearSpan) {
    currentYearSpan.textContent = new Date().getFullYear();
  } else {
    // This warning will appear if the script runs before the 'current-year' span is in the DOM.
    // Ensure this script tag is at the end of the <body>.
    console.warn("Element with ID 'current-year' not found in the DOM when script executed.");
  }

  // --- Firebase Client SDK Setup ---
  const firebaseConfig = {
    apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ", // Your actual Firebase project API key
    authDomain: "docnest-f85e2.firebaseapp.com",
    projectId: "docnest-f85e2",
    storageBucket: "docnest-f85e2.appspot.com",
    messagingSenderId: "102395439437",
    appId: "1:102395439437:web:84e6676388b5d54395af04",
    measurementId: "G-YRMBR8BVSE",
  };
  let firebaseAppUser;
  let firebaseAuthUser; 

  try {
    if (!firebase.apps.length) {
        firebaseAppUser = firebase.initializeApp(firebaseConfig);
    } else {
        firebaseAppUser = firebase.app(); 
    }
    firebaseAuthUser = firebase.auth(firebaseAppUser);
    console.log("Firebase for User Page initialized successfully.");
  } catch (e) {
    console.error("Error initializing Firebase on User Page:", e);
    if(window.showNotification) window.showNotification("Auth service error. Please check configuration.", "error", 7000);
  }

  // --- Theme Toggle ---
  const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
  const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
  
  function applyTheme(theme) {
    if (themeToggleButton) {
        if (theme === "light") { 
            document.body.classList.add("light-theme"); 
            themeToggleButton.innerHTML = moonIcon; 
            localStorage.setItem("theme", "light"); 
        } else { 
            document.body.classList.remove("light-theme"); 
            themeToggleButton.innerHTML = sunIcon; 
            localStorage.setItem("theme", "dark"); 
        }
    }
  }
  if (themeToggleButton) {
    themeToggleButton.addEventListener("click", () => applyTheme(document.body.classList.contains("light-theme") ? "dark" : "light"));
  }
  applyTheme(localStorage.getItem("theme") || "light"); // Default to light theme

  // --- Toast Notifications ---
  const toastContainer = document.getElementById("toast-container");
  window.showNotification = function (message, type = "success", duration = 3000) {
    if (!toastContainer) return;
    const toast = document.createElement("div"); toast.classList.add("toast", type);
    let iconHtml = "";
    if (type === "success") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
    else if (type === "error") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.293-10.293a1 1 0 00-1.414 0L9 8.586l-.293-.293a1 1 0 10-1.414 1.414L7.586 10l-.293.293a1 1 0 101.414 1.414L9 11.414l.293.293a1 1 0 001.414-1.414L10.414 10l.293-.293a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`;
    else if (type === "info") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
    toast.innerHTML = `${iconHtml}<span>${escapeHTML(message)}</span>`;
    toastContainer.appendChild(toast); toast.offsetHeight; toast.classList.add("show");
    setTimeout(() => { toast.classList.remove("show"); setTimeout(() => { toast.remove(); }, 300); }, duration);
  };

  function escapeHTML(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
  }

  async function getAuthTokenForUserPage() {
      if (!firebaseAuthUser || !firebaseAuthUser.currentUser) {
          console.warn("[UserPage] No current Firebase user for token request.");
          const sessionToken = sessionStorage.getItem("user_token"); 
          if (sessionToken) return sessionToken;
          if(window.showNotification) window.showNotification("Session may have expired. Please log in again.", "error");
          if (!window.location.pathname.endsWith("user_login.html")) {
             window.location.href = "user_login.html";
          }
          return null;
      }
      try {
          const token = await firebaseAuthUser.currentUser.getIdToken(true);
          sessionStorage.setItem("user_token", token);
          return token;
      } catch (error) {
          console.error("[UserPage] Error getting ID token:", error);
          if(window.showNotification) window.showNotification("Could not refresh session. Please log in again.", "error");
          if (!window.location.pathname.endsWith("user_login.html")) {
             window.location.href = "user_login.html";
          }
          return null;
      }
  }

  async function secureUserFetch(url, options = {}) {
      const token = await getAuthTokenForUserPage();
      const headers = { ...options.headers };
      if (token) {
          headers["Authorization"] = `Bearer ${token}`;
      } else {
          // If no token, the request might fail or be treated as unauthenticated by the backend
          console.warn(`[secureUserFetch] No token available for request to ${url}.`);
      }
      if (!(options.body instanceof FormData) && options.method && options.method.toUpperCase() !== 'GET' && options.method.toUpperCase() !== 'OPTIONS' ) {
          headers["Content-Type"] = "application/json";
      }
      console.log(`[secureUserFetch] Making ${options.method || 'GET'} request to ${url} with token: ${token ? 'present' : 'absent'}`);
      return fetch(url, { ...options, headers });
  }

  function updateBackButtonVisibility() { 
    if (backButton) {
        if (!isCurrentlySearching && currentPath.length > 1) {
            backButton.classList.remove("hidden");
        } else {
            backButton.classList.add("hidden");
        }
    }
  }

  function renderBreadcrumbs() { 
    updateBackButtonVisibility();
    if (!breadcrumbContainer) return;
    if (isCurrentlySearching) { 
        breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Displaying search results for "${escapeHTML(searchInput.value)}"...</li>`;
        return;
    }
    breadcrumbContainer.innerHTML = "";
    currentPath.forEach((crumb, index) => {
      const li = document.createElement("li");
      const isLast = index === currentPath.length - 1;
      const a = document.createElement("a");
      a.href = "#";
      a.textContent = escapeHTML(crumb.name);
      a.classList.add("breadcrumb-item", "text-sm");
      if (isLast) { 
        a.classList.add("font-medium", "text-[var(--text-primary)]", "cursor-default");
      } else {
        a.classList.add("cursor-pointer", "hover:underline");
        a.style.color = "var(--text-link)";
        a.onclick = (e) => {
          e.preventDefault();
          currentPath = currentPath.slice(0, index + 1);
          currentViewNodeId = crumb.id;
          displayNodes(currentViewNodeId);
        };
      }
      li.appendChild(a);
      if (!isLast) {
        const separator = document.createElement("span");
        separator.textContent = "/";
        separator.classList.add("mx-1.5", "text-[var(--text-tertiary)]");
        li.appendChild(separator);
      }
      breadcrumbContainer.appendChild(li);
    });
  }
  
  function findNodeAndPathById(nodes, targetId, currentTrail = [{id: null, name: "Home"}]) { 
    if (!Array.isArray(nodes)) return null;
    for (const node of nodes) {
        const newTrail = [...currentTrail, { id: node.id, name: node.name }];
        if (String(node.id) === String(targetId)) { 
            return { node, path: newTrail };
        }
        if (node.children && Array.isArray(node.children)) {
            const foundInChildren = findNodeAndPathById(node.children, targetId, newTrail);
            if (foundInChildren) return foundInChildren;
        }
    }
    return null;
  }
  
  function findNodeById(nodes, id) { 
    if (id === null) return { id: null, name: "Home", children: fullTreeData || [], artifacts: [] }; 
    if (!Array.isArray(nodes)) return null;
    for (const node of nodes) {
      if (String(node.id) === String(id)) return node;
      if (node.children && Array.isArray(node.children)) {
        const found = findNodeById(node.children, id);
        if (found) return found;
      }
    }
    return null;
  }
  
  function createCard(item) { 
    const card = document.createElement("div");
    card.className = "item-card p-4 sm:p-5 flex flex-col h-full"; 
    card.title = item.description || `Explore ${escapeHTML(item.name)}`;
    card.onclick = () => {
      isCurrentlySearching = false; 
      if(searchInput) searchInput.value = ""; 
      
      const pathInfo = findNodeAndPathById(fullTreeData, item.id);
      if (pathInfo) {
        currentPath = pathInfo.path;
      } else { 
        if (!currentPath.find(p => String(p.id) === String(item.id))) {
            currentPath.push({ id: item.id, name: item.name });
        }
      }
      currentViewNodeId = item.id;
      displayNodes(item.id);
    };
    const icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 sm:h-10 sm:w-10 mb-3 text-[var(--text-tertiary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`;
    const title = `<h3 class="text-md sm:text-lg font-medium text-[var(--text-card-header)] mb-1 truncate">${escapeHTML(item.name)}</h3>`;
    const description = item.description ? `<p class="text-xs text-[var(--text-secondary)] flex-grow line-clamp-2 sm:line-clamp-3">${escapeHTML(item.description)}</p>` : '<div class="flex-grow"></div>';
    const idLabel = item.id !== undefined 
                    ? `<span class="text-xs font-medium text-[var(--text-tertiary)] mt-2 inline-block">ID: ${escapeHTML(String(item.id))}</span>` 
                    : ''; 
    card.innerHTML = icon + title + description + idLabel;
    return card;
  }

  function displayNodes(nodeId) { 
    if (!contentContainer) {
        console.error("Content container not found in displayNodes.");
        return;
    }
    contentContainer.innerHTML = '<div class="loading-placeholder">Loading content...</div>';
    if (!isCurrentlySearching) { 
        renderBreadcrumbs();
    } else {
        if (breadcrumbContainer) breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Displaying search results for "${escapeHTML(searchInput ? searchInput.value : '')}"...</li>`;
        updateBackButtonVisibility(); 
    }

    let itemsToDisplay = [];
    if (nodeId === null) {
      currentViewNodeId = null; 
      itemsToDisplay = Array.isArray(fullTreeData) ? fullTreeData.filter(node => node.type === 'VERTICAL' || !node.parentId) : [];
    } else {
      const currentNode = findNodeById(fullTreeData, nodeId);
      currentViewNodeId = nodeId; 
      if (currentNode) {
        itemsToDisplay = [...(Array.isArray(currentNode.children) ? currentNode.children : []) , ...(Array.isArray(currentNode.artifacts) ? currentNode.artifacts : [])];
      } else {
        contentContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)]">Folder not found.</p>';
        if (!isCurrentlySearching) renderBreadcrumbs();
        return;
      }
    }

    if (itemsToDisplay.length === 0 && !isCurrentlySearching) { 
      contentContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-8">This folder is empty.</p>';
      if (!isCurrentlySearching) renderBreadcrumbs();
      return;
    }

    contentContainer.innerHTML = ""; 
    const grid = document.createElement("div");
    grid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-5"; 
    
    const filesListContainer = document.createElement('div'); 
    const filesList = document.createElement('ul');
    filesList.className = "space-y-2"; 
    filesListContainer.appendChild(filesList);

    let hasFiles = false;
    let hasFolders = false;

    itemsToDisplay.forEach(item => {
      if (item.type === 'FOLDER' || item.type === 'SUBFOLDER' || item.type === 'VERTICAL' || (item.children && Array.isArray(item.children))) {
        hasFolders = true;
        grid.appendChild(createCard(item));
      } else if (item.type === 'ARTIFACT' || item.link) {
        hasFiles = true;
        const listItem = document.createElement('li');
        listItem.className = "file-item flex items-center justify-between rounded-md"; 
        const fileInfo = document.createElement('div');
        fileInfo.className = "flex items-center overflow-hidden mr-2";
        fileInfo.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2.5 text-[var(--text-tertiary)] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
          <span class="text-sm text-[var(--text-primary)] truncate" title="${escapeHTML(item.title)}">${escapeHTML(item.title)}</span>
        `;
        
        const linkElement = document.createElement('a');
        let url = item.link || "#";
        if (url && url !== "#" && !url.toLowerCase().startsWith("http://") && !url.toLowerCase().startsWith("https://") && !url.startsWith("/")) {
            if (url.includes('.') && !url.includes(' ') && !url.startsWith('//')) {
                 url = `https://${url}`; 
            }
        }
        linkElement.href = url;
        if (item.link && url !== "#") linkElement.target = "_blank";
        linkElement.rel = "noopener noreferrer";
        linkElement.className = "text-xs ml-auto px-2.5 py-1 rounded hover:underline flex-shrink-0"; 
        linkElement.style.color = "var(--text-link)";
        linkElement.textContent = item.link ? "Open" : "No Link";
        if (!item.link || url === "#") linkElement.classList.add("opacity-50", "cursor-not-allowed");
        
        listItem.appendChild(fileInfo);
        listItem.appendChild(linkElement);
        filesList.appendChild(listItem);
      }
    });
    if (hasFolders) contentContainer.appendChild(grid);
    if (hasFiles) {
      if (hasFolders) {
        const separator = document.createElement('hr');
        separator.className = "my-6 sm:my-8 border-[var(--border-primary)] opacity-50"; 
        contentContainer.appendChild(separator);
      }
      const filesHeader = document.createElement('h3');
      filesHeader.className = "text-lg sm:text-xl font-medium text-[var(--text-card-header)] mb-3 sm:mb-4"; 
      filesHeader.textContent = "Files / Pages";
      contentContainer.appendChild(filesHeader);
      contentContainer.appendChild(filesListContainer); 
    }
  }

  // --- Search Functionality ---
  let searchDebounceTimer;
  if (searchInput) {
    searchInput.addEventListener('input', () => {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            handleSearch(searchInput.value);
        }, 300);
    });
  }

  function handleSearch(term) { 
      const searchTerm = term.trim().toLowerCase();
      if (!searchTerm) {
          isCurrentlySearching = false;
          displayNodes(currentViewNodeId); 
          return;
      }
      isCurrentlySearching = true;
      if (breadcrumbContainer) breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Searching for "${escapeHTML(searchTerm)}"...</li>`;
      updateBackButtonVisibility(); 
      const matches = [];
      collectAllMatchingItems(fullTreeData, searchTerm, [], matches);
      displayDirectSearchResults(matches, searchTerm);
  }

  function collectAllMatchingItems(nodes, term, currentTrail, matches) { 
      if (!Array.isArray(nodes)) return;
      nodes.forEach(node => {
          const nodePathSegment = { id: node.id, name: node.name };
          const pathToNode = [...currentTrail, nodePathSegment];
          if (node.name && node.name.toLowerCase().includes(term)) {
              matches.push({ item: node, path: pathToNode, type: 'folder' });
          }
          if (node.artifacts && Array.isArray(node.artifacts)) {
              node.artifacts.forEach(artifact => {
                  if (artifact.title && artifact.title.toLowerCase().includes(term)) {
                      matches.push({ item: artifact, path: pathToNode, type: 'file' });
                  }
              });
          }
          if (node.children && Array.isArray(node.children)) {
              collectAllMatchingItems(node.children, term, pathToNode, matches);
          }
      });
  }

  function displayDirectSearchResults(matches, searchTerm) { 
      if (!contentContainer) return;
      contentContainer.innerHTML = ""; 
      if (matches.length === 0) {
          contentContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)] py-8">No items found matching "${escapeHTML(searchTerm)}".</p>`;
          return;
      }
      const resultsList = document.createElement('ul');
      resultsList.className = "space-y-0 bg-[var(--bg-card)] p-0 rounded-lg shadow-md overflow-hidden border border-[var(--border-card)]"; 
      matches.forEach(matchData => {
          const { item, path, type } = matchData;
          const listItem = document.createElement('li');
          listItem.className = "search-result-item flex items-center justify-between";
          const itemInfo = document.createElement('div');
          itemInfo.className = "flex items-center overflow-hidden mr-2 py-2.5 px-3"; 
          const iconType = type === 'folder' ? 
            `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2.5 text-[var(--text-tertiary)] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>` :
            `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2.5 text-[var(--text-tertiary)] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>`;
          const itemName = type === 'folder' ? item.name : item.title;
          const displayPathArray = [{name: "Home"}, ...path.map(p => ({name: p.name}))]; 
          if (type === 'file') {
            displayPathArray.pop(); 
            const parentNodeInPath = path[path.length -1];
            if (parentNodeInPath) { displayPathArray.push({name: parentNodeInPath.name}); }
             displayPathArray.push({name: item.title});
          }
          itemInfo.innerHTML = `
              ${iconType}
              <div class="flex flex-col overflow-hidden">
                  <span class="text-sm font-medium text-[var(--text-primary)] truncate" title="${escapeHTML(itemName)}">${escapeHTML(itemName)}</span>
                  <span class="text-xs text-[var(--text-search-path)] truncate" title="Path: ${displayPathArray.map(p=>p.name).join(' / ')}">
                      ${displayPathArray.map(p=>p.name).join(' / ')}
                  </span>
              </div>
          `;
          listItem.appendChild(itemInfo);
          listItem.onclick = () => {
              if(searchInput) searchInput.value = ""; 
              isCurrentlySearching = false; 
              if (type === 'folder') {
                  currentPath = [{id: null, name: "Home"}, ...path]; 
                  currentViewNodeId = item.id;
                  displayNodes(item.id);
              } else { 
                  currentPath = [{id: null, name: "Home"}, ...path]; 
                  currentViewNodeId = path[path.length-1].id; 
                  displayNodes(currentViewNodeId);
              }
          };
          resultsList.appendChild(listItem);
      });
      contentContainer.appendChild(resultsList);
  }

  // --- Back Button Logic ---
  function handleBackButton() { 
    if (!isCurrentlySearching && currentPath.length > 1) {
        if(searchInput) searchInput.value = ""; 
        isCurrentlySearching = false;
        currentPath.pop();
        const previousCrumb = currentPath[currentPath.length - 1];
        currentViewNodeId = previousCrumb.id;
        displayNodes(currentViewNodeId);
    }
  }
  if (backButton) {
    backButton.addEventListener('click', handleBackButton);
  }

  // --- Logout Button Logic ---
  if (logoutButton) {
      logoutButton.addEventListener("click", async () => {
          if (firebaseAuthUser) {
              try {
                  await firebaseAuthUser.signOut();
                  sessionStorage.removeItem("user_token"); 
                  if(window.showNotification) window.showNotification("You have been logged out.", "success");
                  window.location.href = "user_login.html"; 
              } catch (error) {
                  console.error("Error signing out user:", error);
                  if(window.showNotification) window.showNotification("Logout failed. Please try again.", "error");
              }
          }
      });
  }

  // --- Initial Load & Auth State Handling ---
  async function initializeUserView() { 
    if (contentContainer) contentContainer.innerHTML = '<div class="loading-placeholder">Loading initial content...</div>';
    else { console.error("Content container not found for user page."); return; }

    const tokenFromLogin = sessionStorage.getItem("user_token"); 
    if (!tokenFromLogin && firebaseAuthUser && !firebaseAuthUser.currentUser) {
        console.log("No user token found, redirecting to user login.");
        if (!window.location.pathname.endsWith("user_login.html")) {
            window.location.href = "user_login.html";
        }
        return; 
    }
    
    try {
      const res = await secureUserFetch(`${BASE}/api/tree`); 
      if (!res.ok) {
        const errorText = await res.text();
        let errorDetail = res.statusText;
        try { const errData = JSON.parse(errorText); errorDetail = errData.error || errData.message || errorDetail; } catch(e){}
        throw new Error(`HTTP error ${res.status}: ${errorDetail}`);
      }
      fullTreeData = await res.json();
      if (!Array.isArray(fullTreeData)) {
          console.error("Fetched tree data is not an array:", fullTreeData);
          fullTreeData = [];
          throw new Error("Invalid tree data format from server.");
      }
      currentViewNodeId = null;
      currentPath = [{ id: null, name: "Home" }];
      isCurrentlySearching = false;
      displayNodes(null); 
    } catch (error) {
      console.error("Failed to fetch initial tree data for user page:", error);
      contentContainer.innerHTML = `<p class="text-center text-[var(--text-red-accent)] p-4">Error loading knowledge base: ${error.message}. Please try again later.</p>`;
      if(window.showNotification) showNotification(`Error loading data: ${error.message}`, "error", 7000);
    }
  }

  if (firebaseAuthUser) {
      firebaseAuthUser.onAuthStateChanged(async (user) => {
          if (user) {
              console.log("User Page: User is signed in -", user.email);
              try {
                  const token = await user.getIdToken(true);
                  sessionStorage.setItem("user_token", token); 
                  console.log("User Page: Token refreshed/stored in session storage.");
              } catch (tokenError) {
                  console.error("User Page: Error refreshing token on auth state change:", tokenError);
              }
              // Load data if not already loaded or if it's the first time this callback runs for the user
              if (fullTreeData.length === 0 || !document.getElementById("content-container").hasChildNodes() || document.querySelector('.loading-placeholder')) {
                  initializeUserView();
              }
          } else {
              console.log("User Page: No user signed in / session ended. Redirecting to login.");
              sessionStorage.removeItem("user_token");
              if (!window.location.pathname.endsWith("user_login.html")) {
                  window.location.href = "user_login.html";
              }
          }
      });
  } else {
      console.warn("User Page: Firebase Auth not available. Redirecting to login if not already there.");
      if (!window.location.pathname.endsWith("user_login.html")) {
          // Adding a small delay before redirecting to ensure any error messages can be seen.
          // setTimeout(() => { window.location.href = "user_login.html"; }, 200); 
      }
  }
</script>
