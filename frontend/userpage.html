<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Niveus Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
      :root {
        /* Dark Theme (Adopted from Admin UI for a professional look) */
        --bg-primary: #0a0a0a;
        --bg-secondary: #121212; 
        --bg-card: #1a1a1a;
        --bg-card-hover: #222222;
        --bg-input: #2d2d2d;
        --bg-button-primary: #f0f0f0; 
        --bg-button-primary-hover: #ffffff;
        --bg-button-secondary: #333333; 
        --bg-button-secondary-hover: #3f3f3f;
        --bg-action-button: var(--bg-card); /* For icon buttons like theme/back/logout */
        --bg-action-button-hover: var(--bg-card-hover);
        --bg-breadcrumb-item-hover: #2a2a2a;
        --bg-file-item-hover: #222222;
        --bg-search-result-item-hover: #2c2c2c; /* For list items in search */
        --bg-toast-success: #2f5c3b;
        --bg-toast-error: #5c2f2f;

        --text-primary: #e0e0e0;
        --text-secondary: #bbb;
        --text-tertiary: #999;
        --text-placeholder: #888;
        --text-button-primary: #111; 
        --text-button-secondary: #e0e0e0; 
        --text-card-header: #f0f0f0; /* For main titles */
        --text-link: #60a5fa; 
        --text-link-hover: #93c5fd;
        --text-search-path: #888; /* For path in search results */
        --text-toast: #ffffff;
        --text-yellow-accent: #facc15; 
        --text-blue-accent: #60a5fa;   

        --border-primary: #333;
        --border-card: var(--border-primary);
        --border-input: #555;
        --border-input-focus: #007acc;
        --border-button-primary: #ccc;
        --border-button-primary-hover: #bbb;
        --border-button-secondary: #555;
        --border-toast-success: #38a169;
        --border-toast-error: #e53e3e;
        --border-breadcrumb: var(--border-primary);

        --shadow-card: 0 6px 12px rgba(0, 0, 0, 0.35); 
        --shadow-card-hover: 0 8px 16px rgba(0, 0, 0, 0.4);
        --shadow-input-focus: 0 0 0 3px rgba(0, 122, 204, 0.3);
        --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.4);

        --scrollbar-thumb: #4a4a4a;
        --scrollbar-track: #1e1e1e;
      }

      .light-theme {
        --bg-primary: #f4f4f5;
        --bg-secondary: #ffffff;
        --bg-card: #ffffff;
        --bg-card-hover: #f9fafb; 
        --bg-input: #ffffff;
        --bg-button-primary: #1f2937; 
        --bg-button-primary-hover: #111827;
        --bg-button-secondary: #e5e7eb; 
        --bg-button-secondary-hover: #d1d5db;
        --bg-action-button: #ffffff;
        --bg-action-button-hover: #f9fafb;
        --bg-breadcrumb-item-hover: #e5e7eb;
        --bg-file-item-hover: #f3f4f6;
        --bg-search-result-item-hover: #e9e9e9;
        --bg-toast-success: #c6f6d5;
        --bg-toast-error: #fed7d7;

        --text-primary: #18181b;
        --text-secondary: #52525b;
        --text-tertiary: #71717a;
        --text-placeholder: #a1a1aa;
        --text-button-primary: #ffffff; 
        --text-button-secondary: #1f2937; 
        --text-card-header: #1f2937; /* For main titles */
        --text-link: #2563eb; 
        --text-link-hover: #1d4ed8;
        --text-search-path: #6b7280;
        --text-toast: #1a202c; 
        --text-yellow-accent: #ca8a04; 
        --text-blue-accent: #2563eb;

        --border-primary: #d1d5db;
        --border-card: var(--border-primary);
        --border-input: #d1d5db;
        --border-input-focus: #2563eb;
        --border-button-primary: #1f2937;
        --border-button-primary-hover: #111827;
        --border-button-secondary: #d1d5db;
        --border-toast-success: #68d391;
        --border-toast-error: #fc8181;
        --border-breadcrumb: var(--border-primary);

        --shadow-card: 0 4px 10px rgba(0, 0, 0, 0.07); 
        --shadow-card-hover: 0 6px 12px rgba(0, 0, 0, 0.09);
        --shadow-input-focus: 0 0 0 3px rgba(37, 99, 235, 0.2);
        --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.15);

        --scrollbar-thumb: #a1a1aa;
        --scrollbar-track: #e5e7eb;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .input-field { /* Shared input style */
        display: block; width: 100%; border-radius: 0.5rem; 
        border: 1px solid var(--border-input); background-color: var(--bg-input);
        color: var(--text-primary); padding: 0.625rem 0.875rem; font-size: 0.875rem;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease;
      }
      .input-field::placeholder { color: var(--text-placeholder); opacity: 0.8; }
      .input-field:focus {
        border-color: var(--border-input-focus); outline: none; 
        box-shadow: var(--shadow-input-focus);
      }
      /* Search input specific styling */
      #user-search-input-wrapper { position: relative; flex-grow: 1; }
      #user-search-input { padding-left: 2.5rem; /* Space for icon */ }
      #user-search-input-icon {
        position: absolute; left: 0.75rem; top: 50%;
        transform: translateY(-50%); color: var(--text-placeholder);
        pointer-events: none;
      }

      .item-card { /* For Folders */
        background-color: var(--bg-card); border: 1px solid var(--border-card);
        border-radius: 0.75rem; 
        box-shadow: var(--shadow-card);
        transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.2s ease-out;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        min-height: 170px; 
        padding: 1.25rem; 
      }
      .item-card:hover {
        transform: translateY(-4px) scale(1.01); /* Subtle scale */
        box-shadow: var(--shadow-card-hover); 
        background-color: var(--bg-card-hover);
      }
      .item-card-icon-wrapper {
        display: flex; align-items: center; justify-content: center;
        width: 2.75rem; height: 2.75rem; /* Slightly smaller */
        border-radius: 0.5rem; margin-bottom: 0.75rem; /* Less margin */
        background-color: color-mix(in srgb, var(--bg-primary) 60%, var(--bg-card) 40%); 
      }
      .item-card-icon svg { width: 1.5rem; height: 1.5rem; } /* Smaller icon */

      .item-card-name {
        font-weight: 600; font-size: 1rem; 
        color: var(--text-primary); margin-bottom: 0.25rem;
        word-break: break-word; line-height: 1.4;
      }
      .item-card-description { /* Class for description paragraph */
        font-size: 0.8rem; color: var(--text-secondary);
        flex-grow: 1; line-height: 1.5;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3; /* Limit to 3 lines */
        -webkit-box-orient: vertical;
        margin-bottom: 0.5rem;
      }
      .item-card-id { /* Class for ID display */
        font-size: 0.7rem; color: var(--text-tertiary);
        margin-top: auto; /* Pushes ID to the bottom if description is short */
        padding-top: 0.5rem;
      }

      .file-item-list { /* Container for list of files */
        background-color: var(--bg-card);
        border: 1px solid var(--border-card);
        border-radius: 0.75rem;
        padding: 0.5rem; /* Add some padding around the list */
        box-shadow: var(--shadow-card);
      }
      .file-item {
        background-color: transparent;
        border-bottom: 1px solid var(--border-primary);
        transition: background-color 0.2s ease-out;
        padding: 0.875rem 0.75rem; /* py-3.5 px-3 */
        border-radius: 0.375rem; 
      }
      .file-item:hover { background-color: var(--bg-file-item-hover); }
      .file-item:last-child { border-bottom: none; }
      .file-item-icon svg { width: 1.25rem; height: 1.25rem; color: var(--text-blue-accent); margin-right: 0.75rem; flex-shrink: 0;}
      .file-item-title { font-size: 0.875rem; color: var(--text-primary); }
      .file-item-link { font-size: 0.8rem; color: var(--text-link); margin-left: auto; padding-left: 0.75rem; white-space: nowrap; }
      .file-item-link:hover { color: var(--text-link-hover); text-decoration: underline; }
      .file-item-link.disabled { opacity: 0.6; cursor: not-allowed; text-decoration: none; }


      .search-results-container { /* Container for search results list */
        background-color: var(--bg-card);
        border: 1px solid var(--border-card);
        border-radius: 0.75rem;
        padding: 0.5rem;
        box-shadow: var(--shadow-card);
      }
      .search-result-item {
        border-bottom: 1px solid var(--border-primary); cursor: pointer;
        transition: background-color 0.2s ease-out;
        padding: 0.875rem 1rem; 
      }
      .search-result-item:hover { background-color: var(--bg-search-result-item-hover); }
      .search-result-item:last-child { border-bottom: none; }
      .search-result-icon svg { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; flex-shrink: 0; }
      .search-result-name {
        font-weight: 500; font-size: 0.9rem; 
        color: var(--text-primary);
      }
      .search-result-name .highlight {
        background-color: var(--text-yellow-accent);
        color: var(--bg-card) !important; 
        padding: 0 2px; border-radius: 2px; font-weight: 600;
      }
      .light-theme .search-result-name .highlight {
        background-color: #fef9c3; color: #713f12 !important; 
      }
      .search-result-path {
        font-size: 0.75rem; color: var(--text-search-path);
        margin-top: 0.125rem;
      }
      

      #breadcrumb-container {
        padding: 0.5rem 0; 
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-primary); 
      }
      .breadcrumb-item { padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; }
      .breadcrumb-item:hover { background-color: var(--bg-breadcrumb-item-hover); }
      .breadcrumb-separator { margin: 0 0.5rem; color: var(--text-tertiary); font-size: 0.75rem; }
      .breadcrumb-current { color: var(--text-primary); font-weight: 500; font-size: 0.875rem; padding: 0.25rem 0.5rem;}
      
      #back-button, #theme-toggle-button, #logout-button { 
        background-color: var(--bg-action-button);
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 0.5rem; 
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        display: inline-flex; 
        align-items: center;
        justify-content: center;
      }
      #back-button:hover, #theme-toggle-button:hover, #logout-button:hover {
        background-color: var(--bg-action-button-hover);
        color: var(--text-primary);
        border-color: var(--border-card);
      }
      #logout-button { 
        padding: 0.5rem 1rem; 
        font-size: 0.875rem; 
        font-weight: 500; 
      }
      #theme-toggle-button, #back-button { 
        padding: 0.625rem; 
      }

      .custom-scrollbar { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); }
      .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--scrollbar-thumb) 80%, #fff 20%); }
      #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 0.75rem; } 
      .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: var(--text-toast); box-shadow: var(--shadow-toast); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; display: flex; align-items: center; gap: 0.75rem; border-width: 1px; border-style: solid; min-width: 280px; max-width: 400px;}
      .toast.show { opacity: 1; transform: translateY(0); }
      .toast.success { background-color: var(--bg-toast-success); border-color: var(--border-toast-success); color: var(--text-toast, #ffffff); }
      .light-theme .toast.success { color: var(--text-toast, #065f46); }
      .toast.error { background-color: var(--bg-toast-error); border-color: var(--border-toast-error); color: var(--text-toast, #ffffff); }
      .light-theme .toast.error { color: var(--text-toast-error, #c2410c); }
      .toast-icon { flex-shrink: 0; }
      .loading-placeholder { text-align: center; padding: 2rem; font-style: italic; color: var(--text-secondary); }
    </style>
  </head>
  <body class="custom-scrollbar">
    <div id="toast-container"></div>
    <div class="container mx-auto p-4 md:px-6 lg:px-8 py-6 md:py-8 min-h-screen flex flex-col">
      <header class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4 pb-6 border-b border-[var(--border-primary)]">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-[var(--text-card-header)] flex items-center">
          <img src="https://niveussolutions.com/wp-content/uploads/2025/02/Niveus-ntt-data.png" alt="Niveus Logo" class="h-8 sm:h-9 mr-3"> 
          Niveus Knowledge Base
        </h1>
        <div class="flex items-center gap-3 w-full sm:w-auto max-w-md">
            <div id="user-search-input-wrapper" class="relative flex-grow">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-[var(--text-placeholder)]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <input
                  type="search"
                  id="user-search-input"
                  class="input-field w-full text-sm" 
                  placeholder="Search KB..."
                />
            </div>
            <button
                id="theme-toggle-button"
                class="flex-shrink-0"
                title="Toggle Theme"
            ></button>
            <button
                id="logout-button"
                class="flex-shrink-0"
                title="Logout"
            >
                Logout
            </button>
        </div>
      </header>

      <nav aria-label="Breadcrumb" class="mb-6 min-h-[36px] flex items-center gap-2"> 
        <button id="back-button" title="Go Back" class="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </button>
        <ol id="breadcrumb-container" class="flex items-center space-x-1 text-sm text-[var(--text-secondary)] flex-wrap">
          </ol>
      </nav>

      <main id="content-container" class="flex-grow">
        <div class="loading-placeholder">Loading initial content...</div>
      </main>

      <footer class="text-center py-8 mt-auto text-xs text-[var(--text-tertiary)]">
        &copy; <span id="current-year"></span> Niveus Solutions. All rights reserved.
      </footer>
    </div>

    <script>
      const BASE = ""; 
    
      let fullTreeData = [];
      let currentPath = [{ id: null, name: "Home" }]; 
      let currentViewNodeId = null; 
      let isCurrentlySearching = false;
    
      const contentContainer = document.getElementById("content-container");
      const breadcrumbContainer = document.getElementById("breadcrumb-container");
      const searchInput = document.getElementById("user-search-input");
      const backButton = document.getElementById("back-button");
      const logoutButton = document.getElementById("logout-button"); 
      const themeToggleButton = document.getElementById("theme-toggle-button");
      const currentYearSpan = document.getElementById("current-year");
      const toastContainer = document.getElementById("toast-container");
    
    
      if (currentYearSpan) {
        currentYearSpan.textContent = new Date().getFullYear();
      } else {
        console.warn("Element with ID 'current-year' not found in the DOM when script executed.");
      }
    
      const firebaseConfig = {
        apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ", 
        authDomain: "docnest-f85e2.firebaseapp.com",
        projectId: "docnest-f85e2",
        storageBucket: "docnest-f85e2.appspot.com",
        messagingSenderId: "102395439437",
        appId: "1:102395439437:web:84e6676388b5d54395af04",
        measurementId: "G-YRMBR8BVSE",
      };
      let firebaseAppUser;
      let firebaseAuthUser; 
    
      if (typeof firebase !== 'undefined') {
        try {
          if (!firebase.apps.length) {
              firebaseAppUser = firebase.initializeApp(firebaseConfig);
          } else {
              firebaseAppUser = firebase.app(); 
          }
          firebaseAuthUser = firebase.auth(firebaseAppUser);
          console.log("Firebase for User Page initialized successfully.");
        } catch (e) {
          console.error("Error initializing Firebase on User Page:", e);
          if(window.showNotification) window.showNotification("Auth service error. Please check configuration.", "error", 7000);
          else console.error("showNotification function not available for Firebase init error.");
        }
      } else {
        console.error("Firebase SDK not loaded. Please ensure firebase-app-compat.js and firebase-auth-compat.js are included in your HTML head.");
        document.addEventListener('DOMContentLoaded', () => { 
            if(window.showNotification) window.showNotification("Critical Error: Firebase SDK not loaded.", "error", 10000);
            else alert("Critical Error: Firebase SDK not loaded. Check console.");
        });
      }
    
      const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
      const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
      
      function applyTheme(theme) {
        if (themeToggleButton) {
            if (theme === "light") { 
                document.body.classList.add("light-theme"); 
                themeToggleButton.innerHTML = moonIcon; 
                localStorage.setItem("theme", "light"); 
            } else { 
                document.body.classList.remove("light-theme"); 
                themeToggleButton.innerHTML = sunIcon; 
                localStorage.setItem("theme", "dark"); 
            }
        }
      }
      if (themeToggleButton) {
        themeToggleButton.addEventListener("click", () => applyTheme(document.body.classList.contains("light-theme") ? "dark" : "light"));
      }
      applyTheme(localStorage.getItem("theme") || "light"); 
    
      window.showNotification = function (message, type = "success", duration = 3000) {
        if (!toastContainer) {
            console.warn("Toast container not found for notification:", message);
            return;
        }
        const toast = document.createElement("div"); toast.classList.add("toast", type);
        let iconHtml = "";
        if (type === "success") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
        else if (type === "error") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.293-10.293a1 1 0 00-1.414 0L9 8.586l-.293-.293a1 1 0 10-1.414 1.414L7.586 10l-.293.293a1 1 0 101.414 1.414L9 11.414l.293.293a1 1 0 001.414-1.414L10.414 10l.293-.293a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`;
        else if (type === "info") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        toast.innerHTML = `${iconHtml}<span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast); toast.offsetHeight; toast.classList.add("show");
        setTimeout(() => { toast.classList.remove("show"); setTimeout(() => { toast.remove(); }, 300); }, duration);
      };
    
      function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
      }
    
      async function getAuthTokenForUserPage() {
          if (!firebaseAuthUser || !firebaseAuthUser.currentUser) {
              console.warn("[UserPage] No current Firebase user for token request.");
              const sessionToken = sessionStorage.getItem("user_token"); 
              if (sessionToken) return sessionToken;
              if(window.showNotification) window.showNotification("Session may have expired. Please log in again.", "error");
              if (!window.location.pathname.endsWith("user_login.html")) {
                 window.location.href = "user_login.html";
              }
              return null;
          }
          try {
              const token = await firebaseAuthUser.currentUser.getIdToken(true);
              sessionStorage.setItem("user_token", token);
              return token;
          } catch (error) {
              console.error("[UserPage] Error getting ID token:", error);
              if(window.showNotification) window.showNotification("Could not refresh session. Please log in again.", "error");
              if (!window.location.pathname.endsWith("user_login.html")) {
                 window.location.href = "user_login.html";
              }
              return null;
          }
      }
    
      async function secureUserFetch(url, options = {}) {
          const token = await getAuthTokenForUserPage();
          const headers = { ...options.headers };
          if (token) {
              headers["Authorization"] = `Bearer ${token}`;
          } else {
              console.warn(`[secureUserFetch] No token available for request to ${url}. Request might fail or be unauthenticated.`);
          }
          if (!(options.body instanceof FormData) && options.method && options.method.toUpperCase() !== 'GET' && options.method.toUpperCase() !== 'OPTIONS' ) {
              headers["Content-Type"] = "application/json";
          }
          console.log(`[secureUserFetch] Making ${options.method || 'GET'} request to ${url} with token: ${token ? 'present' : 'absent'}`);
          return fetch(url, { ...options, headers });
      }
    
      function updateBackButtonVisibility() { 
        if (backButton) {
            if (!isCurrentlySearching && currentPath.length > 1) {
                backButton.classList.remove("hidden");
            } else {
                backButton.classList.add("hidden");
            }
        }
      }
    
      function renderBreadcrumbs() { 
        updateBackButtonVisibility();
        if (!breadcrumbContainer) return;
        if (isCurrentlySearching) { 
            breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Displaying search results for "${escapeHTML(searchInput ? searchInput.value : '')}"...</li>`;
            return;
        }
        breadcrumbContainer.innerHTML = "";
        currentPath.forEach((crumb, index) => {
          const li = document.createElement("li");
          const isLast = index === currentPath.length - 1;
          const a = document.createElement("a");
          a.href = "#";
          a.textContent = escapeHTML(crumb.name);
          a.classList.add("breadcrumb-item", "text-sm");
          if (isLast) { 
            a.classList.add("font-medium", "text-[var(--text-primary)]", "cursor-default");
          } else {
            a.classList.add("cursor-pointer", "hover:underline");
            a.style.color = "var(--text-link)";
            a.onclick = (e) => {
              e.preventDefault();
              currentPath = currentPath.slice(0, index + 1);
              currentViewNodeId = crumb.id;
              displayNodes(currentViewNodeId);
            };
          }
          li.appendChild(a);
          if (!isLast) {
            const separator = document.createElement("span");
            separator.textContent = "/";
            separator.classList.add("mx-1.5", "text-[var(--text-tertiary)]");
            li.appendChild(separator);
          }
          breadcrumbContainer.appendChild(li);
        });
      }
      
      function findNodeAndPathById(nodes, targetId, currentTrail = [{id: null, name: "Home"}]) { 
        if (!Array.isArray(nodes)) return null;
        for (const node of nodes) {
            const newTrail = [...currentTrail, { id: node.id, name: node.name }];
            if (String(node.id) === String(targetId)) { 
                return { node, path: newTrail };
            }
            if (node.children && Array.isArray(node.children)) {
                const foundInChildren = findNodeAndPathById(node.children, targetId, newTrail);
                if (foundInChildren) return foundInChildren;
            }
        }
        return null;
      }
      
      function findNodeById(nodes, id) { 
        if (id === null) return { id: null, name: "Home", children: fullTreeData || [], artifacts: [] }; 
        if (!Array.isArray(nodes)) return null;
        for (const node of nodes) {
          if (String(node.id) === String(id)) return node;
          if (node.children && Array.isArray(node.children)) {
            const found = findNodeById(node.children, id);
            if (found) return found;
          }
        }
        return null;
      }
      
      function createCard(item) { 
        const card = document.createElement("div");
        card.className = "item-card"; 
        card.title = item.description || `Explore ${escapeHTML(item.name)}`;
        card.onclick = () => {
          isCurrentlySearching = false; 
          if(searchInput) searchInput.value = ""; 
          
          const pathInfo = findNodeAndPathById(fullTreeData, item.id);
          if (pathInfo) {
            currentPath = pathInfo.path;
          } else { 
            if (!currentPath.find(p => String(p.id) === String(item.id))) {
                currentPath.push({ id: item.id, name: item.name });
            }
          }
          currentViewNodeId = item.id;
          displayNodes(item.id);
        };
        const iconHTML = `
          <div class="item-card-icon-wrapper">
            <span class="item-card-icon" style="color: var(--text-yellow-accent);">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>
            </span>
          </div>`;
        const titleHTML = `<h3 class="item-card-name">${escapeHTML(item.name)}</h3>`;
        const descriptionHTML = item.description ? `<p class="item-card-description">${escapeHTML(item.description)}</p>` : '<div class="flex-grow"></div>';
        const idLabelHTML = item.id !== undefined 
                        ? `<span class="item-card-id">ID: ${escapeHTML(String(item.id))}</span>` 
                        : ''; 
        card.innerHTML = iconHTML + titleHTML + descriptionHTML + idLabelHTML;
        return card;
      }
    
      function displayNodes(nodeId) { 
        if (!contentContainer) {
            console.error("Content container not found in displayNodes.");
            return;
        }
        contentContainer.innerHTML = '<div class="loading-placeholder">Loading content...</div>';
        if (!isCurrentlySearching) { 
            renderBreadcrumbs();
        } else {
            if (breadcrumbContainer) breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Displaying search results for "${escapeHTML(searchInput ? searchInput.value : '')}"...</li>`;
            updateBackButtonVisibility(); 
        }
    
        let itemsToDisplay = [];
        if (nodeId === null) {
          currentViewNodeId = null; 
          itemsToDisplay = Array.isArray(fullTreeData) ? fullTreeData.filter(node => node.type === 'VERTICAL' || !node.parentId) : [];
        } else {
          const currentNode = findNodeById(fullTreeData, nodeId);
          currentViewNodeId = nodeId; 
          if (currentNode) {
            itemsToDisplay = [...(Array.isArray(currentNode.children) ? currentNode.children : []) , ...(Array.isArray(currentNode.artifacts) ? currentNode.artifacts : [])];
          } else {
            contentContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)]">Folder not found.</p>';
            if (!isCurrentlySearching) renderBreadcrumbs();
            return;
          }
        }
    
        if (itemsToDisplay.length === 0 && !isCurrentlySearching) { 
          contentContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-8">This folder is empty.</p>';
          if (!isCurrentlySearching) renderBreadcrumbs();
          return;
        }
    
        contentContainer.innerHTML = ""; 
        const grid = document.createElement("div");
        grid.id = "folder-content-container"; 
        
        const filesListContainer = document.createElement('div'); 
        const filesList = document.createElement('ul');
        filesList.className = "file-item-list"; // Use class for styling file list container
        filesListContainer.appendChild(filesList);
    
        let hasFiles = false;
        let hasFolders = false;
    
        itemsToDisplay.forEach(item => {
          if (item.type === 'FOLDER' || item.type === 'SUBFOLDER' || item.type === 'VERTICAL' || (item.children && Array.isArray(item.children))) {
            hasFolders = true;
            grid.appendChild(createCard(item));
          } else if (item.type === 'ARTIFACT' || item.link) {
            hasFiles = true;
            const listItem = document.createElement('li');
            listItem.className = "file-item flex items-center justify-between"; 
            const fileInfo = document.createElement('div');
            fileInfo.className = "flex items-center overflow-hidden mr-2";
            fileInfo.innerHTML = `
              <span class="file-item-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
              </span>
              <span class="file-item-title truncate" title="${escapeHTML(item.title)}">${escapeHTML(item.title)}</span>
            `;
            
            const linkElement = document.createElement('a');
            let url = item.link || "#";
            if (url && url !== "#" && !url.toLowerCase().startsWith("http://") && !url.toLowerCase().startsWith("https://") && !url.startsWith("/")) {
                if (url.includes('.') && !url.includes(' ') && !url.startsWith('//')) {
                     url = `https://${url}`; 
                }
            }
            linkElement.href = url;
            if (item.link && url !== "#") linkElement.target = "_blank";
            linkElement.rel = "noopener noreferrer";
            linkElement.className = "file-item-link"; 
            linkElement.textContent = item.link ? "Open Link" : "No Link"; // More descriptive
            if (!item.link || url === "#") linkElement.classList.add("disabled");
            
            listItem.appendChild(fileInfo);
            listItem.appendChild(linkElement);
            filesList.appendChild(listItem);
          }
        });
        if (hasFolders) contentContainer.appendChild(grid);
        if (hasFiles) {
          if (hasFolders) {
            const separator = document.createElement('hr');
            separator.className = "my-6 sm:my-8 border-[var(--border-primary)] opacity-50"; 
            contentContainer.appendChild(separator);
          }
          const filesHeader = document.createElement('h3');
          filesHeader.className = "text-lg sm:text-xl font-medium text-[var(--text-card-header)] mb-3 sm:mb-4"; 
          filesHeader.textContent = "Files / Pages";
          contentContainer.appendChild(filesHeader);
          contentContainer.appendChild(filesListContainer); 
        }
      }
    
      // --- Search Functionality ---
      let searchDebounceTimer;
      if (searchInput) {
        searchInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                handleSearch(searchInput.value);
            }, 300);
        });
      }
    
      function handleSearch(term) { 
          const searchTerm = term.trim().toLowerCase();
          if (!searchTerm) {
              isCurrentlySearching = false;
              displayNodes(currentViewNodeId); 
              return;
          }
          isCurrentlySearching = true;
          if (breadcrumbContainer) breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Searching for "${escapeHTML(searchTerm)}"...</li>`;
          updateBackButtonVisibility(); 
          const matches = [];
          collectAllMatchingItems(fullTreeData, searchTerm, [], matches);
          displayDirectSearchResults(matches, searchTerm);
      }
    
      function collectAllMatchingItems(nodes, term, currentTrail, matches) { 
          if (!Array.isArray(nodes)) return;
          nodes.forEach(node => {
              const nodePathSegment = { id: node.id, name: node.name };
              const pathToNode = [...currentTrail, nodePathSegment];
              if (node.name && node.name.toLowerCase().includes(term)) {
                  matches.push({ item: node, path: pathToNode, type: 'folder' });
              }
              if (node.artifacts && Array.isArray(node.artifacts)) {
                  node.artifacts.forEach(artifact => {
                      if (artifact.title && artifact.title.toLowerCase().includes(term)) {
                          matches.push({ item: artifact, path: pathToNode, type: 'file' });
                      }
                  });
              }
              if (node.children && Array.isArray(node.children)) {
                  collectAllMatchingItems(node.children, term, pathToNode, matches);
              }
          });
      }
    
      function displayDirectSearchResults(matches, searchTerm) { 
          if (!contentContainer) return;
          contentContainer.innerHTML = ""; 
          if (matches.length === 0) {
              contentContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)] py-8">No items found matching "${escapeHTML(searchTerm)}".</p>`;
              return;
          }
          const resultsList = document.createElement('ul');
          resultsList.className = "search-results-container"; 
          
          matches.forEach(matchData => {
              const { item, path, type } = matchData;
              const listItem = document.createElement('li');
              listItem.className = "search-result-item flex items-center justify-between"; 
              
              const itemInfo = document.createElement('div');
              itemInfo.className = "flex items-center overflow-hidden mr-2"; 
              const iconHTML = type === 'folder' ? 
                `<span class="search-result-icon" style="color: var(--text-yellow-accent);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg></span>` :
                `<span class="search-result-icon" style="color: var(--text-blue-accent);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg></span>`;
              
              const itemName = type === 'folder' ? item.name : item.title;
              // Construct full path string for display, starting from "Home"
              const displayPathArray = [{name: "Home"}];
              path.forEach(p => displayPathArray.push({name: p.name})); // path from collectAllMatchingItems is already relative to root items
              
              if (type === 'file') {
                 // The 'path' for a file result is the path to its parent folder.
                 // We add the file's own name to the display path.
                 displayPathArray.push({name: item.title}); 
              }
              // For a folder, the last element in 'path' is the folder itself, so displayPathArray is correct.

              itemInfo.innerHTML = `
                  ${iconHTML}
                  <div class="flex flex-col overflow-hidden">
                      <span class="search-result-name truncate" title="${escapeHTML(itemName)}">${highlightText(itemName, searchTerm)}</span>
                      <span class="search-result-path truncate" title="Path: ${displayPathArray.map(p=>p.name).join(' / ')}">
                          ${displayPathArray.map(p=>p.name).join(' / ')}
                      </span>
                  </div>
              `;
              
              listItem.appendChild(itemInfo);
              listItem.onclick = () => {
                  if(searchInput) searchInput.value = ""; 
                  isCurrentlySearching = false; 
                  if (type === 'folder') {
                      currentPath = [{id: null, name: "Home"}, ...path]; 
                      currentViewNodeId = item.id;
                      displayNodes(item.id);
                  } else { 
                      currentPath = [{id: null, name: "Home"}, ...path]; 
                      currentViewNodeId = path[path.length-1].id; 
                      displayNodes(currentViewNodeId);
                  }
              };
              resultsList.appendChild(listItem);
          });
          contentContainer.appendChild(resultsList);
      }
    
      // --- Back Button Logic ---
      function handleBackButton() { 
        if (!isCurrentlySearching && currentPath.length > 1) {
            if(searchInput) searchInput.value = ""; 
            isCurrentlySearching = false;
            currentPath.pop();
            const previousCrumb = currentPath[currentPath.length - 1];
            currentViewNodeId = previousCrumb.id;
            displayNodes(currentViewNodeId);
        }
      }
      if (backButton) {
        backButton.addEventListener('click', handleBackButton);
      }
    
      // --- Logout Button Logic ---
      if (logoutButton) {
          logoutButton.addEventListener("click", async () => {
              if (firebaseAuthUser) {
                  try {
                      await firebaseAuthUser.signOut();
                      sessionStorage.removeItem("user_token"); 
                      if(window.showNotification) window.showNotification("You have been logged out.", "success");
                      window.location.href = "user_login.html"; 
                  } catch (error) {
                      console.error("Error signing out user:", error);
                      if(window.showNotification) window.showNotification("Logout failed. Please try again.", "error");
                  }
              }
          });
      }
    
      // --- Initial Load & Auth State Handling ---
      async function initializeUserView() { 
        if (contentContainer) contentContainer.innerHTML = '<div class.loading-placeholder">Loading initial content...</div>';
        else { console.error("Content container not found for user page."); return; }
    
        const tokenFromLogin = sessionStorage.getItem("user_token"); 
        if (!tokenFromLogin && firebaseAuthUser && !firebaseAuthUser.currentUser) {
            console.log("No user token found, redirecting to user login.");
            if (!window.location.pathname.endsWith("user_login.html")) {
                window.location.href = "user_login.html";
            }
            return; 
        }
        
        try {
          const res = await secureUserFetch(`${BASE}/api/tree`); 
          if (!res.ok) {
            const errorText = await res.text();
            let errorDetail = res.statusText;
            try { const errData = JSON.parse(errorText); errorDetail = errData.error || errData.message || errorDetail; } catch(e){}
            throw new Error(`HTTP error ${res.status}: ${errorDetail}`);
          }
          fullTreeData = await res.json();
          if (!Array.isArray(fullTreeData)) {
              console.error("Fetched tree data is not an array:", fullTreeData);
              fullTreeData = [];
              throw new Error("Invalid tree data format from server.");
          }
          currentViewNodeId = null;
          currentPath = [{ id: null, name: "Home" }];
          isCurrentlySearching = false;
          displayNodes(null); 
        } catch (error) {
          console.error("Failed to fetch initial tree data for user page:", error);
          if(contentContainer) contentContainer.innerHTML = `<p class="text-center text-[var(--text-red-accent)] p-4">Error loading knowledge base: ${error.message}. Please try again later.</p>`;
          if(window.showNotification) showNotification(`Error loading data: ${error.message}`, "error", 7000);
        }
      }
    
      if (firebaseAuthUser) {
          firebaseAuthUser.onAuthStateChanged(async (user) => {
              if (user) {
                  console.log("User Page: User is signed in -", user.email);
                  try {
                      const token = await user.getIdToken(true);
                      sessionStorage.setItem("user_token", token); 
                      console.log("User Page: Token refreshed/stored in session storage.");
                  } catch (tokenError) {
                      console.error("User Page: Error refreshing token on auth state change:", tokenError);
                  }
                  const contentIsEmptyOrLoading = !contentContainer || contentContainer.children.length === 0 || 
                                                (contentContainer.children.length === 1 && contentContainer.firstElementChild.classList.contains('loading-placeholder'));

                  if (fullTreeData.length === 0 || contentIsEmptyOrLoading) {
                      initializeUserView();
                  }
              } else {
                  console.log("User Page: No user signed in / session ended. Redirecting to login.");
                  sessionStorage.removeItem("user_token");
                  if (!window.location.pathname.endsWith("user_login.html")) {
                      window.location.href = "user_login.html";
                  }
              }
          });
      } else {
          // This block will execute if Firebase SDK itself failed to load or initialize `firebaseAuthUser`
          console.warn("User Page: Firebase Auth instance (firebaseAuthUser) is not available. This might be due to SDK loading or initialization issues. Redirecting to login if not already there.");
          if (!window.location.pathname.endsWith("user_login.html")) {
              // Consider delaying this redirect slightly to allow any initial error messages (like SDK load failure) to be seen by the user or logged.
              // setTimeout(() => { window.location.href = "user_login.html"; }, 500); 
          }
      }
    </script>
  </body>
</html>
