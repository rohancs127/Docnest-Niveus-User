<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocNest - Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
      :root {
        /* Dark Theme (Enhanced) */
        --bg-primary: #111827; /* Slightly richer dark blue-gray */
        --bg-card: #1f2937; /* Darker blue-gray for cards */
        --bg-card-hover: #374151; /* Slightly lighter for hover */
        --bg-input: #374151;
        --bg-input-readonly: #4b5563;
        --bg-button-primary: #3b82f6; /* Vibrant blue for primary actions */
        --bg-button-primary-hover: #2563eb;
        --bg-button-destructive: #ef4444;
        --bg-button-destructive-hover: #dc2626;
        --bg-button-secondary: #4b5563; /* Gray for secondary */
        --bg-button-secondary-hover: #6b7280;
        --bg-action-icon-hover: #4b5563;
        --bg-inline-form: #1f2937;
        --bg-modal-overlay: rgba(0, 0, 0, 0.75);
        --bg-modal-content: #1f2937;
        --bg-toast-success: #10b981; /* Emerald */
        --bg-toast-error: #f43f5e; /* Rose */
        --bg-dropdown-menu: var(--bg-card);
        --bg-breadcrumb: #1f2937; /* Consistent with cards */
        --bg-breadcrumb-hover: #374151;

        --text-primary: #f3f4f6; /* Lighter gray for primary text */
        --text-secondary: #9ca3af; /* Medium gray */
        --text-tertiary: #6b7280; /* Darker gray */
        --text-placeholder: #9ca3af;
        --text-button-primary: #ffffff;
        --text-button-destructive: #ffffff;
        --text-button-secondary: #f3f4f6;
        --text-card-header: #e5e7eb;
        --text-link: #60a5fa;
        --text-link-hover: #93c5fd;
        --text-action-icon: #9ca3af;
        --text-action-icon-hover: #e5e7eb;
        --text-green-accent: #34d399; /* Emerald for icons */
        --text-red-accent: #f87171; /* Red for icons */
        --text-yellow-accent: #f59e0b; /* Amber for folder icons */
        --text-blue-accent: #60a5fa; /* Blue for file icons */
        --text-toast: #ffffff;
        --text-dropdown-item-hover: var(--text-link-hover);

        --border-primary: #374151; /* Softer border */
        --border-card: #4b5563;
        --border-input: #4b5563;
        --border-input-focus: var(--text-link);
        --border-button-primary: transparent; /* Modern buttons often don't have borders */
        --border-button-primary-hover: transparent;
        --border-button-destructive: transparent;
        --border-button-secondary: var(--border-primary);
        --border-preview: #4b5563;
        --border-toast-success: #059669;
        --border-toast-error: #e11d48;
        --border-dropdown-menu: var(--border-primary);
        --border-breadcrumb: var(--border-primary);

        --shadow-card-item: 0 4px 6px -1px rgba(0, 0, 0, 0.3),
          0 2px 4px -2px rgba(0, 0, 0, 0.3);
        --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.3),
          0 4px 6px -4px rgba(0, 0, 0, 0.3);
        --shadow-input-focus: 0 0 0 2px var(--text-link); /* Softer focus ring */
        --shadow-modal: 0 20px 25px -5px rgba(0, 0, 0, 0.4),
          0 8px 10px -6px rgba(0, 0, 0, 0.4);
        --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.5);
        --shadow-dropdown: 0 10px 15px -3px rgba(0, 0, 0, 0.2),
          0 4px 6px -2px rgba(0, 0, 0, 0.1);

        --scrollbar-thumb: #4b5563;
        --scrollbar-track: #1f2937;
      }

      .light-theme {
        --bg-primary: #f9fafb; /* Very light gray */
        --bg-card: #ffffff;
        --bg-card-hover: #f3f4f6; /* Slightly off-white for hover */
        --bg-input: #ffffff;
        --bg-input-readonly: #e5e7eb;
        --bg-button-primary: #2563eb; /* Stronger blue for primary */
        --bg-button-primary-hover: #1d4ed8;
        --bg-button-destructive: #ef4444;
        --bg-button-destructive-hover: #dc2626;
        --bg-button-secondary: #e5e7eb; /* Light gray for secondary */
        --bg-button-secondary-hover: #d1d5db;
        --bg-action-icon-hover: #e5e7eb;
        --bg-inline-form: #f9fafb;
        --bg-modal-overlay: rgba(
          17,
          24,
          39,
          0.6
        ); /* Darker overlay for better contrast */
        --bg-modal-content: #ffffff;
        --bg-toast-success: #ecfdf5; /* Lighter green bg */
        --bg-toast-error: #fff1f2; /* Lighter red bg */
        --bg-dropdown-menu: var(--bg-card);
        --bg-breadcrumb: #ffffff;
        --bg-breadcrumb-hover: #f3f4f6;

        --text-primary: #1f2937; /* Dark gray for primary text */
        --text-secondary: #4b5563; /* Medium gray */
        --text-tertiary: #6b7280; /* Lighter gray */
        --text-placeholder: #9ca3af;
        --text-button-primary: #ffffff;
        --text-button-destructive: #ffffff;
        --text-button-secondary: #374151; /* Darker text for light secondary button */
        --text-card-header: #111827;
        --text-link: #2563eb;
        --text-link-hover: #1d4ed8;
        --text-action-icon: #6b7280;
        --text-action-icon-hover: #1f2937;
        --text-green-accent: #059669;
        --text-red-accent: #e11d48;
        --text-yellow-accent: #f59e0b;
        --text-blue-accent: #3b82f6;
        --text-toast: #065f46; /* Darker green text for success toast */
        --text-toast-error: #c2410c; /* Darker red text for error toast */
        --text-dropdown-item-hover: var(--text-link);

        --border-primary: #e5e7eb; /* Lighter border */
        --border-card: #e5e7eb;
        --border-input: #d1d5db;
        --border-input-focus: var(--text-link);
        --border-button-secondary: #d1d5db;
        --border-preview: #e5e7eb;
        --border-toast-success: #6ee7b7;
        --border-toast-error: #fda4af;
        --border-dropdown-menu: var(--border-primary);
        --border-breadcrumb: var(--border-primary);

        --shadow-card-item: 0 4px 6px -1px rgba(0, 0, 0, 0.07),
          0 2px 4px -2px rgba(0, 0, 0, 0.07);
        --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.07),
          0 4px 6px -4px rgba(0, 0, 0, 0.07);
        --shadow-input-focus: 0 0 0 2px var(--text-link);
        --shadow-modal: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 8px 10px -6px rgba(0, 0, 0, 0.1);
        --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-dropdown: 0 10px 15px -3px rgba(0, 0, 0, 0.05),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);

        --scrollbar-thumb: #d1d5db;
        --scrollbar-track: #f3f4f6;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      #folder-content-container {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(260px, 1fr)
        ); /* Slightly smaller min for more items */
        gap: 1.25rem; /* Reduced gap slightly */
      }

      .item-card,
      .search-result-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-card);
        border-radius: 0.75rem; /* More rounded */
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between; 
        transition: all 0.2s ease-in-out; /* Smoother all transitions */
        box-shadow: var(--shadow-card-item);
        cursor: pointer;
        position: relative; /* For absolute positioned actions if needed */
        min-height: 120px; /* Ensure cards have some min height */
      }
      .item-card:hover,
      .search-result-card:hover {
        transform: translateY(-5px) scale(1.02); /* More pronounced hover */
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
        border-color: var(--text-link); /* Highlight border on hover */
      }
      .light-theme .item-card:hover,
      .light-theme .search-result-card:hover {
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
      }

      .item-card-icon-wrapper {
        /* Wrapper for icon */
        display: flex;
        align-items: center;
        justify-content: center;
        width: 3rem; /* 48px */
        height: 3rem; /* 48px */
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        background-color: rgba(127, 127, 127, 0.1); /* Subtle background */
      }
      .item-card-icon svg,
      .search-result-icon svg {
        width: 1.75rem; /* 28px */
        height: 1.75rem;
      }

      .item-card-name,
      .search-result-name {
        font-weight: 600; /* Semibold */
        font-size: 1rem; /* Slightly larger */
        color: var(--text-primary);
        margin-bottom: 0.375rem;
        word-break: break-word;
        line-height: 1.4;
      }
      .item-card-name .highlight,
      .search-result-name .highlight {
        background-color: var(--text-yellow-accent);
        color: var(--bg-card) !important; /* Ensure contrast */
        padding: 1px 3px;
        border-radius: 3px;
        font-weight: 700;
      }
      .light-theme .item-card-name .highlight,
      .light-theme .search-result-name .highlight {
        background-color: #fef9c3; /* Lighter yellow for highlight bg */
        color: #713f12 !important; /* Darker text for highlight on light bg */
      }

      .item-card-type,
      .search-result-type {
        font-size: 0.8rem;
        color: var(--text-tertiary);
      }
      .search-result-path {
        font-size: 0.75rem;
        color: var(--text-link);
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        word-break: break-word;
        line-height: 1.3;
      }
      .item-card-actions {
        margin-top: auto;
        padding-top: 1rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }
      .item-card:hover .item-card-actions {
        opacity: 1;
      }

      /* Styles for Artifact List Items */
.artifact-list-item {
    background-color: var(--bg-card);
    border: 1px solid var(--border-card);
    border-radius: 0.5rem; /* Slightly less rounded than cards for a list feel */
    padding: 0.75rem 1rem;
    margin-bottom: 0.75rem; /* Space between list items */
    transition: background-color 0.2s ease;
}

/* No hover effect needed if click toggles */
/* .artifact-list-item:hover {
    background-color: var(--bg-card-hover);
} */

.artifact-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer; /* Indicate the header is clickable for dropdown */
}

.artifact-icon svg {
    width: 1.25rem; /* 20px */
    height: 1.25rem;
    flex-shrink: 0;
    color: var(--text-blue-accent); /* Default file icon color */
}

.artifact-title {
    font-weight: 500;
    color: var(--text-primary);
    flex-grow: 1;
    word-break: break-word;
}

.artifact-actions {
    display: flex;
    gap: 0.25rem; /* Smaller gap for icon buttons */
    margin-left: auto; /* Pushes actions to the right */
}
.artifact-actions .action-icon-btn { /* Reduce padding for actions in list */
    padding: 0.3rem;
}


.artifact-dropdown-arrow {
    font-size: 0.8rem;
    color: var(--text-secondary);
    transition: transform 0.2s ease;
    padding: 0.25rem;
    margin-left: 0.5rem; /* Space from actions */
}

.artifact-dropdown-arrow.expanded {
    transform: rotate(180deg);
}

.artifact-description {
    padding: 0.75rem 0 0.25rem 0;
    /* Align with title: icon width (1.25rem) + gap (0.75rem) */
    margin-left: calc(1.25rem + 0.75rem);
    font-size: 0.875rem;
    color: var(--text-secondary);
    border-top: 1px solid var(--border-input);
    margin-top: 0.75rem;
    line-height: 1.6;
}
.artifact-description p {
    margin-bottom: 0.5rem;
}
.artifact-description .artifact-link { /* For the "Go to Resource" link inside the description */
    font-size: 0.8rem !important; /* Tailwind overrides can be tricky */
    padding: 0.25rem 0.6rem !important;
    margin-top: 0.25rem;
    display: inline-flex; /* For icon alignment */
    align-items: center;
}
.artifact-description .artifact-link svg {
    width: 0.75rem; /* 12px */
    height: 0.75rem;
}


/* If all items are artifacts, make container a block */
#folder-content-container.list-view-only {
    display: block;
}

/* Styles for PartnerBU Readme */
#partnerbu-readme-container {
    padding: 1.5rem;
    border: 1px solid var(--border-primary);
    margin-bottom: 1.5rem;
    border-radius: 0.75rem; /* Match card radius */
    background-color: var(--bg-inline-form); /* Slightly different for emphasis */
    box-shadow: var(--shadow-card-item);
}
#partnerbu-readme-container h3 {
    font-size: 1.25rem; /* Tailwind text-xl */
    font-weight: 600; /* Tailwind semibold */
    color: var(--text-card-header);
    border-bottom: 1px solid var(--border-input);
    padding-bottom: 0.75rem;
    margin-bottom: 1rem;
}
#partnerbu-readme-container img {
    max-width: 100%;
    height: auto;
    border-radius: 0.375rem; /* Tailwind rounded-md */
    display: block;
    margin-left: auto;
    margin-right: auto;
    border: 1px solid var(--border-input);
    padding: 0.25rem; /* Small padding around image */
    background-color: var(--bg-primary); /* Background for the image padding */
    margin-bottom: 1rem;
}
#partnerbu-readme-container p.readme-text {
    font-size: 0.9rem; /* Tailwind text-sm */
    color: var(--text-secondary);
    line-height: 1.6;
}

      /* Styles for artifact description in cards */
      .item-card-description,
.search-result-description {
    font-size: 0.8rem;
        color: var(--text-secondary);
    margin-top: 0.5rem; /* Was 0.75rem */
    max-height: 63px; /* Approx 3 lines with 1.5 line height and padding */
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
    word-break: break-word;
    line-height: 1.5; /* Increased for better readability */
    padding: 0.5rem 0.75rem; /* Added padding for internal spacing */
    border-radius: 0.375rem; /* Tailwind: rounded-md */
    border: 1px solid transparent; /* Prepare for potential border on hover/focus */
    transition: background-color 0.2s ease, border-color 0.2s ease;
}

      .item-card-description::-webkit-scrollbar,
      .search-result-description::-webkit-scrollbar {
        width: 6px;
      }

      .item-card-description::-webkit-scrollbar-track,
      .search-result-description::-webkit-scrollbar-track {
        background: var(--scrollbar-track);
        border-radius: 3px;
      }

      .item-card-description::-webkit-scrollbar-thumb,
      .search-result-description::-webkit-scrollbar-thumb {
        background-color: var(--scrollbar-thumb);
        border-radius: 3px;
      }

      /* Ensure item-card content pushes actions to the bottom */
      .item-card > div:first-child {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* Allows this div to take available space */
      }

      #breadcrumb-container {
        background-color: transparent; /* Cleaner look */
        padding: 0.5rem 0; /* Adjusted padding */
        margin-bottom: 1.5rem;
        border: none; /* Removed border */
        border-bottom: 1px solid var(--border-primary); /* Underline instead */
        border-radius: 0;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
      }
      .breadcrumb-item {
        color: var(--text-link);
        text-decoration: none;
        cursor: pointer;
        font-size: 0.9rem;
        transition: color 0.2s ease;
      }
      .breadcrumb-item:hover {
        text-decoration: underline;
        color: var(--text-link-hover);
      }
      .breadcrumb-separator {
        margin: 0 0.6rem;
        color: var(--text-tertiary);
        font-size: 0.8rem;
      }
      .breadcrumb-current {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 0.9rem;
      }
      #add-item-form-container {
        background-color: var(--bg-card); /* Match card bg */
        padding: 1.5rem;
        border-radius: 0.75rem; /* Match card radius */
        margin-bottom: 2rem; /* More space */
        border: 1px solid var(--border-card);
        box-shadow: var(--shadow-card-item);
      }
      #current-folder-header h2 {
        font-weight: 700; /* Bolder current folder name */
      }

      /* Other styles */
      .form-inline input,
      .form-inline select,
      .form-inline textarea {
        margin-bottom: 0.75rem;
      }
      #artifact-details-modal-description {
        max-height: 200px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
      }
      #artifact-details-modal-description::-webkit-scrollbar {
        width: 6px;
      }
      #artifact-details-modal-description::-webkit-scrollbar-track {
        background: var(--scrollbar-track);
      }
      #artifact-details-modal-description::-webkit-scrollbar-thumb {
        background-color: var(--scrollbar-thumb);
        border-radius: 3px;
      }
      .submit-button {
        /* Refined button style */
        font-weight: 500;
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px -1px rgba(0, 0, 0, 0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent; /* Default no border */
      }
      .submit-button.primary {
        background-color: var(--bg-button-primary);
        color: var(--text-button-primary);
      }
      .submit-button.primary:hover {
        background-color: var(--bg-button-primary-hover);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .submit-button.secondary {
        background-color: var(--bg-button-secondary);
        color: var(--text-button-secondary);
        border-color: var(--border-button-secondary);
      }
      .submit-button.secondary:hover {
        background-color: var(--bg-button-secondary-hover);
      }

      .submit-button.destructive {
        background-color: var(--bg-button-destructive);
        color: var(--text-button-destructive);
      }
      .submit-button.destructive:hover {
        background-color: var(--bg-button-destructive-hover);
      }

      .submit-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .spinner {
        animation: spin 1s linear infinite;
        border: 2px solid currentColor;
        border-top-color: transparent;
        border-radius: 50%;
        width: 1em;
        height: 1em;
        margin-right: 0.5em;
      }

      .input-field,
      textarea.input-field {
        background-color: var(--bg-input);
        color: var(--text-primary);
        border: 1px solid var(--border-input);
        border-radius: 0.5rem; /* More rounded */
        padding: 0.6rem 0.9rem; /* Adjusted padding */
      }
      textarea.input-field {
        min-height: 70px;
      }
      .input-field::placeholder,
      textarea.input-field::placeholder {
        color: var(--text-placeholder);
        opacity: 0.8;
      }
      .input-field:focus,
      textarea.input-field:focus {
        border-color: var(--border-input-focus);
        outline: none;
        box-shadow: var(--shadow-input-focus);
        background-color: var(--bg-card);
      } /* Change bg on focus too */

      .label-text {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0.375rem;
      }
      .card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 0.75rem;
        box-shadow: var(--shadow-card);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      .card-header {
        color: var(--text-card-header);
        font-weight: 700;
      } /* Bolder card headers */

      .action-icon-btn {
        color: var(--text-action-icon);
        padding: 0.4rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease-in-out;
        flex-shrink: 0;
      }
      .action-icon-btn:hover {
        color: var(--text-action-icon-hover);
        background-color: var(--bg-action-icon-hover);
        transform: scale(1.1);
      }
      .action-icon-btn.add {
        color: var(--text-green-accent);
      }
      .action-icon-btn.delete {
        color: var(--text-red-accent);
        position: relative;
        bottom: 0px;
      }

      #theme-toggle-button {
        background-color: var(--bg-card);
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
        padding: 0.5rem;
        border-radius: 0.5rem;
      }
      #theme-toggle-button:hover {
        background-color: var(--bg-card-hover);
        color: var(--text-primary);
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-modal-overlay);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 1000;
      }
      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: var(--bg-modal-content);
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: var(--shadow-modal);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.95) translateY(10px);
        transition: transform 0.3s ease, opacity 0.3s ease;
        opacity: 0;
      }
      .modal-overlay.active .modal-content {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-primary);
        padding-bottom: 1rem;
      }
      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-card-header);
      }
      .modal-close-btn {
        background: none;
        border: none;
        font-size: 1.75rem;
        cursor: pointer;
        color: var(--text-tertiary);
        transition: color 0.2s ease;
        line-height: 1;
      }
      .modal-close-btn:hover {
        color: var(--text-primary);
      }

      #search-input-wrapper {
        position: relative;
      } /* For search icon */
      #search-input {
        width: 100%;
        max-width: 400px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        padding-left: 2.8rem; /* Space for icon */
      }
      #search-input-icon {
        position: absolute;
        left: 0rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-placeholder);
        pointer-events: none;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .user-menu-container {
        position: relative;
      }
      #user-menu-button {
        background-color: var(--bg-card);
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      #user-menu-button:hover {
        background-color: var(--bg-card-hover);
        color: var(--text-primary);
      }
      #user-dropdown-menu {
        background-color: var(--bg-dropdown-menu);
        border: 1px solid var(--border-dropdown-menu);
        box-shadow: var(--shadow-dropdown);
        z-index: 1010;
        border-radius: 0.5rem;
        overflow: hidden;
      }
      #user-dropdown-menu button:hover {
        background-color: var(--bg-card-hover);
        color: var(--text-dropdown-item-hover);
      }
      #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      } /* Increased gap */
      .toast {
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: var(--text-toast);
        box-shadow: var(--shadow-toast);
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        border-width: 1px;
        border-style: solid;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.success {
        background-color: var(--bg-toast-success);
        border-color: var(--border-toast-success);
        color: var(--text-toast, #ffffff);
      }
      .light-theme .toast.success {
        color: var(--text-toast, #065f46);
      }
      .toast.error {
        background-color: var(--bg-toast-error);
        border-color: var(--border-toast-error);
        color: var(--text-toast, #ffffff);
      }
      .light-theme .toast.error {
        color: var(--text-toast-error, #c2410c);
      }
      .toast-icon {
        flex-shrink: 0;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #back-button{
        transition: 0.2s;
      }

    </style>
  </head>
  <body>
    <div id="toast-container"></div>
    <div class="container mx-auto p-4 md:p-8">
      <header
        class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4 pb-6 border-b border-[var(--border-primary)]"
      >
        <div class="flex items-center">
          <img
            id="user-page-logo"
            src="https://niveussolutions.com/wp-content/uploads/2025/02/Niveus-ntt-data.png"
            alt="DocNest Logo"
            class="h-12 w-auto mr-3 pt-3"
          />
          <h1
            class="text-3xl sm:text-4xl font-extrabold tracking-tight text-[var(--text-card-header)]"
          >
            DocNest KB
          </h1>
        </div>
        <div class="header-controls flex items-center gap-3">
          <div id="search-input-wrapper" class="relative">
            <div
              id="search-input-icon"
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <input
              type="search"
              id="search-input"
              class="input-field"
              placeholder="Search knowledge base..."
            />
          </div>
          <button
            id="theme-toggle-button"
            class="p-2.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--border-input-focus)] flex-shrink-0"
            title="Toggle Theme"
          ></button>
          <div class="user-menu-container">
            <button
              id="user-menu-button"
              type="button"
              aria-expanded="false"
              aria-haspopup="true"
              class="p-2.5"
            >
              <span id="user-display-name" class="text-sm font-medium"
                >User</span
              >
              <svg
                class="h-5 w-5 text-[var(--text-tertiary)] ml-1"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
            <div
              id="user-dropdown-menu"
              class="absolute right-0 mt-2 w-64 origin-top-right rounded-md bg-[var(--bg-dropdown-menu)] shadow-lg ring-1 ring-[var(--border-dropdown-menu)] ring-opacity-5 focus:outline-none hidden"
              role="menu"
              aria-orientation="vertical"
              aria-labelledby="user-menu-button"
            >
              <div class="py-1" role="none">
                <div class="px-4 py-3 border-b border-[var(--border-primary)]">
                  <p
                    class="text-sm font-semibold text-[var(--text-primary)]"
                    id="dropdown-user-name"
                  >
                    User Name
                  </p>
                  <p
                    class="text-xs text-[var(--text-secondary)] truncate"
                    id="dropdown-user-email"
                  >
                    user@example.com
                  </p>
                </div>
                <button
                  id="logout-button-dropdown"
                  class="block w-full px-4 py-2 text-left text-sm text-[var(--text-red-accent)] hover:bg-[var(--bg-card-hover)] hover:text-[var(--text-red-accent)]"
                  role="menuitem"
                >
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="card p-6 sm:p-8 rounded-xl shadow-2xl">
        <div id="breadcrumb-container" class="mb-6"></div>

        <div
          id="current-folder-header"
          class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
        >
         <div class="flex items-center gap-2 md:gap-3"> <button
        id="back-button"
        title="Go Back"
        class="p-2 rounded-md text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-action-icon-hover)] flex-shrink-0"
        style="display: none;"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 md:h-6 md:w-6" 
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
            >
                <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
            </svg>
        </button>
        <h2
            id="current-folder-name"
            class="text-xl md:text-2xl font-bold text-[var(--text-card-header)]"
        >
            Knowledge Base
        </h2>
      </div>
          <button
            id="add-item-to-current-folder-button"
            class="submit-button primary text-sm py-2 px-4 self-start sm:self-center"
            style="display: none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 4v16m8-8H4"
              />
            </svg>
            <span class="button-text">Add Item Here</span>
          </button>
        </div>

        <div
          id="add-item-form-container"
          class="form-inline mb-8 p-6"
          style="display: none"
        ></div>

        <div id="folder-content-container" class="min-h-[300px] relative">
          <div
            id="loading-placeholder"
            class="absolute inset-0 flex items-center justify-center text-center"
          >
            <p class="p-4 text-lg text-[var(--text-secondary)]">
              Loading content...
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="artifact-details-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="artifact-modal-title" class="modal-title">
            Artifact Details
          </h3>
          <button class="modal-close-btn" onclick="closeArtifactDetailsModal()">
            &times;
          </button>
        </div>
        <div class="mb-4">
          <label class="label-text">Description:</label>
          <div
            id="artifact-details-modal-description"
            class="p-3 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-sm min-h-[60px]"
          >
            No description provided.
          </div>
        </div>
        <div class="mt-6 text-right space-x-3">
          <a
            id="artifact-modal-link"
            href="#"
            target="_blank"
            class="submit-button primary inline-block"
          >
            Go to Resource
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 inline-block ml-1.5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              />
            </svg>
          </a>
          <button
            class="submit-button secondary"
            onclick="closeArtifactDetailsModal()"
          >
            <span class="button-text">Close</span>
          </button>
        </div>
      </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ", // If this is a placeholder, replace with your actual API key
      authDomain: "docnest-f85e2.firebaseapp.com",   // Replace with your actual auth domain
      projectId: "docnest-f85e2",                  // Replace with your actual project ID
      storageBucket: "docnest-f85e2.appspot.com",    // Replace with your actual storage bucket
      messagingSenderId: "102395439437",           // Replace with your actual sender ID
      appId: "1:102395439437:web:84e6676388b5d54395af04", // Replace with your actual App ID
      measurementId: "G-YRMBR8BVSE",               // Optional: Replace with your actual Measurement ID
    };

    // --- Global Helper Functions (Toast, Button Loading, Escape, Debounce) ---
    window.showNotification = function (
      message,
      type = "success",
      duration = 3000
    ) {
      const toastContainer = document.getElementById("toast-container");
      if (!toastContainer) return;
      const toast = document.createElement("div");
      toast.classList.add("toast", type);
      let iconHtml = "";
      if (type === "success") {
        iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
      } else if (type === "error") {
        iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.293-10.293a1 1 0 00-1.414 0L9 8.586l-.293-.293a1 1 0 10-1.414 1.414L7.586 10l-.293.293a1 1 0 101.414 1.414L9 11.414l.293.293a1 1 0 001.414-1.414L10.414 10l.293-.293a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`;
      }
      toast.innerHTML = `${iconHtml}<span>${message}</span>`;
      toastContainer.appendChild(toast);
      toast.offsetHeight; // Trigger reflow
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, duration);
    };

    window.setButtonLoading = function (
      button,
      isLoading,
      originalText = null
    ) {
      if (!(button instanceof HTMLElement)) {
        console.error("setButtonLoading: invalid button", button);
        return;
      }
      const buttonTextSpan = button.querySelector(".button-text");
      const defaultOriginal = buttonTextSpan
        ? buttonTextSpan.dataset.originalText || buttonTextSpan.textContent
        : button.dataset.originalText || button.textContent;

      if (isLoading) {
        button.disabled = true;
        if (buttonTextSpan) {
          if (
            originalText !== null &&
            typeof buttonTextSpan.dataset.originalText === "undefined"
          )
            buttonTextSpan.dataset.originalText = defaultOriginal;
          buttonTextSpan.innerHTML = `<span class="spinner"></span>Processing...`;
        } else {
          if (
            originalText !== null &&
            typeof button.dataset.originalText === "undefined"
          )
            button.dataset.originalText = defaultOriginal;
          button.innerHTML = `<span class="spinner"></span>Processing...`;
        }
      } else {
        button.disabled = false;
        if (buttonTextSpan) {
          buttonTextSpan.innerHTML =
            originalText || buttonTextSpan.dataset.originalText || "Submit";
          delete buttonTextSpan.dataset.originalText;
        } else {
          button.innerHTML =
            originalText || button.dataset.originalText || "Submit";
          delete button.dataset.originalText;
        }
      }
    };
    function escapeJSString(str) { 
      if (typeof str !== "string") return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
        .replace(/`/g, "&#96;");
    }
    function debounce(func, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          func.apply(this, args);
        }, delay);
      };
    }
    // --- End Global Helper Functions ---

    // --- Firebase Initialization ---
    let firebaseApp;
    let firebaseAuth;

    // NOTE: This condition means Firebase ONLY initializes if the apiKey IS the placeholder.
    // For production, you'll want to ensure it initializes with your REAL key.
    // A better check for development might be:
    // if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_ACTUAL_PROD_KEY_OR_A_DIFFERENT_PLACEHOLDER")
    if (
      firebaseConfig.apiKey === "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ" // If this IS your key, it's fine. If it's a placeholder, this logic is inverted for production.
    ) {
      console.log("User Page: Attempting Firebase initialization with current key.");
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseAuth = firebase.auth();
        console.log("User Page: Firebase initialized.");
      } catch (e) {
        console.error("User Page: Error initializing Firebase:", e);
        window.showNotification(
          "Critical Error: Auth service init failed.",
          "error",
          10000
        );
      }
    } else {
      console.warn("User Page: Firebase config apiKey is NOT the specific placeholder 'AIzaSy...'. Assuming it's a real key or a different placeholder. Attempting initialization.");
      // If the key is NOT the placeholder, we assume it's the real one and try to init.
      // Or, if it's a different placeholder, it will also go here and likely fail if that other placeholder is invalid.
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseAuth = firebase.auth();
        console.log("User Page: Firebase initialized (key was not the common placeholder).");
      } catch (e) {
         console.error("User Page: Error initializing Firebase (key was not common placeholder):", e);
         window.showNotification(
            "Auth service not configured correctly. Please contact support.",
            "error",
            10000
         );
         if (document.body && !window.location.pathname.endsWith("user_login.html")) {
            document.body.innerHTML =
            '<div style="padding: 20px; text-align: center; font-size: 1.2em; color: red;">Application cannot start: Firebase configuration is missing or invalid.</div>';
         }
      }
    }
    // --- End Firebase Initialization ---

    // --- DOM Elements ---
    const userMenuButton = document.getElementById("user-menu-button");
    const userDisplayNameSpan = document.getElementById("user-display-name");
    const userDropdownMenu = document.getElementById("user-dropdown-menu");
    const dropdownUserName = document.getElementById("dropdown-user-name");
    const dropdownUserEmail = document.getElementById("dropdown-user-email");
    const logoutButtonDropdown = document.getElementById("logout-button-dropdown");
    const searchInputElement = document.getElementById("search-input");
    const breadcrumbContainer = document.getElementById("breadcrumb-container");
    const folderContentContainer = document.getElementById("folder-content-container");
    const addItemToFolderBtn = document.getElementById("add-item-to-current-folder-button");
    const addItemFormContainer = document.getElementById("add-item-form-container");
    const currentFolderNameEl = document.getElementById("current-folder-name");
    const loadingPlaceholder = document.getElementById("loading-placeholder");
    const backButton = document.getElementById("back-button");
    // --- End DOM Elements ---

    // --- Global State ---
    let currentUserRoles = [];
    let fullTreeData = [];
    let currentPath = [];
    let currentViewNodeId = null;
    let isSearchViewActive = false;

    const PARTNERBU_README_ID = 'partnerbu-readme-container'; // Changed ID for clarity
const PARTNERBU_FOLDER_NAME = "PartnerBU"; // Make it a constant
    // --- End Global State ---

    function displayPartnerBuReadme(show, imageUrl = "PLEASE_REPLACE_WITH_YOUR_IMAGE_PATH.png") {
    const existingReadme = document.getElementById(PARTNERBU_README_ID);
    if (existingReadme) {
        existingReadme.remove();
    }

    if (show) {
        const readmeContainer = document.createElement('div');
        readmeContainer.id = PARTNERBU_README_ID;
        // Basic styling will be handled by CSS with this ID
        readmeContainer.innerHTML = `
            <h3><span class="math-inline">\{PARTNERBU\_FOLDER\_NAME\} Overview</h3\>
            <img src="{imageUrl}" alt="PARTNERBU FOLDER NAMEInformation"><pclass="readmeâˆ’text">Thisisaspecialdemonstrationmessageforthe<strong>{PARTNERBU_FOLDER_NAME}</strong> folder. The image above is a placeholder; please ensure the path is correct. This content is shown only for demo purposes when viewing this specific folder.</p>`;
            const currentFolderHeader = document.getElementById('current-folder-header');
        if (currentFolderHeader && currentFolderHeader.parentNode) {
            // Insert after the current folder header, before add item form or content grid
            currentFolderHeader.parentNode.insertBefore(readmeContainer, currentFolderHeader.nextSibling);
        } else {
            const folderContentArea = document.getElementById('folder-content-container');
            if (folderContentArea && folderContentArea.parentNode) {
                folderContentArea.parentNode.insertBefore(readmeContainer, folderContentArea);
            }
        }
    }
}


function customSortItems(a, b) {
    const aIsFolder = a.itemType === 'folder';
    const bIsFolder = b.itemType === 'folder';

    // Folders always come before files
    if (aIsFolder && !bIsFolder) return -1;
    if (!aIsFolder && bIsFolder) return 1;

    // Both are folders or both are artifacts, apply number/alpha sort
    const nameA = (a.name || a.title || '').toString();
    const nameB = (b.name || b.title || '').toString();

    const numRegex = /^(\d+)/;
    const matchA = nameA.match(numRegex);
    const matchB = nameB.match(numRegex);

    const numA = matchA ? parseInt(matchA[1], 10) : null;
    const numB = matchB ? parseInt(matchB[1], 10) : null;

    if (numA !== null && numB !== null) {
        if (numA !== numB) return numA - numB;
        // If numbers are the same, sort alphabetically on the rest of the name
        const restA = nameA.substring(matchA[1].length).trim().toLowerCase();
        const restB = nameB.substring(matchB[1].length).trim().toLowerCase();
        return restA.localeCompare(restB);
    }
    if (numA !== null && numB === null) return -1; // Numbered items first
    if (numA === null && numB !== null) return 1;

    // No leading numbers or both had identical leading numbers, sort alphabetically
    return nameA.toLowerCase().localeCompare(nameB.toLowerCase());
}

function navigateToFolder(nodeId) {
    // Clear PartnerBU readme before processing new folder view
    displayPartnerBuReadme(false); // ADD THIS LINE AT THE START

    currentViewNodeId = (nodeId === undefined || nodeId === null || nodeId === "null") ? null : String(nodeId);

    if (!isSearchViewActive && searchInputElement) searchInputElement.value = "";

    let newPath;
    if (currentViewNodeId === null) {
        newPath = [{ id: null, name: "Knowledge Base" }];
    } else {
        const pathSegments = buildPathSegmentsRecursive(currentViewNodeId, fullTreeData, []);
        if (pathSegments && pathSegments.length > 0) {
            newPath = [{ id: null, name: "Knowledge Base" }, ...pathSegments];
        } else {
            console.warn(`User Page: Node ID ${currentViewNodeId} not found for path. Navigating to root.`);
            newPath = [{ id: null, name: "Knowledge Base" }];
            currentViewNodeId = null;
        }
    }
    currentPath = newPath;

    const currentFolderObject = findNodeInTree(currentViewNodeId, fullTreeData); // Get the folder object early

    // Conditionally display PartnerBU readme AFTER path and folder object are determined
    if (currentFolderObject && currentFolderObject.name === PARTNERBU_FOLDER_NAME && !isSearchViewActive) {
         // IMPORTANT: Replace "YOUR_IMAGE_PATH_HERE.png" with the actual path to your image
        displayPartnerBuReadme(true, "YOUR_IMAGE_PATH_HERE.png");
    }

    renderBreadcrumbs();
    if (!isSearchViewActive) {
        renderFolderContents(); // This will use currentViewNodeId
    }

    // Update folder name display
    if(currentFolderNameEl) currentFolderNameEl.textContent = currentFolderObject ? currentFolderObject.name : "Knowledge Base";

    if (backButton) {
        if (currentPath.length > 1 && !isSearchViewActive) {
            backButton.style.display = "inline-flex";
            backButton.onclick = () => {
                if (currentPath.length > 1) {
                    const parentSegment = currentPath[currentPath.length - 2];
                    navigateToFolder(parentSegment.id);
                }
            };
        } else {
            backButton.style.display = "none";
        }
    }

    if (addItemToFolderBtn) {
        const nodeIdForPermissionCheck = currentViewNodeId === null ? null : String(currentViewNodeId);
        if (nodeIdForPermissionCheck !== null && canAddContentToNode(nodeIdForPermissionCheck) && !isSearchViewActive) {
            addItemToFolderBtn.style.display = "inline-flex";
            addItemToFolderBtn.onclick = () => toggleAddItemForm(true);
        } else {
            addItemToFolderBtn.style.display = "none";
            toggleAddItemForm(false);
        }
    }
}



    // ================================================================
    // DYNAMIC BACKEND URL CONFIGURATION
    // ================================================================
    let BASE_API_URL; // This will hold the chosen base URL for API calls
    const localBaseUrl = "http://localhost:8000"; // NO TRAILING SLASH. Your local backend.

    // IMPORTANT: Replace this placeholder with your *actual* Cloud Run service URL
    const cloudRunBaseUrl = "https://docnest-780614596615.asia-south1.run.app"; // NO TRAILING SLASH. Example: "https://docnest-user-backend-xyz.a.run.app"

    if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      BASE_API_URL = localBaseUrl;
      console.log("USER PAGE: Using LOCAL backend API base:", BASE_API_URL);
    } else {
      BASE_API_URL = cloudRunBaseUrl;
      console.log("USER PAGE: Using CLOUD backend API base:", BASE_API_URL);

      // Safety check for placeholder Cloud Run URL when not on localhost
      if (cloudRunBaseUrl.includes("your-userpage-backend-url") || // Check against the placeholder string
          cloudRunBaseUrl.includes("your-actual-cloud-run-url")) { // Add any other common placeholder patterns you might use
          const warningMessage = "CRITICAL: User Page Cloud Run URL (BASE_API_URL) is a placeholder! API calls will likely fail. Please update 'cloudRunBaseUrl' in the userpage.html script.";
          console.error(warningMessage);
          if (window.showNotification) { // Ensure showNotification is defined
              window.showNotification(warningMessage, "error", 60000); // Display for a long time
          } else {
              alert(warningMessage); // Fallback
          }
          // Optionally, disable functionality or halt further data loading
          if (loadingPlaceholder) {
            loadingPlaceholder.innerHTML = `<p class="p-4 text-lg text-[var(--text-red-accent)]">${warningMessage}</p>`;
            loadingPlaceholder.style.display = "flex";
          }
      }
    }
    // ================================================================

    // --- Authentication & Authorization ---
    if (firebaseAuth) { // Check if Firebase Auth was initialized
      firebaseAuth.onAuthStateChanged(async (user) => {
        if (user) {
          console.log("User Page: User is signed in.", user.email);
          if (userDisplayNameSpan)
            userDisplayNameSpan.textContent =
              user.displayName || user.email.split("@")[0];
          if (dropdownUserName)
            dropdownUserName.textContent = user.displayName || "N/A";
          if (dropdownUserEmail) dropdownUserEmail.textContent = user.email;
          
          // Check if BASE_API_URL is properly configured before loading data
          if (BASE_API_URL && (!BASE_API_URL.includes("your-userpage-backend-url") && !BASE_API_URL.includes("your-actual-cloud-run-url"))) {
            await loadInitialDataConcurrently();
          } else {
            console.error("User Page: Backend API URL is not properly configured. Halting data load.");
            if (loadingPlaceholder) {
                loadingPlaceholder.innerHTML = `<p class="p-4 text-lg text-[var(--text-red-accent)]">Application error: Backend service URL is not configured. Please contact support.</p>`;
                loadingPlaceholder.style.display = "flex";
            }
             // Optionally sign out user as they can't proceed
            if(firebaseAuth) await firebaseAuth.signOut().catch(e => console.error("Error signing out due to config issue:", e));
            // Redirecting here might be too aggressive if onAuthStateChanged handles it below.
          }
        } else {
          console.log("User Page: No user signed in. Redirecting to user_login.html.");
          sessionStorage.removeItem("userToken"); // Use "userToken" for consistency
          currentUserRoles = [];
          fullTreeData = [];
          if (!window.location.pathname.endsWith("user_login.html")) {
            window.location.href = "user_login.html";
          }
        }
      });
    } else {
        // This block executes if Firebase Auth itself failed to initialize (e.g. bad config)
        console.error("User Page: Firebase Auth service is not available. Cannot proceed.");
        if (!window.location.pathname.endsWith("user_login.html")) {
            if (loadingPlaceholder) { // Check if element exists
                loadingPlaceholder.innerHTML =
                '<p class="p-4 text-lg text-[var(--text-red-accent)]">Authentication service failed to initialize. Please check configuration or contact support. You may need to <a href="user_login.html" class="text-[var(--text-link)]">login again</a>.</p>';
                loadingPlaceholder.style.display = "flex";
            }
            // Fallback redirect if UI cannot be updated
            setTimeout(() => {
                if (!window.location.pathname.endsWith("user_login.html")) {
                     window.location.href = "user_login.html";
                }
            }, 3000);
        }
    }

    async function getAuthToken() {
      if (!firebaseAuth || !firebaseAuth.currentUser) {
        console.warn("User Page: No Firebase current user for token request. Redirecting to login.");
        if (!window.location.pathname.endsWith("user_login.html")) {
            window.location.href = "user_login.html"; // Ensure redirect if no user
        }
        return null;
      }
      try {
        const token = await firebaseAuth.currentUser.getIdToken(true); // Force refresh
        sessionStorage.setItem("userToken", token); // Using "userToken" for consistency
        return token;
      } catch (error) {
        console.error("User Page: Error getting ID token:", error);
        window.showNotification(
          "Your session may have expired. Please try logging in again.",
          "error",
          5000
        );
        if (firebaseAuth) {
          await firebaseAuth.signOut().catch((e) => console.error("User Page: Signout failed after token error", e));
          // onAuthStateChanged will handle the redirect
        } else if (!window.location.pathname.endsWith("user_login.html")) {
            window.location.href = "user_login.html"; // Fallback redirect
        }
        return null;
      }
    }

    async function secureFetch(url, options = {}) {
      const token = await getAuthToken();
      if (!token) {
        // getAuthToken handles redirection if token cannot be obtained.
        // Throw an error to ensure promise chains are rejected and calling function can handle it.
        throw new Error("Authentication token unavailable. User might be logged out or session expired.");
      }
      
      const headers = { ...options.headers };
      headers["Authorization"] = `Bearer ${token}`;

      if (options.body && !(options.body instanceof FormData) && (options.method === 'POST' || options.method === 'PUT' || options.method === 'PATCH')) {
        headers["Content-Type"] = "application/json";
      }

      try {
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401 || response.status === 403) {
            console.error(`User Page: Authorization error (${response.status}) for ${url}.`);
            window.showNotification("Authorization error. Your session may have expired. Please log in again.", "error", 5000);
            if (firebaseAuth) await firebaseAuth.signOut().catch(e => console.error("Sign out after auth error failed", e));
            // onAuthStateChanged will handle redirect eventually
            throw new Error(`Authorization failed (${response.status})`); // Propagate error
        }
        return response; // Return the whole response object
      } catch (networkError) {
          // This catches actual network failures (e.g., server down, DNS issues, CORS if not preflighted)
          // And also errors thrown from the 401/403 block above
          console.error("User Page: Network or Auth error during secureFetch:", networkError);
          if (!networkError.message.includes("Authorization failed")) { // Avoid double notification for auth errors
            window.showNotification(`Network Error: ${networkError.message}. Check connection or server status.`, "error", 7000);
          }
          throw networkError; // Re-throw to be caught by calling function
      }
    }
    // --- End Authentication & Authorization ---

    // --- Initial Data Loading (Parallel) ---
    async function fetchRoles() {
      try {
        const response = await secureFetch(`${BASE_API_URL}/api/auth`, { // USE DYNAMIC URL
          method: "POST", 
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({
            detail: `Roles/Auth verification failed (Status: ${response.status})`,
          }));
          throw new Error(errorData.detail);
        }
        const userData = await response.json();
        // IMPORTANT: Ensure your backend's POST /api/auth (when called by an already Firebase-authed user)
        // returns `isUser: true` or `isAdmin: true` if they should access this page.
        if (!userData || (userData.isUser !== true && userData.isAdmin !== true)) {
            console.warn("User Page: User does not have sufficient privileges according to backend verification. Signing out.");
            window.showNotification("Access Denied. You do not have sufficient privileges for this portal.", "error", 7000);
            if (firebaseAuth) await firebaseAuth.signOut().catch(e => console.error("Sign out after privilege check failed", e));
            // onAuthStateChanged will redirect
            throw new Error("Insufficient privileges determined by backend.");
        }
        currentUserRoles = userData.roles || []; 
        console.log("User Page: User roles fetched/verified:", currentUserRoles);
        return userData; // Return userData for further checks if needed
      } catch (error) {
        console.error("User Page: Error in fetchRoles:", error.message);
        // If fetchRoles fails (e.g. token invalid, user not authorized by backend), sign out.
        if (firebaseAuth) await firebaseAuth.signOut().catch(e => console.error("Sign out after fetchRoles error failed", e));
        throw error; // Re-throw to be caught by loadInitialDataConcurrently
      }
    }

    async function fetchTreeDataOnly() {
      if (loadingPlaceholder && !isSearchViewActive) {
        loadingPlaceholder.innerHTML =
          '<p class="p-4 text-lg text-[var(--text-secondary)]">Loading knowledge base structure...</p>';
        loadingPlaceholder.style.display = "flex";
      }

      try {
        const res = await secureFetch(`${BASE_API_URL}/api/tree`); // USE DYNAMIC URL
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Failed to load knowledge base (HTTP ${res.status}): ${errorText || 'Server error'}`);
        }
        const data = await res.json();
        if (!Array.isArray(data)) {
          console.error("User Page: Fetched tree data is not an array:", data);
          throw new Error("Received invalid tree structure from server.");
        }
        fullTreeData = data;
        console.log("User Page: Full tree data fetched:", fullTreeData);
      } catch (error) {
        console.error("User Page: Failed to fetch full tree:", error);
        fullTreeData = [];
        throw error; 
      }
    }

    async function loadInitialDataConcurrently() {
      if (loadingPlaceholder) {
        loadingPlaceholder.innerHTML =
          '<p class="p-4 text-lg text-[var(--text-secondary)]">Initializing knowledge base...</p>';
        loadingPlaceholder.style.display = "flex";
      }
      isSearchViewActive = false;

      try {
        // Fetch roles first to ensure user is authorized for the app before fetching tree
        await fetchRoles(); 
        await fetchTreeDataOnly();
        navigateToFolder(null); 
      } catch (error) {
        console.error("User Page: Error during initial data load sequence:", error);
        if(window.showNotification) window.showNotification( // Check if showNotification is defined
            `Could not load page data: ${error.message || "Unknown error"}. Please try logging in again.`,
            "error",
            10000 // Longer duration for critical errors
        );
        if (folderContentContainer) { // Check if element exists
            folderContentContainer.innerHTML = `<p class="text-[var(--text-red-accent)] p-4 text-center">Critical error loading page data. <br>Details: ${error.message}. <br>Please try refreshing. If the issue persists, you might need to log in again or contact support.</p>`;
        }
        // If fetchRoles failed due to auth, user would have been signed out and redirected by onAuthStateChanged eventually.
      } finally {
        if (loadingPlaceholder) loadingPlaceholder.style.display = "none";
      }
    }
    // --- End Initial Data Loading ---

    // --- Permissions ---
    // (Your canPerformAction, canAddContentToNode, canDeleteNode, canEditArtifactsInNode functions)
    // These should be mostly fine if currentUserRoles is populated correctly.
    function canPerformAction(nodeId, allowedRoles) {
      if (nodeId === null || typeof nodeId === "undefined") {
         // Example: Allow if user has a global ADMIN role for root actions
         // const isGlobalAdmin = currentUserRoles.some(r => r.nodeId === null && r.role === 'ADMIN');
         // return isGlobalAdmin && allowedRoles.includes('ADMIN');
         return false; // For now, explicit node roles needed for actions via this func
      }
      const roleEntry = currentUserRoles.find(
        (r) => String(r.nodeId) === String(nodeId)
      );
      return !!(roleEntry && allowedRoles.includes(roleEntry.role));
    }
    function canAddContentToNode(nodeId) {
      return canPerformAction(String(nodeId), ["ADMIN", "EDITOR"]);
    }
    function canDeleteNode(nodeId) {
      return canPerformAction(String(nodeId), ["ADMIN"]);
    }
    function canEditArtifactsInNode(parentNodeId) {
      return canPerformAction(String(parentNodeId), ["ADMIN", "EDITOR"]);
    }
    // --- End Permissions ---

    // --- Navigation and Rendering ---
    // (Your findNodeInTree, buildPathSegmentsRecursive, renderBreadcrumbs, 
    //  navigateToFolder, renderFolderContents functions)
    // Ensure they use global fullTreeData and currentUserRoles, and BASE_API_URL where needed.
    // (Keeping your existing functions as they were mostly UI logic)
    function findNodeInTree(nodeId, nodesToSearch = fullTreeData) {
      if (nodeId === null || typeof nodeId === "undefined" || nodeId === "null") { // Handle string "null" too
        return {
          id: null, name: "Knowledge Base", children: nodesToSearch, artifacts: [], type: "ROOT",
        };
      }
      for (const node of nodesToSearch) {
        if (String(node.id) === String(nodeId)) return node;
        if (node.children && Array.isArray(node.children)) {
          const found = findNodeInTree(nodeId, node.children);
          if (found) return found;
        }
      }
      return null;
    }

    function buildPathSegmentsRecursive(targetNodeId, nodesToSearch, currentStack) {
      for (const node of nodesToSearch) {
        const nodePathSegment = { id: node.id, name: node.name };
        if (String(node.id) === String(targetNodeId)) {
          return [...currentStack, nodePathSegment];
        }
        if (node.children && Array.isArray(node.children)) {
          const foundPath = buildPathSegmentsRecursive(targetNodeId, node.children, [...currentStack, nodePathSegment]);
          if (foundPath) return foundPath;
        }
      }
      return null;
    }

    function renderBreadcrumbs() {
      if(!breadcrumbContainer) return;
      breadcrumbContainer.innerHTML = "";
      if (!currentPath || currentPath.length === 0) {
        currentPath = [{ id: null, name: "Knowledge Base" }];
      }
      currentPath.forEach((segment, index) => {
        const segEl = document.createElement("span");
        if (index < currentPath.length - 1) {
          const link = document.createElement("a");
          link.textContent = segment.name;
          link.href = "#";
          link.classList.add("breadcrumb-item");
          link.onclick = (e) => {
            e.preventDefault();
            if (!isSearchViewActive) navigateToFolder(segment.id);
            else {
              isSearchViewActive = false;
              if(searchInputElement) searchInputElement.value = "";
              navigateToFolder(segment.id);
            }
          };
          segEl.appendChild(link);
          breadcrumbContainer.appendChild(segEl);

          const separator = document.createElement("span");
          separator.classList.add("breadcrumb-separator");
          separator.innerHTML = "&gt;";
          breadcrumbContainer.appendChild(separator);
        } else {
          segEl.textContent = segment.name;
          segEl.classList.add("breadcrumb-current");
          breadcrumbContainer.appendChild(segEl);
        }
      });
    }
    
    function navigateToFolder(nodeId) {
        currentViewNodeId = (nodeId === undefined || nodeId === null || nodeId === "null") ? null : String(nodeId);

        if (!isSearchViewActive && searchInputElement) searchInputElement.value = "";

        let newPath;
        if (currentViewNodeId === null) {
            newPath = [{ id: null, name: "Knowledge Base" }];
        } else {
            const pathSegments = buildPathSegmentsRecursive(currentViewNodeId, fullTreeData, []);
            if (pathSegments && pathSegments.length > 0) { // Ensure pathSegments are found
                newPath = [{ id: null, name: "Knowledge Base" }, ...pathSegments];
            } else {
                console.warn(`User Page: Node ID ${currentViewNodeId} not found for path. Navigating to root.`);
                newPath = [{ id: null, name: "Knowledge Base" }];
                currentViewNodeId = null; 
            }
        }
        currentPath = newPath;

        renderBreadcrumbs();
        if (!isSearchViewActive) {
            renderFolderContents();
        }

        const currentFolderObject = currentPath[currentPath.length - 1];
        if(currentFolderNameEl) currentFolderNameEl.textContent = currentFolderObject ? currentFolderObject.name : "Knowledge Base";
        
        if (backButton) {
            if (currentPath.length > 1 && !isSearchViewActive) { 
                backButton.style.display = "inline-flex"; 
                backButton.onclick = () => {
                    if (currentPath.length > 1) { 
                        const parentSegment = currentPath[currentPath.length - 2];
                        navigateToFolder(parentSegment.id);
                    }
                };
            } else {
                backButton.style.display = "none";
            }
        }

        if (addItemToFolderBtn) {
            // Ensure currentViewNodeId is treated as a string for canAddContentToNode if it expects string
            const nodeIdForPermissionCheck = currentViewNodeId === null ? null : String(currentViewNodeId);
            if (nodeIdForPermissionCheck !== null && canAddContentToNode(nodeIdForPermissionCheck) && !isSearchViewActive) {
                addItemToFolderBtn.style.display = "inline-flex";
                addItemToFolderBtn.onclick = () => toggleAddItemForm(true);
            } else {
                addItemToFolderBtn.style.display = "none";
                toggleAddItemForm(false); 
            }
        }
    }

    function renderFolderContents() {
    if (!folderContentContainer) return;
    folderContentContainer.innerHTML = "";
    // PartnerBU readme is handled by navigateToFolder now

    const nodeToDisplay = findNodeInTree(currentViewNodeId, fullTreeData);

    if (loadingPlaceholder) loadingPlaceholder.style.display = 'flex';

    if (!nodeToDisplay) {
        folderContentContainer.innerHTML =
            '<p class="p-4 text-[var(--text-tertiary)] text-center">Folder not found or you may not have access to it.</p>';
        if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
        return;
    }

    const itemsToShow = [];
    if (nodeToDisplay.children && Array.isArray(nodeToDisplay.children)) {
        itemsToShow.push(...nodeToDisplay.children.map(c => ({ ...c, itemType: 'folder', parentIdActual: String(nodeToDisplay.id === null ? 'null' : nodeToDisplay.id) })));
    }
    if (nodeToDisplay.artifacts && Array.isArray(nodeToDisplay.artifacts)) {
        itemsToShow.push(...nodeToDisplay.artifacts.map(a => ({ ...a, itemType: 'artifact', parentIdActual: String(nodeToDisplay.id === null ? 'null' : nodeToDisplay.id) })));
    }

    itemsToShow.sort(customSortItems); // APPLY THE NEW SORTING FUNCTION

    const allArtifacts = itemsToShow.length > 0 && itemsToShow.every(item => item.itemType === 'artifact');
    if (allArtifacts) {
        folderContentContainer.classList.add('list-view-only'); // Use this class for CSS to set display: block;
        folderContentContainer.style.display = "block"; // Or force here
    } else {
        folderContentContainer.classList.remove('list-view-only');
        folderContentContainer.style.display = "grid"; // Reset to grid if folders are present
    }

    if (itemsToShow.length === 0) {
        folderContentContainer.innerHTML = // No += needed here, it's the only content
            '<p class="p-4 text-lg text-[var(--text-tertiary)] text-center">This folder is empty.</p>';
    } else {
        itemsToShow.forEach(item => {
            const itemName = escapeJSString(item.name || item.title);
            const parentIdForPerms = String(item.parentIdActual === null || item.parentIdActual === 'null' ? null : item.parentIdActual);

            if (item.itemType === 'folder') {
                const card = document.createElement("div");
                card.classList.add("item-card"); // Folders remain as cards
                card.dataset.itemId = item.id;
                card.dataset.itemType = item.itemType;

                const iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>`;
                let actionsDivContent = "";
                if (canDeleteNode(String(item.id)) && String(item.id) !== "null" && parentIdForPerms !== "null") {
                    actionsDivContent += `<button title="Delete folder" class="action-icon-btn delete" onclick="event.stopPropagation(); deleteNode('${String(item.id)}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                }

                card.innerHTML = `
                    <div>
                        <div class="item-card-icon-wrapper"><span class="item-card-icon text-[var(--text-yellow-accent)]"><span class="math-inline">\{iconSVG\}</span\></div\>
                          <h3 class="item-card-name">{itemName}</h3>
<p class="item-card-type">Folder</p>
</div>
${actionsDivContent ? <div class="item-card-actions">${actionsDivContent}</div> : ""}
`;
card.onclick = () => navigateToFolder(item.id);
folderContentContainer.appendChild(card);
} else { // item.itemType === 'artifact' - RENDER AS LIST ITEM
                const listItem = document.createElement("div");
                listItem.classList.add("artifact-list-item");
                listItem.dataset.itemId = String(item.id);

                const fileIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>`;
                let artifactActionsHtml = "";
                if (canEditArtifactsInNode(parentIdForPerms)) {
                    artifactActionsHtml += `<button title="Delete file" class="action-icon-btn delete" onclick="event.stopPropagation(); deleteArtifact('<span class="math-inline">\{String\(item\.id\)\}', '</span>{parentIdForPerms}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                }
                // Button to open the modal
                artifactActionsHtml += `<button title="View details in modal" class="action-icon-btn" onclick="event.stopPropagation(); showArtifactDetailsModal('<span class="math-inline">\{escapeJSString\(item\.title\)\}', '</span>{escapeJSString(item.description)}', '${escapeJSString(item.link)}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg></button>`;

                let processedLink = item.link || "#";
                if (processedLink && !processedLink.startsWith("http://") && !processedLink.startsWith("https://") && processedLink !== "#") {
                    processedLink = `https://${processedLink}`;
                }
                const linkTarget = (processedLink === "#" || !item.link) ? "" : "target='_blank'";
                const linkRel = (processedLink === "#" || !item.link) ? "" : "rel='noopener noreferrer'";


                listItem.innerHTML = `
    <div class="artifact-header">
        <span class="artifact-icon">${fileIconSVG}</span>   Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©: Removed extra span and corrected variable
        <span class="artifact-title">${itemName}</span> Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©: Added $
        <div class="artifact-actions">${artifactActionsHtml}</div> <span class="artifact-dropdown-arrow">â–¼</span> Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©: Added $, ensured space
    </div>
    <div class="artifact-description" style="display:none;"> Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©: Ensured space
        <p>${item.description ? escapeJSString(item.description).replace(/\n/g, '<br>') : '<em>No description provided.</em>'}</p> Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©: Added $
        ${(item.link && item.link !== "#") ? `<a href="${processedLink}" ${linkTarget} ${linkRel} class="artifact-link submit-button primary" onclick="event.stopPropagation();">Go to Resource <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>` : ''}
    </div>
`;
                          const header = listItem.querySelector('.artifact-header');
                                          const descriptionDiv = listItem.querySelector('.artifact-description');
                                          const arrow = listItem.querySelector('.artifact-dropdown-arrow');

                                          header.addEventListener('click', (e) => {
                                              // Prevent toggle if a button within actions was clicked OR the link itself
                                              if (e.target.closest('.action-icon-btn') || e.target.closest('a.artifact-link')) {
                                                  return;
                                              }
                                              const isHidden = descriptionDiv.style.display === 'none';
                                              descriptionDiv.style.display = isHidden ? 'block' : 'none';
                                              arrow.classList.toggle('expanded', isHidden);
                                          });
                                          folderContentContainer.appendChild(listItem);
                                      }
                                  });
                              }
                              if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                          }
    // --- End Navigation and Rendering ---

    // --- Inline Add Item Form Logic ---
    // (Your toggleAddItemForm, populateAddItemForm, toggleAddItemFileOptions, toggleAddItemLinkOrUpload functions)
    // Ensure submitAddItemForm uses BASE_API_URL for its fetch calls.
    function toggleAddItemForm(show) {
      if (show && currentViewNodeId !== null && String(currentViewNodeId) !== "null") { // Prevent adding to root "null" node
        populateAddItemForm();
        if(addItemFormContainer) addItemFormContainer.style.display = "block";
        if(document.getElementById("addItemName")) document.getElementById("addItemName").focus();
      } else {
        if(addItemFormContainer) addItemFormContainer.style.display = "none";
      }
    }
    function populateAddItemForm() {
      const parentId = currentViewNodeId; 
      if (parentId === null || String(parentId) === "null") { // Explicitly check for null or string "null"
        if(addItemFormContainer) addItemFormContainer.innerHTML = '<p class="text-[var(--text-tertiary)]">Adding items to the main Knowledge Base root is not supported here. Please select or create a folder.</p>';
        return;
      }
      const currentFolder = findNodeInTree(String(parentId), fullTreeData); // Ensure parentId is string for findNode
      const currentFolderName = currentFolder ? currentFolder.name : "Selected Folder";

      if(addItemFormContainer) addItemFormContainer.innerHTML = `
            <h3 class="text-xl font-semibold mb-4 text-[var(--text-primary)]">Add to '${escapeJSString(currentFolderName)}'</h3>
            <form onsubmit="event.preventDefault(); submitAddItemForm(this.querySelector('button[type=submit]'))">
                <input type="hidden" id="addItemParentId" value="${parentId}">
                <div class="mb-4"><label for="addItemName" class="label-text">Name (Folder/File)</label><input type="text" id="addItemName" class="input-field text-sm" required></div>
                <div class="mb-4"><label for="addItemType" class="label-text">Type</label><select id="addItemType" class="input-field text-sm" onchange="toggleAddItemFileOptions()"><option value="SUBFOLDER">Subfolder</option><option value="FILE">File</option></select></div>
                <div class="mb-4"><label for="addItemDescription" class="label-text">Description (Optional)</label><textarea id="addItemDescription" class="input-field text-sm" rows="2"></textarea></div>
                <div id="addItemFileMethodOptions" style="display:none;" class="mt-2 mb-4">
                    <div><label for="addItemFileSource" class="label-text text-xs">File Source:</label><select id="addItemFileSource" class="input-field text-xs py-1" onchange="toggleAddItemLinkOrUpload()"><option value="link">Enter Link</option><option value="upload">Upload File</option></select></div>
                    <div id="addItemLinkInputContainer" class="mt-2"><input type="url" placeholder="Link (e.g., https://...)" id="addItemLink" class="input-field text-sm"></div>
                    <div id="addItemUploadInputContainer" style="display:none;" class="mt-2"><input type="file" id="addItemFileUpload" class="input-field text-sm p-2"></div>
                </div>
                <div class="mt-6 flex items-center gap-3">
                    <button type="submit" class="submit-button primary">
                        <span class="button-text">Add Item</span>
                    </button>
                    <button type="button" class="submit-button secondary" onclick="toggleAddItemForm(false)">
                        <span class="button-text">Cancel</span>
                    </button>
                </div>
            </form>`;
      toggleAddItemFileOptions();
    }
    function toggleAddItemFileOptions() {
      const typeSelect = document.getElementById("addItemType");
      const fileMethodOptionsDiv = document.getElementById("addItemFileMethodOptions");
      if (!typeSelect || !fileMethodOptionsDiv) return;

      if (typeSelect.value === "FILE") {
        fileMethodOptionsDiv.style.display = "block";
        const fileSourceSelect = document.getElementById("addItemFileSource");
        if(fileSourceSelect) fileSourceSelect.value = "link";
        toggleAddItemLinkOrUpload();
      } else {
        fileMethodOptionsDiv.style.display = "none";
      }
    }
    function toggleAddItemLinkOrUpload() {
      const fileSourceSelect = document.getElementById("addItemFileSource");
      const linkContainer = document.getElementById("addItemLinkInputContainer");
      const uploadContainer = document.getElementById("addItemUploadInputContainer");
      if (!fileSourceSelect || !linkContainer || !uploadContainer) return;
      
      const fileSource = fileSourceSelect.value;
      linkContainer.style.display = fileSource === "link" ? "block" : "none";
      uploadContainer.style.display = fileSource === "upload" ? "block" : "none";
      if (fileSource === 'link' && document.getElementById('addItemFileUpload')) document.getElementById('addItemFileUpload').value = '';
      if (fileSource === 'upload' && document.getElementById('addItemLink')) document.getElementById('addItemLink').value = '';
    }

    async function submitAddItemForm(buttonElement) {
      const parentIdValue = document.getElementById("addItemParentId").value;
      const parentId = (parentIdValue === "null" || parentIdValue === null || parentIdValue === "") ? null : parseInt(parentIdValue); // Ensure parentId is null if it's the root or empty string

      const name = document.getElementById("addItemName").value.trim();
      const type = document.getElementById("addItemType").value; // SUBFOLDER or FILE
      const description = document.getElementById("addItemDescription").value.trim();

      const originalButtonText = buttonElement.querySelector(".button-text")?.textContent || buttonElement.textContent;
      window.setButtonLoading(buttonElement, true, originalButtonText);

      if (!name) {
        window.showNotification("Name is required.", "error");
        window.setButtonLoading(buttonElement, false, originalButtonText);
        document.getElementById("addItemName")?.focus();
        return;
      }
      if (parentId === null) { 
          window.showNotification("Cannot add item: A valid parent folder must be selected.", "error");
          window.setButtonLoading(buttonElement, false, originalButtonText);
          return;
      }

      try {
        let response;
        let endpoint;
        let options = { method: "POST" };
        let bodyPayload;

        if (type === "FILE") {
          const fileSource = document.getElementById("addItemFileSource").value;
          let commonPayload = { title: name, description, nodeId: parentId };

          if (fileSource === "link") {
            const link = document.getElementById("addItemLink").value.trim();
            if (!link || !link.startsWith("http")) throw new Error("A valid Link (starting with http/https) is required for file type 'link'.");
            commonPayload.link = link;
            endpoint = `${BASE_API_URL}/api/artifacts`; // USE DYNAMIC URL
            bodyPayload = JSON.stringify(commonPayload);
            options.body = bodyPayload;
          } else { // upload
            const fileInput = document.getElementById("addItemFileUpload");
            const file = fileInput.files[0];
            if (!file) throw new Error("Please select a file to upload.");
            const formData = new FormData();
            formData.append("file", file);
            formData.append("title", name);
            formData.append("description", description);
            formData.append("nodeId", String(parentId));
            endpoint = `${BASE_API_URL}/api/upload`; // USE DYNAMIC URL
            options.body = formData; // No Content-Type needed for FormData
          }
        } else { // SUBFOLDER (backend treats as FOLDER)
          bodyPayload = JSON.stringify({ name, type: "FOLDER", parentId: parentId, description });
          endpoint = `${BASE_API_URL}/api/nodes`; // USE DYNAMIC URL
          options.body = bodyPayload;
        }
        
        response = await secureFetch(endpoint, options);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ detail: `Request failed with status ${response.status}. ${response.statusText}` }));
          throw new Error(errorData.detail || `Failed to add item (Status: ${response.status})`);
        }
        window.showNotification("Item added successfully! âœ…", "success");
        toggleAddItemForm(false); 
        const formElement = document.getElementById("addItemName")?.form;
        if(formElement) formElement.reset();
        toggleAddItemFileOptions(); // Reset file options after form reset
        await fetchTreeDataOnly(); 
        navigateToFolder(currentViewNodeId); 
      } catch (error) {
        console.error("User Page: Error submitting add item form:", error);
        window.showNotification(`Error: ${error.message}`, "error", 5000); // Longer display for submission errors
      } finally {
        window.setButtonLoading(buttonElement, false, originalButtonText);
      }
    }
    // --- End Inline Add Item Form Logic ---

    // --- CRUD Operations (Delete) ---
    // (Your deleteNode and deleteArtifact functions - ensure they use BASE_API_URL)
     async function deleteNode(nodeId) {
        if (!confirm("Are you sure you want to delete this folder and all its contents? This action cannot be undone.")) return;
        try {
            const response = await secureFetch(`${BASE_API_URL}/api/nodes/${nodeId}`, { method: "DELETE" });
            if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: response.statusText }));
            throw new Error(errorData.detail || "Failed to delete folder.");
            }
            window.showNotification("Folder deleted successfully. âœ…", "success");
            
            let parentToNavigateTo = null; // Default to root if path logic fails
            // Find the parent of the deleted node in the current path
            const pathIndex = currentPath.findIndex(p => String(p.id) === String(nodeId));
            if (pathIndex > 0) { // If deleted node was in path and not the root "Knowledge Base" segment
                parentToNavigateTo = currentPath[pathIndex - 1].id;
            } else if (String(currentViewNodeId) === String(nodeId)) { // If deleting the folder currently being viewed
                 parentToNavigateTo = currentPath.length > 1 ? currentPath[currentPath.length - 2].id : null;
            } else { // If deleted node was a child of currentViewNodeId but not in path (e.g. deeper orphan)
                parentToNavigateTo = currentViewNodeId;
            }

            await fetchTreeDataOnly(); // Refresh tree data first
            navigateToFolder(parentToNavigateTo); // Then navigate

        } catch (error) {
            console.error("User Page: Error deleting node:", error);
            window.showNotification(`Error: ${error.message}`, "error");
        }
    }
    async function deleteArtifact(artifactId, parentNodeIdString) { // parentNodeIdString is string
        if (!confirm("Are you sure you want to delete this file? This action cannot be undone.")) return;
        try {
            const response = await secureFetch(`${BASE_API_URL}/api/artifacts/${artifactId}`, { method: "DELETE" });
            if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: response.statusText }));
            throw new Error(errorData.detail || "Failed to delete file.");
            }
            window.showNotification("File deleted successfully. âœ…", "success");
            await fetchTreeDataOnly();
            // currentViewNodeId should be the parentNodeId if we are deleting an artifact from the current view
            navigateToFolder(currentViewNodeId); 
        } catch (error) {
            console.error("User Page: Error deleting artifact:", error);
            window.showNotification(`Error: ${error.message}`, "error");
        }
    }
    // --- End CRUD Operations ---

    // --- Modals & UI Toggles ---
    // (Your showArtifactDetailsModal, closeArtifactDetailsModal, Theme Toggle, User Menu Dropdown logic)
    // Make sure these are generally fine and don't have hardcoded URLs if any.
     function showArtifactDetailsModal(title, description, link) {
      const modal = document.getElementById("artifact-details-modal");
      if (!modal) return;
      const titleEl = document.getElementById("artifact-modal-title");
      const descEl = document.getElementById("artifact-details-modal-description");
      const linkEl = document.getElementById("artifact-modal-link");

      if(titleEl) titleEl.textContent = title || "Artifact Details";
      if(descEl) descEl.innerHTML = description ? escapeJSString(description).replace(/\n/g, '<br>') : "<em>No description provided.</em>";
      
      let processedLink = link || "#";
      if (processedLink && !processedLink.startsWith("http://") && !processedLink.startsWith("https://") && processedLink !== "#") {
        processedLink = `https://${processedLink}`;
      }
      if(linkEl) linkEl.href = processedLink;

      if (linkEl) {
        if (!link || link === "#") {
            linkEl.classList.add("opacity-50", "cursor-not-allowed");
            linkEl.removeAttribute("target");
            linkEl.onclick = (e) => e.preventDefault();
            linkEl.title = "No link provided";
        } else {
            linkEl.classList.remove("opacity-50", "cursor-not-allowed");
            linkEl.setAttribute("target", "_blank");
            linkEl.onclick = null; 
            linkEl.title = `Go to: ${processedLink}`;
        }
      }
      modal.classList.add("active");
    }
    function closeArtifactDetailsModal() {
      const modal = document.getElementById("artifact-details-modal");
      if (modal) modal.classList.remove("active");
    }

    // Theme Toggle
    const themeToggleButton = document.getElementById("theme-toggle-button");
    const sunIconHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
    const moonIconHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
    
    const USER_PAGE_LIGHT_MODE_LOGO = "https://niveussolutions.com/wp-content/uploads/2025/02/Niveus-ntt-data.png"; // Your black text logo
    const USER_PAGE_DARK_MODE_LOGO = "https://gitlab.niveussolutions.com/uploads/-/system/appearance/header_logo/1/Nivues_log.png"; // Your white text logo

    // Get a reference to the logo image element
    const userPageLogoElement = document.getElementById('user-page-logo');

    function applyTheme(theme) {
    if (!userPageLogoElement) return; // Add a check to ensure the logo element exists

    if (theme === "light") {
        document.body.classList.add("light-theme");
        if(themeToggleButton) themeToggleButton.innerHTML = moonIconHTML;
        userPageLogoElement.src = USER_PAGE_LIGHT_MODE_LOGO; // Set light mode logo
        localStorage.setItem("userPageTheme", "light"); // Use distinct localStorage key
    } else {
        document.body.classList.remove("light-theme");
        if(themeToggleButton) themeToggleButton.innerHTML = sunIconHTML;
        userPageLogoElement.src = USER_PAGE_DARK_MODE_LOGO; // Set dark mode logo
        localStorage.setItem("userPageTheme", "dark"); // Use distinct localStorage key
    }
}
    if(themeToggleButton) {
        themeToggleButton.addEventListener("click", () => {
            applyTheme(document.body.classList.contains("light-theme") ? "dark" : "light");
        });
        applyTheme(localStorage.getItem("userPageTheme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "dark"));
    }

    // User Menu Dropdown
    if (userMenuButton && userDropdownMenu) {
        userMenuButton.addEventListener("click", (event) => {
            event.stopPropagation();
            const isExpanded = userMenuButton.getAttribute("aria-expanded") === "true";
            userMenuButton.setAttribute("aria-expanded", String(!isExpanded));
            userDropdownMenu.classList.toggle("hidden");
        });
        document.addEventListener("click", (event) => {
            if (userDropdownMenu && !userDropdownMenu.classList.contains("hidden") &&
                userMenuButton && !userMenuButton.contains(event.target) && 
                !userDropdownMenu.contains(event.target)) {
                userDropdownMenu.classList.add("hidden");
                userMenuButton.setAttribute("aria-expanded", "false");
            }
        });
    }
    if (logoutButtonDropdown && firebaseAuth) { 
        logoutButtonDropdown.addEventListener("click", async () => {
            try {
                await firebaseAuth.signOut();
                sessionStorage.removeItem("userToken"); // Consistent token name
                window.showNotification("Logged out successfully.", "success");
                // onAuthStateChanged will redirect
            } catch (error) {
                console.error("User Page: Error signing out:", error);
                window.showNotification("Logout failed. Please try again.", "error");
            }
        });
    }
    // --- End Modals & UI Toggles ---

    // --- Search Functionality ---
    // (Your highlightText, debouncedPerformGlobalSearch, performGlobalSearch, renderSearchResults functions)
    // Ensure they use global fullTreeData and escapeJSString.
    let searchResults = [];

    function highlightText(text, query) {
        if (!query || typeof text !== 'string') return escapeJSString(text || "");
        const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${safeQuery})`, "gi");
        return escapeJSString(text).replace(regex, '<span class="highlight">$1</span>');
    }

    const debouncedPerformGlobalSearch = debounce(performGlobalSearch, 350);

    if(searchInputElement) {
        searchInputElement.addEventListener("input", (e) => {
            debouncedPerformGlobalSearch(e.target.value);
        });
    }

    function performGlobalSearch(term) {
        searchResults = [];
        const searchTerm = term.trim().toLowerCase();
        if (!searchTerm) {
            isSearchViewActive = false;
            navigateToFolder(currentViewNodeId); 
            return;
        }
        isSearchViewActive = true;

        function recurseSearch(nodes, pathStack) {
            for (const node of nodes) {
                if (!node) continue; 
                const currentItemPath = [...pathStack, { id: node.id, name: node.name }];

                if (node.name && node.name.toLowerCase().includes(searchTerm)) {
                    searchResults.push({ item: node, path: currentItemPath, itemType: "folder", matchSource: "name" });
                }

                if (node.artifacts && Array.isArray(node.artifacts)) {
                    for (const artifact of node.artifacts) {
                        if (!artifact) continue;
                        let artifactAlreadyAdded = searchResults.some(sr => sr.item.id === artifact.id && sr.itemType === 'artifact');
                        
                        if (artifact.title && artifact.title.toLowerCase().includes(searchTerm) && !artifactAlreadyAdded) {
                            searchResults.push({ item: artifact, path: currentItemPath, itemType: "artifact", matchSource: "title" });
                            artifactAlreadyAdded = true; 
                        }
                        if (artifact.description && artifact.description.toLowerCase().includes(searchTerm) && !artifactAlreadyAdded) {
                            searchResults.push({ item: artifact, path: currentItemPath, itemType: "artifact", matchSource: "description" });
                        }
                    }
                }
                if (node.children && Array.isArray(node.children)) {
                    recurseSearch(node.children, currentItemPath);
                }
            }
        }
        recurseSearch(fullTreeData, [{ id: null, name: "Knowledge Base" }]); 
        renderSearchResults(searchResults, searchTerm);
    }

    function renderSearchResults(results, searchTerm = "") {
        if(!folderContentContainer) return;
        displayPartnerBuReadme(false);
        folderContentContainer.innerHTML = "";
        toggleAddItemForm(false); 
        if(backButton) backButton.style.display = 'none';
        if(addItemToFolderBtn) addItemToFolderBtn.style.display = 'none';

        const resultsTitle = results.length > 0 ? `Search Results for "${escapeJSString(searchTerm)}"` : `No Results for "${escapeJSString(searchTerm)}"`;
        if(currentFolderNameEl) currentFolderNameEl.textContent = resultsTitle;
        if(breadcrumbContainer) breadcrumbContainer.innerHTML = `<span class="breadcrumb-current">Search Results</span>`;

        if (results.length === 0) {
            folderContentContainer.innerHTML = `<p class="p-4 text-lg text-[var(--text-tertiary)] text-center">No items found matching your search.</p>`;
            return;
        }

        results.forEach(result => {
            const card = document.createElement("div");
            card.classList.add("search-result-card"); 

            const itemName = result.item.name || result.item.title;
            const itemTypeDisplay = result.itemType.charAt(0).toUpperCase() + result.itemType.slice(1);
            let displayPathString = result.path.map(p => p.name).join(" > ");

            const iconClass = result.itemType === "folder" ? "text-[var(--text-yellow-accent)]" : "text-[var(--text-blue-accent)]";
            const iconSVG = result.itemType === "folder"
                ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>`;

            let descriptionHTML = "";
            if (result.itemType === "artifact" && result.item.description) {
                descriptionHTML = `<p class="search-result-description">${highlightText(result.item.description, searchTerm)}</p>`;
            } else if (result.itemType === "artifact" && !result.item.description) {
                descriptionHTML = `<p class="search-result-description"><em>No description provided.</em></p>`;
            }
            
            card.innerHTML = `
                <div> 
                    <div class="item-card-icon-wrapper"><span class="search-result-icon ${iconClass}">${iconSVG}</span></div>
                    <h3 class="search-result-name">${highlightText(itemName, searchTerm)}</h3>
                    <p class="search-result-type">${itemTypeDisplay}</p>
                    ${descriptionHTML} 
                    <p class="search-result-path">In: ${escapeJSString(displayPathString)}</p>
                </div>
            `;
            card.onclick = () => {
                isSearchViewActive = false; 
                if(searchInputElement) searchInputElement.value = ""; 
                if (result.itemType === "folder") {
                    navigateToFolder(result.item.id);
                } else { 
                    const parentFolderId = result.path.length > 1 ? result.path[result.path.length - 1].id : null;
                    navigateToFolder(parentFolderId); 
                    setTimeout(() => {
                        showArtifactDetailsModal(result.item.title, result.item.description, result.item.link);
                    }, 100); 
                }
            };
            folderContentContainer.appendChild(card);
        });
    }
    // --- End Search Functionality ---

    // --- Global Event Listeners (Escape key) ---
    document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
            const artifactModal = document.getElementById("artifact-details-modal");
            if (artifactModal?.classList.contains("active")) { // Optional chaining
                closeArtifactDetailsModal();
            }
            if (addItemFormContainer?.style.display === "block") { // Optional chaining
                toggleAddItemForm(false);
            }
            if (userDropdownMenu && !userDropdownMenu.classList.contains("hidden")) {
                userDropdownMenu.classList.add("hidden");
                if(userMenuButton) userMenuButton.setAttribute("aria-expanded", "false");
            }
        }
    });
    // --- End Global Event Listeners ---
  </script>
</body>
</html>
