<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Niveus Knowledge Base</title> <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <style>
      :root {
        /* Dark Theme (Enhanced) */
        --bg-primary: #111827; /* Slightly richer dark blue-gray */
        --bg-card: #1f2937; /* Darker blue-gray for cards */
        --bg-card-hover: #374151; /* Slightly lighter for hover */
        --bg-input: #374151;
        --bg-input-readonly: #4b5563;
        --bg-button-primary: #3b82f6; /* Vibrant blue for primary actions */
        --bg-button-primary-hover: #2563eb;
        --bg-button-destructive: #ef4444;
        --bg-button-destructive-hover: #dc2626;
        --bg-button-secondary: #4b5563; /* Gray for secondary */
        --bg-button-secondary-hover: #6b7280;
        --bg-action-icon-hover: #4b5563;
        --bg-inline-form: #1f2937;
        --bg-modal-overlay: rgba(0, 0, 0, 0.75);
        --bg-modal-content: #1f2937;
        --bg-toast-success: #10b981; /* Emerald */
        --bg-toast-error: #f43f5e; /* Rose */
        --bg-dropdown-menu: var(--bg-card);
        --bg-breadcrumb: #1f2937; /* Consistent with cards */
        --bg-breadcrumb-hover: #374151;
        --bg-action-button: #2a2c31; 
        --bg-action-button-hover: #34373c;


        --text-primary: #f3f4f6; /* Lighter gray for primary text */
        --text-secondary: #9ca3af; /* Medium gray */
        --text-tertiary: #6b7280; /* Darker gray */
        --text-placeholder: #9ca3af;
        --text-button-primary: #ffffff;
        --text-button-destructive: #ffffff;
        --text-button-secondary: #f3f4f6;
        --text-card-header: #e5e7eb;
        --text-link: #60a5fa;
        --text-link-hover: #93c5fd;
        --text-action-icon: #9ca3af;
        --text-action-icon-hover: #e5e7eb;
        --text-green-accent: #34d399; /* Emerald for icons */
        --text-red-accent: #f87171; /* Red for icons */
        --text-yellow-accent: #f59e0b; /* Amber for folder icons */
        --text-blue-accent: #60a5fa; /* Blue for file icons */
        --text-toast: #ffffff;
        --text-dropdown-item-hover: var(--text-link-hover);
        --text-search-path: #6b7280;


        --border-primary: #374151; /* Softer border */
        --border-card: #4b5563;
        --border-input: #4b5563;
        --border-input-focus: var(--text-link);
        --border-button-primary: transparent; 
        --border-button-primary-hover: transparent;
        --border-button-destructive: transparent;
        --border-button-secondary: var(--border-primary);
        --border-preview: #4b5563;
        --border-toast-success: #059669;
        --border-toast-error: #e11d48;
        --border-dropdown-menu: var(--border-primary);
        --border-breadcrumb: var(--border-primary);

        --shadow-card-item: 0 4px 6px -1px rgba(0, 0, 0, 0.3),
          0 2px 4px -2px rgba(0, 0, 0, 0.3);
        --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.3),
          0 4px 6px -4px rgba(0, 0, 0, 0.3);
        --shadow-input-focus: 0 0 0 2px var(--text-link); 
        --shadow-modal: 0 20px 25px -5px rgba(0, 0, 0, 0.4),
          0 8px 10px -6px rgba(0, 0, 0, 0.4);
        --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.5);
        --shadow-dropdown: 0 10px 15px -3px rgba(0, 0, 0, 0.2),
          0 4px 6px -2px rgba(0, 0, 0, 0.1);

        --scrollbar-thumb: #4b5563;
        --scrollbar-track: #1f2937;
      }

      .light-theme {
        --bg-primary: #f9fafb; 
        --bg-card: #ffffff;
        --bg-card-hover: #f3f4f6; 
        --bg-input: #ffffff;
        --bg-input-readonly: #e5e7eb;
        --bg-button-primary: #2563eb; 
        --bg-button-primary-hover: #1d4ed8;
        --bg-button-destructive: #ef4444;
        --bg-button-destructive-hover: #dc2626;
        --bg-button-secondary: #e5e7eb; 
        --bg-button-secondary-hover: #d1d5db;
        --bg-action-icon-hover: #e5e7eb;
        --bg-inline-form: #f9fafb;
        --bg-modal-overlay: rgba(17,24,39,0.6); 
        --bg-modal-content: #ffffff;
        --bg-toast-success: #ecfdf5; 
        --bg-toast-error: #fff1f2; 
        --bg-dropdown-menu: var(--bg-card);
        --bg-breadcrumb: #ffffff;
        --bg-breadcrumb-hover: #f3f4f6;
        --bg-action-button: #f3f4f6; 
        --bg-action-button-hover: #e5e7eb;
        --bg-file-item-hover: #f3f4f6;
        --bg-search-result-item-hover: #e5e7eb;

        --text-primary: #1f2937; 
        --text-secondary: #4b5563; 
        --text-tertiary: #6b7280;  
        --text-placeholder: #9ca3af;
        --text-button-primary: #ffffff;
        --text-button-destructive: #ffffff;
        --text-button-secondary: #374151; 
        --text-card-header: #111827;
        --text-link: #2563eb;
        --text-link-hover: #1d4ed8;
        --text-action-icon: #6b7280;
        --text-action-icon-hover: #1f2937;
        --text-green-accent: #059669;
        --text-red-accent: #e11d48;
        --text-yellow-accent: #f59e0b;
        --text-blue-accent: #3b82f6;
        --text-toast: #065f46; 
        --text-toast-error: #c2410c; 
        --text-dropdown-item-hover: var(--text-link);
        --text-search-path: #6b7280;


        --border-primary: #e5e7eb; 
        --border-card: #e5e7eb;
        --border-input: #d1d5db;
        --border-input-focus: var(--text-link);
        --border-button-secondary: #d1d5db;
        --border-preview: #e5e7eb;
        --border-toast-success: #6ee7b7;
        --border-toast-error: #fda4af;
        --border-dropdown-menu: var(--border-primary);
        --border-breadcrumb: var(--border-primary);

        --shadow-card-item: 0 4px 6px -1px rgba(0, 0, 0, 0.07),
          0 2px 4px -2px rgba(0, 0, 0, 0.07);
        --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.07),
          0 4px 6px -4px rgba(0, 0, 0, 0.07);
        --shadow-input-focus: 0 0 0 2px var(--text-link);
        --shadow-modal: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 8px 10px -6px rgba(0, 0, 0, 0.1);
        --shadow-toast: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-dropdown: 0 10px 15px -3px rgba(0, 0, 0, 0.05),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);

        --scrollbar-thumb: #d1d5db;
        --scrollbar-track: #f3f4f6;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      #folder-content-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 1.25rem; 
      }

      .item-card,
      .search-result-card { /* Applying similar base style */
        background-color: var(--bg-card);
        border: 1px solid var(--border-card);
        border-radius: 0.75rem; 
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease-in-out; 
        box-shadow: var(--shadow-card-item);
        cursor: pointer;
        position: relative; 
        min-height: 160px; 
      }
      .item-card:hover,
      .search-result-card:hover {
        transform: translateY(-5px) scale(1.02); 
        box-shadow: var(--shadow-card); /* Use main card shadow for hover */
        border-color: var(--text-link); 
      }

      .item-card-icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 3rem; 
        height: 3rem; 
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        background-color: color-mix(in srgb, var(--bg-primary) 50%, var(--bg-card) 50%); /* Subtle mix */
      }
      .item-card-icon svg,
      .search-result-icon svg {
        width: 1.75rem; 
        height: 1.75rem;
      }

      .item-card-name,
      .search-result-name {
        font-weight: 600; 
        font-size: 1rem; /* Adjusted for consistency */
        color: var(--text-primary);
        margin-bottom: 0.375rem;
        word-break: break-word;
        line-height: 1.4;
      }
      .item-card-name .highlight,
      .search-result-name .highlight { /* For search term highlighting */
        background-color: var(--text-yellow-accent);
        color: var(--bg-card) !important; 
        padding: 1px 3px;
        border-radius: 3px;
        font-weight: 700;
      }
      .light-theme .item-card-name .highlight,
      .light-theme .search-result-name .highlight {
        background-color: #fef9c3; 
        color: #713f12 !important; 
      }

      .item-card-type, /* This was for ID before, now generic type */
      .search-result-type {
        font-size: 0.75rem; /* Smaller */
        color: var(--text-tertiary);
        margin-bottom: 0.5rem; /* Adjusted spacing */
      }
      .search-result-path {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem; /* Added top margin */
        word-break: break-word;
        line-height: 1.3;
      }
      
      #breadcrumb-container {
        background-color: transparent; 
        padding: 0.5rem 0; 
        margin-bottom: 1.5rem;
        border: none; 
        border-bottom: 1px solid var(--border-primary); 
        border-radius: 0;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
      }
      .breadcrumb-item {
        color: var(--text-link);
        text-decoration: none;
        cursor: pointer;
        font-size: 0.875rem; /* Slightly smaller */
        transition: color 0.2s ease;
        padding: 0.25rem 0.375rem; /* Adjusted padding */
        border-radius: 0.25rem;
      }
      .breadcrumb-item:hover {
        text-decoration: underline;
        background-color: var(--bg-breadcrumb-hover);
        color: var(--text-link-hover);
      }
      .breadcrumb-separator {
        margin: 0 0.5rem; /* Slightly less margin */
        color: var(--text-tertiary);
        font-size: 0.75rem;
      }
      .breadcrumb-current {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 0.875rem;
        padding: 0.25rem 0.375rem;
      }
      
      .input-field,
      textarea.input-field {
        background-color: var(--bg-input);
        color: var(--text-primary);
        border: 1px solid var(--border-input);
        border-radius: 0.5rem; 
        padding: 0.6rem 0.9rem; 
      }
      textarea.input-field { min-height: 70px; }
      .input-field::placeholder,
      textarea.input-field::placeholder { color: var(--text-placeholder); opacity: 0.8; }
      .input-field:focus,
      textarea.input-field:focus {
        border-color: var(--border-input-focus);
        outline: none;
        box-shadow: var(--shadow-input-focus);
        background-color: var(--bg-card);
      } 

      .label-text {
        display: block; font-size: 0.875rem; font-weight: 500;
        color: var(--text-secondary); margin-bottom: 0.375rem;
      }
      
      #back-button, #theme-toggle-button, #logout-button { /* Grouped common button styles */
        background-color: var(--bg-action-button);
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 0.375rem; 
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        display: inline-flex; /* Ensure icons and text align */
        align-items: center;
        justify-content: center;
      }
      #back-button:hover, #theme-toggle-button:hover, #logout-button:hover {
        background-color: var(--bg-action-button-hover);
        color: var(--text-primary);
        border-color: var(--border-card);
      }
      #logout-button { /* Specific padding for text button */
        padding: 0.5rem 0.875rem; /* Adjusted for text */
        font-size: 0.8rem;
        font-weight: 500;
      }
      #theme-toggle-button, #back-button { /* Specific padding for icon buttons */
        padding: 0.5rem;
      }


      .custom-scrollbar { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); }
      .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--scrollbar-thumb) 80%, #fff 20%); }
      #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 0.75rem; } 
      .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: var(--text-toast); box-shadow: var(--shadow-toast); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; display: flex; align-items: center; gap: 0.75rem; border-width: 1px; border-style: solid; min-width: 280px; max-width: 400px;}
      .toast.show { opacity: 1; transform: translateY(0); }
      .toast.success { background-color: var(--bg-toast-success); border-color: var(--border-toast-success); color: var(--text-toast, #ffffff); }
      .light-theme .toast.success { color: var(--text-toast, #065f46); }
      .toast.error { background-color: var(--bg-toast-error); border-color: var(--border-toast-error); color: var(--text-toast, #ffffff); }
      .light-theme .toast.error { color: var(--text-toast-error, #c2410c); }
      .toast-icon { flex-shrink: 0; }
      .loading-placeholder { text-align: center; padding: 2rem; font-style: italic; color: var(--text-secondary); }
    </style>
  </head>
  <body class="custom-scrollbar">
    <div id="toast-container"></div>
    <div class="container mx-auto p-4 md:px-6 lg:px-8 py-6 md:py-8 min-h-screen flex flex-col">
      <header class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4 pb-6 border-b border-[var(--border-primary)]">
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight text-[var(--text-card-header)] flex items-center">
          <img src="https://niveussolutions.com/wp-content/uploads/2025/02/Niveus-ntt-data.png" alt="Niveus Logo" class="h-7 sm:h-8 mr-3"> 
          Niveus Knowledge Base
        </h1>
        <div class="flex items-center gap-3 w-full sm:w-auto max-w-md">
            <input
              type="search"
              id="user-search-input"
              class="input-field flex-grow text-sm"
              placeholder="Search KB..."
            />
            <button
                id="theme-toggle-button"
                class="flex-shrink-0"
                title="Toggle Theme"
            ></button>
            <button
                id="logout-button"
                class="flex-shrink-0"
                title="Logout"
            >
                Logout
            </button>
        </div>
      </header>

      <nav aria-label="Breadcrumb" class="mb-6 min-h-[36px] flex items-center gap-2"> 
        <button id="back-button" title="Go Back" class="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </button>
        <ol id="breadcrumb-container" class="flex items-center space-x-1 text-sm text-[var(--text-secondary)] flex-wrap">
          </ol>
      </nav>

      <main id="content-container" class="flex-grow">
        <div class="loading-placeholder">Loading initial content...</div>
      </main>

      <footer class="text-center py-8 mt-auto text-xs text-[var(--text-tertiary)]">
        &copy; <span id="current-year"></span> Niveus Solutions. All rights reserved.
      </footer>
    </div>

    <script>
      // const BASE = "http://localhost:3000"; // Old BASE URL for local Next.js backend
      const BASE = ""; // New BASE URL for relative API paths on Vercel or when served by vercel dev from root
    
      let fullTreeData = [];
      let currentPath = [{ id: null, name: "Home" }]; 
      let currentViewNodeId = null; 
      let isCurrentlySearching = false;
    
      // DOM Elements - get them early, but check if they exist before use
      const contentContainer = document.getElementById("content-container");
      const breadcrumbContainer = document.getElementById("breadcrumb-container");
      const searchInput = document.getElementById("user-search-input");
      const backButton = document.getElementById("back-button");
      const logoutButton = document.getElementById("logout-button"); 
      const themeToggleButton = document.getElementById("theme-toggle-button");
      const currentYearSpan = document.getElementById("current-year");
      const toastContainer = document.getElementById("toast-container");
    
    
      if (currentYearSpan) {
        currentYearSpan.textContent = new Date().getFullYear();
      } else {
        console.warn("Element with ID 'current-year' not found in the DOM when script executed.");
      }
    
      // --- Firebase Client SDK Setup ---
      const firebaseConfig = {
        apiKey: "AIzaSyCbHWUEzqGjzeanOiMG0Z5Lb4wIjWWEMUQ", // Your actual Firebase project API key
        authDomain: "docnest-f85e2.firebaseapp.com",
        projectId: "docnest-f85e2",
        storageBucket: "docnest-f85e2.appspot.com",
        messagingSenderId: "102395439437",
        appId: "1:102395439437:web:84e6676388b5d54395af04",
        measurementId: "G-YRMBR8BVSE",
      };
      let firebaseAppUser;
      let firebaseAuthUser; 
    
      // Check if firebase object exists (SDK loaded)
      if (typeof firebase !== 'undefined') {
        try {
          if (!firebase.apps.length) {
              firebaseAppUser = firebase.initializeApp(firebaseConfig);
          } else {
              firebaseAppUser = firebase.app(); 
          }
          firebaseAuthUser = firebase.auth(firebaseAppUser);
          console.log("Firebase for User Page initialized successfully.");
        } catch (e) {
          console.error("Error initializing Firebase on User Page:", e);
          if(window.showNotification) window.showNotification("Auth service error. Please check configuration.", "error", 7000);
          else console.error("showNotification function not available for Firebase init error.");
        }
      } else {
        console.error("Firebase SDK not loaded. Please ensure firebase-app-compat.js and firebase-auth-compat.js are included in your HTML head.");
        // Defer alert until DOM is likely ready or use a more robust notification if showNotification isn't defined yet
        document.addEventListener('DOMContentLoaded', () => {
            if(window.showNotification) window.showNotification("Critical Error: Firebase SDK not loaded.", "error", 10000);
            else alert("Critical Error: Firebase SDK not loaded. Check console.");
        });
      }
    
    
      // --- Theme Toggle ---
      const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
      const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
      
      function applyTheme(theme) {
        if (themeToggleButton) {
            if (theme === "light") { 
                document.body.classList.add("light-theme"); 
                themeToggleButton.innerHTML = moonIcon; 
                localStorage.setItem("theme", "light"); 
            } else { 
                document.body.classList.remove("light-theme"); 
                themeToggleButton.innerHTML = sunIcon; 
                localStorage.setItem("theme", "dark"); 
            }
        }
      }
      if (themeToggleButton) {
        themeToggleButton.addEventListener("click", () => applyTheme(document.body.classList.contains("light-theme") ? "dark" : "light"));
      }
      applyTheme(localStorage.getItem("theme") || "light"); 
    
      // --- Toast Notifications ---
      window.showNotification = function (message, type = "success", duration = 3000) {
        if (!toastContainer) {
            console.warn("Toast container not found for notification:", message);
            return;
        }
        const toast = document.createElement("div"); toast.classList.add("toast", type);
        let iconHtml = "";
        if (type === "success") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
        else if (type === "error") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.293-10.293a1 1 0 00-1.414 0L9 8.586l-.293-.293a1 1 0 10-1.414 1.414L7.586 10l-.293.293a1 1 0 101.414 1.414L9 11.414l.293.293a1 1 0 001.414-1.414L10.414 10l.293-.293a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>`;
        else if (type === "info") iconHtml = `<svg class="toast-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        toast.innerHTML = `${iconHtml}<span>${escapeHTML(message)}</span>`;
        toastContainer.appendChild(toast); toast.offsetHeight; toast.classList.add("show");
        setTimeout(() => { toast.classList.remove("show"); setTimeout(() => { toast.remove(); }, 300); }, duration);
      };
    
      function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
      }
    
      async function getAuthTokenForUserPage() {
          if (!firebaseAuthUser || !firebaseAuthUser.currentUser) {
              console.warn("[UserPage] No current Firebase user for token request.");
              const sessionToken = sessionStorage.getItem("user_token"); 
              if (sessionToken) return sessionToken;
              if(window.showNotification) window.showNotification("Session may have expired. Please log in again.", "error");
              if (!window.location.pathname.endsWith("user_login.html")) {
                 window.location.href = "user_login.html";
              }
              return null;
          }
          try {
              const token = await firebaseAuthUser.currentUser.getIdToken(true);
              sessionStorage.setItem("user_token", token);
              return token;
          } catch (error) {
              console.error("[UserPage] Error getting ID token:", error);
              if(window.showNotification) window.showNotification("Could not refresh session. Please log in again.", "error");
              if (!window.location.pathname.endsWith("user_login.html")) {
                 window.location.href = "user_login.html";
              }
              return null;
          }
      }
    
      async function secureUserFetch(url, options = {}) {
          const token = await getAuthTokenForUserPage();
          const headers = { ...options.headers };
          if (token) {
              headers["Authorization"] = `Bearer ${token}`;
          } else {
              console.warn(`[secureUserFetch] No token available for request to ${url}. Request might fail or be unauthenticated.`);
          }
          if (!(options.body instanceof FormData) && options.method && options.method.toUpperCase() !== 'GET' && options.method.toUpperCase() !== 'OPTIONS' ) {
              headers["Content-Type"] = "application/json";
          }
          console.log(`[secureUserFetch] Making ${options.method || 'GET'} request to ${url} with token: ${token ? 'present' : 'absent'}`);
          return fetch(url, { ...options, headers });
      }
    
      function updateBackButtonVisibility() { 
        if (backButton) {
            if (!isCurrentlySearching && currentPath.length > 1) {
                backButton.classList.remove("hidden");
            } else {
                backButton.classList.add("hidden");
            }
        }
      }
    
      function renderBreadcrumbs() { 
        updateBackButtonVisibility();
        if (!breadcrumbContainer) return;
        if (isCurrentlySearching) { 
            breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Displaying search results for "${escapeHTML(searchInput ? searchInput.value : '')}"...</li>`;
            return;
        }
        breadcrumbContainer.innerHTML = "";
        currentPath.forEach((crumb, index) => {
          const li = document.createElement("li");
          const isLast = index === currentPath.length - 1;
          const a = document.createElement("a");
          a.href = "#";
          a.textContent = escapeHTML(crumb.name);
          a.classList.add("breadcrumb-item", "text-sm");
          if (isLast) { 
            a.classList.add("font-medium", "text-[var(--text-primary)]", "cursor-default");
          } else {
            a.classList.add("cursor-pointer", "hover:underline");
            a.style.color = "var(--text-link)";
            a.onclick = (e) => {
              e.preventDefault();
              currentPath = currentPath.slice(0, index + 1);
              currentViewNodeId = crumb.id;
              displayNodes(currentViewNodeId);
            };
          }
          li.appendChild(a);
          if (!isLast) {
            const separator = document.createElement("span");
            separator.textContent = "/";
            separator.classList.add("mx-1.5", "text-[var(--text-tertiary)]");
            li.appendChild(separator);
          }
          breadcrumbContainer.appendChild(li);
        });
      }
      
      function findNodeAndPathById(nodes, targetId, currentTrail = [{id: null, name: "Home"}]) { 
        if (!Array.isArray(nodes)) return null;
        for (const node of nodes) {
            const newTrail = [...currentTrail, { id: node.id, name: node.name }];
            if (String(node.id) === String(targetId)) { 
                return { node, path: newTrail };
            }
            if (node.children && Array.isArray(node.children)) {
                const foundInChildren = findNodeAndPathById(node.children, targetId, newTrail);
                if (foundInChildren) return foundInChildren;
            }
        }
        return null;
      }
      
      function findNodeById(nodes, id) { 
        if (id === null) return { id: null, name: "Home", children: fullTreeData || [], artifacts: [] }; 
        if (!Array.isArray(nodes)) return null;
        for (const node of nodes) {
          if (String(node.id) === String(id)) return node;
          if (node.children && Array.isArray(node.children)) {
            const found = findNodeById(node.children, id);
            if (found) return found;
          }
        }
        return null;
      }
      
      function createCard(item) { 
        const card = document.createElement("div");
        card.className = "item-card p-4 sm:p-5 flex flex-col h-full"; 
        card.title = item.description || `Explore ${escapeHTML(item.name)}`;
        card.onclick = () => {
          isCurrentlySearching = false; 
          if(searchInput) searchInput.value = ""; 
          
          const pathInfo = findNodeAndPathById(fullTreeData, item.id);
          if (pathInfo) {
            currentPath = pathInfo.path;
          } else { 
            if (!currentPath.find(p => String(p.id) === String(item.id))) {
                currentPath.push({ id: item.id, name: item.name });
            }
          }
          currentViewNodeId = item.id;
          displayNodes(item.id);
        };
        const icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 sm:h-10 sm:w-10 mb-3 text-[var(--text-tertiary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`;
        const title = `<h3 class="text-md sm:text-lg font-medium text-[var(--text-card-header)] mb-1 truncate">${escapeHTML(item.name)}</h3>`;
        const description = item.description ? `<p class="text-xs text-[var(--text-secondary)] flex-grow line-clamp-2 sm:line-clamp-3">${escapeHTML(item.description)}</p>` : '<div class="flex-grow"></div>';
        const idLabel = item.id !== undefined 
                        ? `<span class="text-xs font-medium text-[var(--text-tertiary)] mt-2 inline-block">ID: ${escapeHTML(String(item.id))}</span>` 
                        : ''; 
        card.innerHTML = icon + title + description + idLabel;
        return card;
      }
    
      function displayNodes(nodeId) { 
        if (!contentContainer) {
            console.error("Content container not found in displayNodes.");
            return;
        }
        contentContainer.innerHTML = '<div class="loading-placeholder">Loading content...</div>';
        if (!isCurrentlySearching) { 
            renderBreadcrumbs();
        } else {
            if (breadcrumbContainer) breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Displaying search results for "${escapeHTML(searchInput ? searchInput.value : '')}"...</li>`;
            updateBackButtonVisibility(); 
        }
    
        let itemsToDisplay = [];
        if (nodeId === null) {
          currentViewNodeId = null; 
          itemsToDisplay = Array.isArray(fullTreeData) ? fullTreeData.filter(node => node.type === 'VERTICAL' || !node.parentId) : [];
        } else {
          const currentNode = findNodeById(fullTreeData, nodeId);
          currentViewNodeId = nodeId; 
          if (currentNode) {
            itemsToDisplay = [...(Array.isArray(currentNode.children) ? currentNode.children : []) , ...(Array.isArray(currentNode.artifacts) ? currentNode.artifacts : [])];
          } else {
            contentContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)]">Folder not found.</p>';
            if (!isCurrentlySearching) renderBreadcrumbs();
            return;
          }
        }
    
        if (itemsToDisplay.length === 0 && !isCurrentlySearching) { 
          contentContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-8">This folder is empty.</p>';
          if (!isCurrentlySearching) renderBreadcrumbs();
          return;
        }
    
        contentContainer.innerHTML = ""; 
        const grid = document.createElement("div");
        grid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-5"; 
        
        const filesListContainer = document.createElement('div'); 
        const filesList = document.createElement('ul');
        filesList.className = "space-y-2"; 
        filesListContainer.appendChild(filesList);
    
        let hasFiles = false;
        let hasFolders = false;
    
        itemsToDisplay.forEach(item => {
          if (item.type === 'FOLDER' || item.type === 'SUBFOLDER' || item.type === 'VERTICAL' || (item.children && Array.isArray(item.children))) {
            hasFolders = true;
            grid.appendChild(createCard(item));
          } else if (item.type === 'ARTIFACT' || item.link) {
            hasFiles = true;
            const listItem = document.createElement('li');
            listItem.className = "file-item flex items-center justify-between rounded-md"; 
            const fileInfo = document.createElement('div');
            fileInfo.className = "flex items-center overflow-hidden mr-2";
            fileInfo.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2.5 text-[var(--text-tertiary)] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
              <span class="text-sm text-[var(--text-primary)] truncate" title="${escapeHTML(item.title)}">${escapeHTML(item.title)}</span>
            `;
            
            const linkElement = document.createElement('a');
            let url = item.link || "#";
            if (url && url !== "#" && !url.toLowerCase().startsWith("http://") && !url.toLowerCase().startsWith("https://") && !url.startsWith("/")) {
                if (url.includes('.') && !url.includes(' ') && !url.startsWith('//')) {
                     url = `https://${url}`; 
                }
            }
            linkElement.href = url;
            if (item.link && url !== "#") linkElement.target = "_blank";
            linkElement.rel = "noopener noreferrer";
            linkElement.className = "text-xs ml-auto px-2.5 py-1 rounded hover:underline flex-shrink-0"; 
            linkElement.style.color = "var(--text-link)";
            linkElement.textContent = item.link ? "Open" : "No Link";
            if (!item.link || url === "#") linkElement.classList.add("opacity-50", "cursor-not-allowed");
            
            listItem.appendChild(fileInfo);
            listItem.appendChild(linkElement);
            filesList.appendChild(listItem);
          }
        });
        if (hasFolders) contentContainer.appendChild(grid);
        if (hasFiles) {
          if (hasFolders) {
            const separator = document.createElement('hr');
            separator.className = "my-6 sm:my-8 border-[var(--border-primary)] opacity-50"; 
            contentContainer.appendChild(separator);
          }
          const filesHeader = document.createElement('h3');
          filesHeader.className = "text-lg sm:text-xl font-medium text-[var(--text-card-header)] mb-3 sm:mb-4"; 
          filesHeader.textContent = "Files / Pages";
          contentContainer.appendChild(filesHeader);
          contentContainer.appendChild(filesListContainer); 
        }
      }
    
      // --- Search Functionality ---
      let searchDebounceTimer;
      if (searchInput) {
        searchInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                handleSearch(searchInput.value);
            }, 300);
        });
      }
    
      function handleSearch(term) { 
          const searchTerm = term.trim().toLowerCase();
          if (!searchTerm) {
              isCurrentlySearching = false;
              displayNodes(currentViewNodeId); 
              return;
          }
          isCurrentlySearching = true;
          if (breadcrumbContainer) breadcrumbContainer.innerHTML = `<li class="text-sm text-[var(--text-tertiary)] italic">Searching for "${escapeHTML(searchTerm)}"...</li>`;
          updateBackButtonVisibility(); 
          const matches = [];
          collectAllMatchingItems(fullTreeData, searchTerm, [], matches);
          displayDirectSearchResults(matches, searchTerm);
      }
    
      function collectAllMatchingItems(nodes, term, currentTrail, matches) { 
          if (!Array.isArray(nodes)) return;
          nodes.forEach(node => {
              const nodePathSegment = { id: node.id, name: node.name };
              const pathToNode = [...currentTrail, nodePathSegment];
              if (node.name && node.name.toLowerCase().includes(term)) {
                  matches.push({ item: node, path: pathToNode, type: 'folder' });
              }
              if (node.artifacts && Array.isArray(node.artifacts)) {
                  node.artifacts.forEach(artifact => {
                      if (artifact.title && artifact.title.toLowerCase().includes(term)) {
                          matches.push({ item: artifact, path: pathToNode, type: 'file' });
                      }
                  });
              }
              if (node.children && Array.isArray(node.children)) {
                  collectAllMatchingItems(node.children, term, pathToNode, matches);
              }
          });
      }
    
      function displayDirectSearchResults(matches, searchTerm) { 
          if (!contentContainer) return;
          contentContainer.innerHTML = ""; 
          if (matches.length === 0) {
              contentContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)] py-8">No items found matching "${escapeHTML(searchTerm)}".</p>`;
              return;
          }
          const resultsList = document.createElement('ul');
          resultsList.className = "space-y-0 bg-[var(--bg-card)] p-0 rounded-lg shadow-md overflow-hidden border border-[var(--border-card)]"; 
          matches.forEach(matchData => {
              const { item, path, type } = matchData;
              const listItem = document.createElement('li');
              listItem.className = "search-result-item flex items-center justify-between";
              const itemInfo = document.createElement('div');
              itemInfo.className = "flex items-center overflow-hidden mr-2 py-2.5 px-3"; 
              const iconType = type === 'folder' ? 
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2.5 text-[var(--text-tertiary)] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>` :
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2.5 text-[var(--text-tertiary)] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>`;
              const itemName = type === 'folder' ? item.name : item.title;
              const displayPathArray = [{name: "Home"}, ...path.map(p => ({name: p.name}))]; 
              if (type === 'file') {
                displayPathArray.pop(); 
                const parentNodeInPath = path[path.length -1];
                if (parentNodeInPath) { displayPathArray.push({name: parentNodeInPath.name}); }
                 displayPathArray.push({name: item.title});
              }
              itemInfo.innerHTML = `
                  ${iconType}
                  <div class="flex flex-col overflow-hidden">
                      <span class="text-sm font-medium text-[var(--text-primary)] truncate" title="${escapeHTML(itemName)}">${escapeHTML(itemName)}</span>
                      <span class="text-xs text-[var(--text-search-path)] truncate" title="Path: ${displayPathArray.map(p=>p.name).join(' / ')}">
                          ${displayPathArray.map(p=>p.name).join(' / ')}
                      </span>
                  </div>
              `;
              listItem.appendChild(itemInfo);
              listItem.onclick = () => {
                  if(searchInput) searchInput.value = ""; 
                  isCurrentlySearching = false; 
                  if (type === 'folder') {
                      currentPath = [{id: null, name: "Home"}, ...path]; 
                      currentViewNodeId = item.id;
                      displayNodes(item.id);
                  } else { 
                      currentPath = [{id: null, name: "Home"}, ...path]; 
                      currentViewNodeId = path[path.length-1].id; 
                      displayNodes(currentViewNodeId);
                  }
              };
              resultsList.appendChild(listItem);
          });
          contentContainer.appendChild(resultsList);
      }
    
      // --- Back Button Logic ---
      function handleBackButton() { 
        if (!isCurrentlySearching && currentPath.length > 1) {
            if(searchInput) searchInput.value = ""; 
            isCurrentlySearching = false;
            currentPath.pop();
            const previousCrumb = currentPath[currentPath.length - 1];
            currentViewNodeId = previousCrumb.id;
            displayNodes(currentViewNodeId);
        }
      }
      if (backButton) {
        backButton.addEventListener('click', handleBackButton);
      }
    
      // --- Logout Button Logic ---
      if (logoutButton) {
          logoutButton.addEventListener("click", async () => {
              if (firebaseAuthUser) {
                  try {
                      await firebaseAuthUser.signOut();
                      sessionStorage.removeItem("user_token"); 
                      if(window.showNotification) window.showNotification("You have been logged out.", "success");
                      window.location.href = "user_login.html"; 
                  } catch (error) {
                      console.error("Error signing out user:", error);
                      if(window.showNotification) window.showNotification("Logout failed. Please try again.", "error");
                  }
              }
          });
      }
    
      // --- Initial Load & Auth State Handling ---
      async function initializeUserView() { 
        if (contentContainer) contentContainer.innerHTML = '<div class="loading-placeholder">Loading initial content...</div>';
        else { console.error("Content container not found for user page."); return; }
    
        const tokenFromLogin = sessionStorage.getItem("user_token"); 
        if (!tokenFromLogin && firebaseAuthUser && !firebaseAuthUser.currentUser) {
            console.log("No user token found, redirecting to user login.");
            if (!window.location.pathname.endsWith("user_login.html")) {
                window.location.href = "user_login.html";
            }
            return; 
        }
        
        try {
          const res = await secureUserFetch(`${BASE}/api/tree`); 
          if (!res.ok) {
            const errorText = await res.text();
            let errorDetail = res.statusText;
            try { const errData = JSON.parse(errorText); errorDetail = errData.error || errData.message || errorDetail; } catch(e){}
            throw new Error(`HTTP error ${res.status}: ${errorDetail}`);
          }
          fullTreeData = await res.json();
          if (!Array.isArray(fullTreeData)) {
              console.error("Fetched tree data is not an array:", fullTreeData);
              fullTreeData = [];
              throw new Error("Invalid tree data format from server.");
          }
          currentViewNodeId = null;
          currentPath = [{ id: null, name: "Home" }];
          isCurrentlySearching = false;
          displayNodes(null); 
        } catch (error) {
          console.error("Failed to fetch initial tree data for user page:", error);
          if(contentContainer) contentContainer.innerHTML = `<p class="text-center text-[var(--text-red-accent)] p-4">Error loading knowledge base: ${error.message}. Please try again later.</p>`;
          if(window.showNotification) showNotification(`Error loading data: ${error.message}`, "error", 7000);
        }
      }
    
      if (firebaseAuthUser) {
          firebaseAuthUser.onAuthStateChanged(async (user) => {
              if (user) {
                  console.log("User Page: User is signed in -", user.email);
                  try {
                      const token = await user.getIdToken(true);
                      sessionStorage.setItem("user_token", token); 
                      console.log("User Page: Token refreshed/stored in session storage.");
                  } catch (tokenError) {
                      console.error("User Page: Error refreshing token on auth state change:", tokenError);
                  }
                  // Load data if not already loaded or if it's the first time this callback runs for the user
                  // Check if contentContainer exists and is empty or only has the placeholder
                  const contentIsEmptyOrLoading = !contentContainer || contentContainer.children.length === 0 || 
                                                (contentContainer.children.length === 1 && contentContainer.firstElementChild.classList.contains('loading-placeholder'));

                  if (fullTreeData.length === 0 || contentIsEmptyOrLoading) {
                      initializeUserView();
                  }
              } else {
                  console.log("User Page: No user signed in / session ended. Redirecting to login.");
                  sessionStorage.removeItem("user_token");
                  if (!window.location.pathname.endsWith("user_login.html")) {
                      window.location.href = "user_login.html";
                  }
              }
          });
      } else {
          console.warn("User Page: Firebase Auth not available. This might happen if SDK failed to load. Redirecting to login if not already there.");
          if (!window.location.pathname.endsWith("user_login.html")) {
              // setTimeout(() => { window.location.href = "user_login.html"; }, 200); 
          }
      }
    </script>
